// ===== FILE 1: manifest.json - Cáº­p nháº­t shortcuts má»›i =====
{
  "name": "Quáº£n LÃ½ TÃ i ChÃ­nh",
  "short_name": "TÃ i ChÃ­nh", 
  "description": "á»¨ng dá»¥ng quáº£n lÃ½ tÃ i chÃ­nh cÃ¡ nhÃ¢n",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "icons": [
    {
      "src": "./LogoFinance.png",
      "sizes": "192x192",
      "type": "image/png"
    }
  ],
  "shortcuts": [
    {
      "name": "ğŸ’° ThÃªm Thu Nháº­p",
      "short_name": "Thu",
      "description": "ThÃªm giao dá»‹ch thu nháº­p nhanh",
      "url": "/quick-add.html?action=income&source=shortcut",
      "icons": [
        {
          "src": "./LogoFinance.png",
          "sizes": "96x96"
        }
      ]
    },
    {
      "name": "ğŸ’¸ ThÃªm Chi TiÃªu", 
      "short_name": "Chi",
      "description": "ThÃªm giao dá»‹ch chi tiÃªu nhanh",
      "url": "/quick-add.html?action=expense&source=shortcut",
      "icons": [
        {
          "src": "./LogoFinance.png", 
          "sizes": "96x96"
        }
      ]
    },
    {
      "name": "â†”ï¸ Chuyá»ƒn Tiá»n",
      "short_name": "Chuyá»ƒn",
      "description": "Táº¡o giao dá»‹ch chuyá»ƒn tiá»n",
      "url": "/quick-add.html?action=transfer&source=shortcut", 
      "icons": [
        {
          "src": "./LogoFinance.png",
          "sizes": "96x96"
        }
      ]
    },
    {
      "name": "ğŸ“Š Xem Thá»‘ng KÃª",
      "short_name": "Stats", 
      "description": "Xem bÃ¡o cÃ¡o tÃ i chÃ­nh nhanh",
      "url": "/?tab=statistics&source=shortcut",
      "icons": [
        {
          "src": "./LogoFinance.png",
          "sizes": "96x96"
        }
      ]
    }
  ]
}

// ===== FILE 2: sw.js - Cáº­p nháº­t version =====
const APP_VERSION = '1.0.3'; // TÄ‚NG VERSION
const CACHE_NAME = `finance-app-v${APP_VERSION}`;

// ThÃªm manifest.json vÃ o cache Ä‘á»ƒ Ä‘áº£m báº£o shortcut Ä‘Æ°á»£c update
const urlsToCache = [
  '/',
  '/index.html',
  '/quick-add.html',
  '/styles.css',
  '/js/utils.js',
  '/js/app.js',
  '/js/categories.js',
  '/js/settings.js',
  '/js/transactions.js',
  '/js/history.js',
  '/js/statistics.js',
  '/LogoFinance.png',
  '/manifest.json' // QUAN TRá»ŒNG: Cache manifest má»›i
];

// ThÃªm logic xá»­ lÃ½ shortcut tracking
self.addEventListener('fetch', event => {
  const { request } = event;
  const url = new URL(request.url);

  // Skip non-GET requests
  if (request.method !== 'GET') return;
  if (url.origin !== location.origin) return;

  // ğŸ†• Track shortcut usage
  if (url.searchParams.get('source') === 'shortcut') {
    console.log('ğŸ“Š Shortcut used:', url.searchParams.get('action'));
    
    // Optional: Send analytics to your server
    // fetch('/api/analytics/shortcut', {
    //   method: 'POST',
    //   body: JSON.stringify({
    //     action: url.searchParams.get('action'),
    //     timestamp: Date.now()
    //   })
    // }).catch(() => {}); // Silent fail
  }

  // Rest of fetch handling...
  if (request.mode === 'navigate' || request.headers.get('accept').includes('text/html')) {
    event.respondWith(
      fetch(request)
        .then(response => {
          const responseToCache = response.clone();
          caches.open(CACHE_NAME).then(cache => {
            cache.put(request, responseToCache);
          });
          return response;
        })
        .catch(() => caches.match(request))
    );
    return;
  }

  // Cache first for assets
  event.respondWith(
    caches.match(request)
      .then(response => {
        if (response) return response;
        return fetch(request).then(response => {
          if (!response || response.status !== 200 || response.type !== 'basic') {
            return response;
          }
          const responseToCache = response.clone();
          caches.open(CACHE_NAME).then(cache => {
            cache.put(request, responseToCache);
          });
          return response;
        });
      })
  );
});

// ===== FILE 3: js/utils.js - Cáº­p nháº­t UpdateManager =====
Utils.UpdateManager = {
    currentVersion: '1.0.3', // SYNC Vá»šI SW.JS
    swRegistration: null,
    isUpdateAvailable: false,
    isRefreshing: false,

    // ... existing code ...

    /**
     * ğŸ†• Kiá»ƒm tra vÃ  update shortcut availability
     */
    async checkShortcutSupport() {
        try {
            if ('getInstalledRelatedApps' in navigator) {
                const relatedApps = await navigator.getInstalledRelatedApps();
                console.log('ğŸ“± Installed PWA apps:', relatedApps);
                
                // Check if shortcuts are supported
                if ('shortcuts' in navigator) {
                    console.log('âœ… Shortcuts supported');
                    return true;
                } else {
                    console.log('âŒ Shortcuts not supported');
                    return false;
                }
            }
        } catch (error) {
            console.log('âš ï¸ Could not check shortcut support:', error);
        }
        return false;
    },

    /**
     * ğŸ†• Force update manifest and shortcuts
     */
    async updateManifest() {
        try {
            // Force reload manifest
            const manifestResponse = await fetch('/manifest.json?v=' + Date.now());
            if (manifestResponse.ok) {
                console.log('âœ… Manifest updated');
                
                // Trigger SW update to cache new manifest
                if (this.swRegistration) {
                    await this.swRegistration.update();
                }
                
                Utils.UIUtils.showMessage('ğŸ“± Widget shortcuts Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t!', 'success');
                return true;
            }
        } catch (error) {
            console.error('âŒ Failed to update manifest:', error);
        }
        return false;
    }
};

// ===== FILE 4: quick-add.html - Enhanced shortcut handling =====
// ThÃªm vÃ o script section cá»§a quick-add.html:

// ğŸ†• Enhanced URL params handling vá»›i shortcut tracking
function handleURLParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action');
    const source = urlParams.get('source');
    
    console.log('ğŸ“± Quick-add opened:', { action, source });
    
    // Track shortcut usage
    if (source === 'shortcut') {
        trackShortcutUsage(action);
        
        // Show shortcut-specific welcome message
        showShortcutWelcome(action);
    }
    
    if (action) {
        const typeMap = {
            'income': 'Thu',
            'expense': 'Chi', 
            'transfer': 'Transfer'
        };
        
        if (typeMap[action]) {
            currentType = typeMap[action];
            
            // Update UI
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === currentType);
            });
            
            const categoryField = document.getElementById('category-field');
            if (currentType === 'Transfer') {
                categoryField.style.display = 'none';
                document.getElementById('quick-category').removeAttribute('required');
            }
            
            // Auto-focus amount for better UX
            setTimeout(() => {
                document.getElementById('quick-amount').focus();
            }, 500);
        }
    }
}

// ğŸ†• Track shortcut usage
function trackShortcutUsage(action) {
    try {
        // Save to localStorage for analytics
        const shortcutStats = JSON.parse(localStorage.getItem('shortcut_stats') || '{}');
        const today = new Date().toISOString().split('T')[0];
        
        if (!shortcutStats[today]) {
            shortcutStats[today] = {};
        }
        
        shortcutStats[today][action] = (shortcutStats[today][action] || 0) + 1;
        
        localStorage.setItem('shortcut_stats', JSON.stringify(shortcutStats));
        
        console.log('ğŸ“Š Shortcut tracked:', action, shortcutStats[today][action]);
    } catch (error) {
        console.error('Failed to track shortcut usage:', error);
    }
}

// ğŸ†• Show shortcut-specific welcome
function showShortcutWelcome(action) {
    const messages = {
        'income': 'ğŸ’° Sáºµn sÃ ng ghi nháº­n thu nháº­p!',
        'expense': 'ğŸ’¸ Nhanh chÃ³ng ghi láº¡i chi tiÃªu!',
        'transfer': 'â†”ï¸ Thá»±c hiá»‡n chuyá»ƒn tiá»n ngay!'
    };
    
    const message = messages[action] || 'ğŸ’° ThÃªm giao dá»‹ch nhanh!';
    
    // Update header
    const title = document.querySelector('.quick-title');
    if (title) {
        title.textContent = message;
    }
    
    // Show brief notification
    setTimeout(() => {
        if (window.navigator && window.navigator.vibrate) {
            window.navigator.vibrate(50); // Haptic feedback
        }
    }, 200);
}

// ===== FILE 5: index.html - Update manifest link =====
// Trong <head> section, cáº­p nháº­t:
<link rel="manifest" href="./manifest.json?v=1.0.3">

// VÃ  thÃªm cache busting cho SW:
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js?v=1.0.3')
            .then(function(registration) {
                console.log('âœ… SW registered:', registration.scope);
                
                // ğŸ†• Check for shortcut support
                if (window.FinancialApp && window.FinancialApp.updateManager) {
                    window.FinancialApp.updateManager.checkShortcutSupport();
                }
            })
            .catch(function(error) {
                console.log('âŒ SW registration failed:', error);
            });
    });
}
</script>

// ===== DEPLOYMENT CHECKLIST =====
/*
1. âœ… Update APP_VERSION trong sw.js (1.0.2 â†’ 1.0.3)
2. âœ… Update currentVersion trong utils.js 
3. âœ… Modify shortcuts trong manifest.json
4. âœ… Add cache busting (?v=1.0.3) trong HTML
5. âœ… Enhanced shortcut tracking trong quick-add.html
6. âœ… Test URL params hoáº¡t Ä‘á»™ng Ä‘Ãºng
7. âœ… Deploy toÃ n bá»™ lÃªn server
8. âœ… Test trÃªn real device (iOS + Android)
9. âœ… Verify auto-update notification
10. âœ… Test tá»«ng shortcut widget
*/