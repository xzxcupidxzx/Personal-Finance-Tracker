name: Sync App Version

on:
  push:
    branches: [ main, master ]
    paths:
      - 'js/version.js' # Chá»‰ cháº¡y khi version.js thay Ä‘á»•i

jobs:
  sync-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write # âœ… ThÃªm quyá»n write cho contents
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4 # âœ… Cáº­p nháº­t lÃªn v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0 # âœ… Fetch full history

    - name: Verify files exist
      run: |
        echo "ğŸ” Checking if required files exist..."
        
        if [ ! -f "js/version.js" ]; then
          echo "âŒ js/version.js not found!"
          exit 1
        fi
        
        # Bá» qua kiá»ƒm tra js/utils.js vÃ¬ chÃºng ta khÃ´ng sá»­a nÃ³ ná»¯a
        # if [ ! -f "js/utils.js" ]; then
        #   echo "âŒ js/utils.js not found!"
        #   exit 1
        # fi
        
        if [ ! -f "manifest.json" ]; then
          echo "âŒ manifest.json not found!"
          exit 1
        fi
        
        echo "âœ… All required files exist for version syncing (version.js, manifest.json)"

    - name: Extract and sync version
      run: |
        VERSION_FILE="js/version.js"
        # UTILS_FILE="js/utils.js" # KhÃ´ng cáº§n biáº¿n nÃ y ná»¯a
        MANIFEST_FILE="manifest.json"
        
        echo "ğŸ“‚ Working directory: $(pwd)"
        echo "ğŸ“‹ Files in js/:"
        ls -la js/ || echo "js/ directory not found"
        
        # Äá»c ná»™i dung file version.js
        echo "ğŸ“– Content of $VERSION_FILE:"
        cat "$VERSION_FILE"
        
        # TrÃ­ch xuáº¥t phiÃªn báº£n vá»›i nhiá»u pattern khÃ¡c nhau
        echo "ğŸ” Extracting version..."
        
        # Thá»­ pattern 1: const APP_VERSION = '1.2.3';
        NEW_VERSION=$(grep -E "const APP_VERSION = '[0-9]+\.[0-9]+\.[0-9]+'" "$VERSION_FILE" | sed -E "s/.*'([0-9]+\.[0-9]+\.[0-9]+)'.*/\1/" | head -1)
        
        # Náº¿u khÃ´ng tÃ¬m tháº¥y, thá»­ pattern 2: const APP_VERSION = "1.2.3";
        if [ -z "$NEW_VERSION" ]; then
          NEW_VERSION=$(grep -E 'const APP_VERSION = "[0-9]+\.[0-9]+\.[0-9]+"' "$VERSION_FILE" | sed -E 's/.*"([0-9]+\.[0-9]+\.[0-9]+)".*/\1/' | head -1)
        fi
        
        # Náº¿u váº«n khÃ´ng tÃ¬m tháº¥y, thá»­ pattern 3: APP_VERSION = '1.2.3'
        if [ -z "$NEW_VERSION" ]; then
          NEW_VERSION=$(grep -E "APP_VERSION = '[0-9]+\.[0-9]+\.[0-9]+'" "$VERSION_FILE" | sed -E "s/.*'([0-9]+\.[0-9]+\.[0-9]+)'.*/\1/" | head -1)
        fi
        
        if [ -z "$NEW_VERSION" ]; then
          echo "âŒ KhÃ´ng thá»ƒ trÃ­ch xuáº¥t version tá»« $VERSION_FILE"
          echo "ğŸ“‹ Ná»™i dung file:"
          cat "$VERSION_FILE"
          exit 1
        fi
        
        echo "âœ… Extracted version: $NEW_VERSION"
        
        # Backup manifest.json trÆ°á»›c khi thay Ä‘á»•i
        cp "$MANIFEST_FILE" "${MANIFEST_FILE}.backup"
        echo "ğŸ’¾ Backed up manifest.json"
        
        # Bá» qua viá»‡c cáº­p nháº­t utils.js
        echo "â„¹ï¸ Skipping update for js/utils.js as version is handled internally by the app logic."
        
        # Cáº­p nháº­t manifest.json
        echo "ğŸ”§ Updating $MANIFEST_FILE..."
        
        # Sá»­ dá»¥ng jq náº¿u cÃ³
        if command -v jq &> /dev/null; then
          jq ".version = \"$NEW_VERSION\"" "$MANIFEST_FILE" > "${MANIFEST_FILE}.tmp" && mv "${MANIFEST_FILE}.tmp" "$MANIFEST_FILE"
          echo "âœ… Updated manifest.json using jq"
        else
          # Fallback vá»›i sed
          sed -i -E "s/(\"version\":[ ]*\")[0-9]+\.[0-9]+\.[0-9]+(\")/\1$NEW_VERSION\2/" "$MANIFEST_FILE"
          echo "âœ… Updated manifest.json using sed"
        fi
        
        # Kiá»ƒm tra thay Ä‘á»•i manifest.json
        echo "ğŸ” Checking changes for manifest.json..."
        if ! diff "$MANIFEST_FILE" "${MANIFEST_FILE}.backup" > /dev/null 2>&1; then
          echo "âœ… manifest.json has been changed"
        else
          echo "â„¹ï¸ manifest.json unchanged"
        fi
        
        # LÆ°u version vÃ o environment
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # Kiá»ƒm tra git config
        echo "ğŸ“‹ Git config:"
        git config --get user.email
        git config --get user.name

    - name: Commit and push changes
      run: |
        echo "ğŸ“‹ Git status before adding files:"
        git status
        
        # Add chá»‰ manifest.json náº¿u nÃ³ thay Ä‘á»•i
        git add manifest.json
        
        echo "ğŸ“‹ Git status after adding files:"
        git status
        
        # Kiá»ƒm tra xem cÃ³ thay Ä‘á»•i khÃ´ng
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit for manifest.json"
          # Náº¿u khÃ´ng cÃ³ thay Ä‘á»•i nÃ o cáº£ (ká»ƒ cáº£ utils.js trÆ°á»›c Ä‘Ã³ náº¿u cÃ³), thÃ¬ cÃ³ thá»ƒ thoÃ¡t á»Ÿ Ä‘Ã¢y
          # Tuy nhiÃªn, vÃ¬ chÃºng ta chá»‰ add manifest.json, nÃªn Ä‘iá»u kiá»‡n nÃ y lÃ  Ä‘á»§
          exit 0
        fi
        
        # Commit vá»›i message rÃµ rÃ ng
        COMMIT_MSG="ğŸ”„ Auto-sync manifest.json version to ${{ env.NEW_VERSION }} from js/version.js
        
        - Updated manifest.json
        
        [skip ci]"
        
        git commit -m "$COMMIT_MSG"
        
        echo "âœ… Changes committed successfully"
        
        # Push vá»›i retry logic
        MAX_RETRIES=3
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "ğŸš€ Attempting to push... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
          
          if git push origin HEAD; then
            echo "âœ… Push successful!"
            break
          else
            echo "âŒ Push failed, retrying in 5 seconds..."
            sleep 5
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Push failed after $MAX_RETRIES attempts"
              exit 1
            fi
            
            # Pull latest changes trÆ°á»›c khi retry
            echo "ğŸ”„ Pulling latest changes..."
            git pull --rebase origin HEAD || true
          fi
        done

    - name: Cleanup on failure
      if: failure()
      run: |
        echo "ğŸ§¹ Cleaning up on failure..."
        
        # Restore backup manifest.json náº¿u cÃ³
        if [ -f "manifest.json.backup" ]; then
          mv "manifest.json.backup" "manifest.json"
          echo "â†©ï¸ Restored manifest.json from backup"
        fi
        
        # Reset git changes
        git reset --hard HEAD
        echo "ğŸ”„ Reset git changes"

    - name: Summary
      if: success()
      run: |
        echo "ğŸ‰ Version sync completed successfully for manifest.json!"
        echo "ğŸ“¦ New version: ${{ env.NEW_VERSION }}"
        echo "ğŸ“ Files updated:"
        echo "  - manifest.json"
        echo ""
        echo "ğŸ”— Commit: $(git rev-parse HEAD)"
