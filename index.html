<html lang="vi"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ Theo Dõi Tài Chính Cá Nhân</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="180x180" href="Logo Finance.png">
    <link rel="icon" type="image/png" sizes="192x192" href="Logo Finance.png">
    <link rel="icon" type="image/png" sizes="512x512" href="Logo Finance.png">
    <link rel="icon" type="image/png" sizes="32x32" href="Logo Finance.png">
    <link rel="icon" type="image/png" sizes="16x16" href="Logo Finance.png">
    <link rel="shortcut icon" href="Logo Finance.png" type="image/png">

    <link rel="stylesheet" href="Styles.css">

    <style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.16 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width: 640px){.container{max-width:640px}}@media (min-width: 768px){.container{max-width:768px}}@media (min-width: 1024px){.container{max-width:1024px}}@media (min-width: 1280px){.container{max-width:1280px}}@media (min-width: 1536px){.container{max-width:1536px}}.fixed{position:fixed}.bottom-0{bottom:0px}.left-0{left:0px}.right-0{right:0px}.z-50{z-index:50}.row-span-2{grid-row:span 2 / span 2}.my-3{margin-top:0.75rem;margin-bottom:0.75rem}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.mr-1{margin-right:0.25rem}.mr-2{margin-right:0.5rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.ml-2{margin-left:0.5rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.grid{display:grid}.h-11{height:2.75rem}.h-3{height:0.75rem}.w-24{width:6rem}.w-full{width:100%}.w-3{width:0.75rem}.flex-grow{flex-grow:1}.appearance-none{-webkit-appearance:none;appearance:none}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-6{gap:1.5rem}.gap-x-6{column-gap:1.5rem}.gap-y-3{row-gap:0.75rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded{border-radius:0.25rem}.rounded-md{border-radius:0.375rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.p-2{padding:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.text-center{text-align:center}.text-right{text-align:right}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.focus\:border-indigo-500:focus{--tw-border-opacity:1;border-color:rgb(99 102 241 / var(--tw-border-opacity, 1))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241 / var(--tw-ring-opacity, 1))}.focus\:ring-offset-2:focus{--tw-ring-offset-width:2px}@media (min-width: 640px){.sm\:text-sm{font-size:0.875rem;line-height:1.25rem}.sm\:text-xl{font-size:1.25rem;line-height:1.75rem}}@media (min-width: 768px){.md\:col-span-2{grid-column:span 2 / span 2}.md\:flex{display:flex}.md\:w-1\/2{width:50%}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:gap-6{gap:1.5rem}}@media (prefers-color-scheme: dark){.dark\:border-gray-600{--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1))}.dark\:border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.dark\:bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.dark\:bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.dark\:text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.dark\:text-gray-200{--tw-text-opacity:1;color:rgb(229 231 235 / var(--tw-text-opacity, 1))}.dark\:text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.dark\:text-green-400{--tw-text-opacity:1;color:rgb(74 222 128 / var(--tw-text-opacity, 1))}.dark\:text-red-400{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.dark\:text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}}</style></head>
<body>
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="darkModeToggleCheckbox">
            <input type="checkbox" id="darkModeToggleCheckbox">
            <div class="slider round">
                <span class="sun-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px" style="display: block; margin: auto;"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.836 17.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18.75a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-1.5a.75.75 0 01.75-.75zM5.106 17.836a.75.75 0 001.061-1.06l-1.591-1.59a.75.75 0 00-1.06 1.061l1.591 1.59zM3 12a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5H2.25A.75.75 0 013 12zM6.106 5.106a.75.75 0 00-1.06 1.061l1.59 1.591a.75.75 0 001.061-1.06l-1.59-1.591z"></path></svg></span>
                <span class="moon-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px" style="display: block; margin: auto;"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-3.51 1.713-6.636 4.362-8.442a.75.75 0 01.819.162z" clip-rule="evenodd"></path></svg></span>
            </div>
        </label>
    </div>

    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600">Sổ Theo Dõi Tài Chính Cá Nhân</h1>
            <p class="text-gray-600">Ghi chép, quản lý thu chi hàng ngày và so sánh theo tuần.</p>
        </header>

        <div id="message-box" style="display: none;"></div>

        <div class="section form-section">
            <h2 class="section-header collapsible-header active" data-collapsible-target="form-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path>
                    </svg>
                    <span id="form-title">Thêm Giao Dịch Mới</span>
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
            </h2>
            <div class="collapsible-content active" id="form-content">
				<form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3" data-transaction-mode="Chi">
					<div>
						<label for="datetime-input">Ngày &amp; Giờ:</label>
						<input type="datetime-local" id="datetime-input" required="">
					</div>

					<div>
						<label>Loại giao dịch:</label>
						<div class="radio-group">
							<label for="type-thu"><input type="radio" id="type-thu" name="type" value="Thu" required=""> Thu</label>
							<label for="type-chi"><input type="radio" id="type-chi" name="type" value="Chi" checked="" required=""> Chi</label>
							<label for="type-transfer"><input type="radio" id="type-transfer" name="type" value="Transfer" required=""> Chuyển tiền</label>
						</div>
					</div>

					<div class="form-field-normal">
						<label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hạng mục:</label>
						<select id="category" required="" class="block w-full h-11 px-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-300">
							</select>
					</div>

					<div>
						<label for="account" id="account-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tài khoản:</label>
						<select id="account" required="" class="block w-full h-11 px-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-300 appearance-none">
							</select>
					</div>
					
					<div class="form-field-transfer" style="display: none;"> 
						<label for="to-account" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Đến Tài khoản:</label>
						<select id="to-account" class="block w-full h-11 px-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-300">
							</select>
					</div>
					
					<div>
						<label for="amount-input">Số tiền:</label>
						<div class="amount-currency-group">
							<input type="text" inputmode="decimal" id="amount-input" placeholder="Nhập số tiền (VD: 22500)" required="">
							<select id="form-currency-selector">
								<option value="VND">VNĐ</option>
								<option value="USD">USD (quy đổi)</option>
							</select>
						</div>
						<button type="button" id="add-triple-zero-button" class="btn-secondary py-2 px-3 mt-2 text-sm rounded focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Thêm 000</button>
					</div>
					
					<div>
						<label for="description">Nội dung chi tiết:</label>
						<input type="text" id="description" placeholder="VD: Chuyển tiền học, Ăn trưa" list="description-suggestions">
						<datalist id="description-suggestions">
							</datalist>
					</div>

					<div id="transaction-suggestion-area" class="mt-3 mb-2 md:col-span-2" style="display: none;">
						<p class="text-sm text-gray-600 dark:text-gray-400">
							Gợi ý từ giao dịch cũ: 
							<span id="suggested-description" class="font-semibold"></span> 
							- <span id="suggested-amount" class="font-semibold"></span>
							<button type="button" id="apply-suggestion-button" class="ml-2 text-sm btn-secondary-outline">Áp dụng</button>
							<button type="button" id="dismiss-suggestion-button" class="ml-1 text-xs text-gray-500 hover:text-red-500">&times;</button>
						</p>
					</div>
					
					<div class="md:col-span-2 mt-4">
						<button type="submit" id="submit-transaction-button" class="btn-primary w-full">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
							Thêm Giao Dịch
						</button>
					</div>
				</form>
            </div>
        </div>

        <div class="section table-section">
             <h2 class="section-header collapsible-header active" data-collapsible-target="table-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5M3.375 19.5l1.95-1.95M12.375 19.5h8.875M12.375 19.5l-1.95-1.95M20.625 19.5a1.125 1.125 0 001.125-1.125M20.625 19.5l-1.95-1.95M3.75 4.5h16.5M3.75 4.5a2.25 2.25 0 00-2.25 2.25v11.25c0 1.24 1.01 2.25 2.25 2.25h16.5c1.24 0 2.25-1.01 2.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25M3.75 4.5v.75m16.5-.75v.75m0 0a2.25 2.25 0 01-2.25 2.25h-5.25a2.25 2.25 0 01-2.25-2.25m-5.25 0h5.25m-5.25 0a2.25 2.25 0 01-2.25-2.25M3.75 7.5v.75m16.5-.75v.75"></path></svg>
                    Danh Sách Giao Dịch
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
            </h2>
            <div class="collapsible-content active" id="table-content">
                <div class="table-actions">
                    <div class="filter-container"><label for="filter-month">Lọc theo tháng:</label><select id="filter-month" class="p-2 border rounded-md"><option value="all">Tất cả các tháng</option><option value="2025-05">Tháng 05/2025</option></select></div>
                </div>
                <div class="overflow-x-auto"><table id="transaction-table"><thead><tr><th>Ngày &amp; Giờ</th><th>Nội dung</th><th>Hạng mục</th><th>Số tiền (VNĐ)</th><th>Loại</th><th>Tài khoản</th><th>Thao tác</th></tr></thead><tbody id="transaction-list"><tr><td>11/05/2025 02:23</td><td></td><td>Ăn uống</td><td class="text-red-600">22.500&nbsp;₫</td><td>Chi Tiêu</td><td>Tiền mặt</td><td class="text-center"><button class="btn-edit"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square mr-1" viewBox="0 0 16 16"> <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"></path> <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"></path> </svg>Sửa</button><button class="btn-delete"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></td></tr></tbody></table></div>
                <p id="no-transactions" class="text-center text-gray-500 mt-4" style="display: none;">Chưa có giao dịch nào.</p>
            </div>
        </div>

        <div class="section summary-section">
            <h2 class="section-header collapsible-header active" data-collapsible-target="summary-content-wrapper">
                <div class="header-text-icon">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M18 10.2F18 6.57 15.314 4 12 4s-6 2.57-6 6.2c0 1.707.673 3.293 1.758 4.45l.149.149A6.086 6.086 0 0012 20.25a6.086 6.086 0 004.093-1.45l.149-.149A5.99 5.99 0 0018 10.2z"></path></svg>
                    Tóm Tắt Tài Chính (VNĐ)
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
            </h2>
            <div class="collapsible-content active" id="summary-content-wrapper">
                <div id="summary-content">
                    <div class="summary-item"><span>Tổng Thu <span id="summary-income-month-display">(Tháng Lọc)</span>:</span><span id="total-income" class="text-green-600 font-semibold">0</span></div>
                    <div class="summary-item"><span>Tổng Chi <span id="summary-expense-month-display">(Tháng Lọc)</span>:</span><span id="total-expenses" class="text-red-600 font-semibold">0</span></div>
                    <div class="summary-item"><span>Số Dư <span id="summary-balance-month-display">(Tháng Lọc)</span>:</span><span id="current-balance" class="text-blue-600 font-bold">0</span></div>
                </div>
                <div id="account-balance-list" class="account-balance-list"><h3>Số Dư Theo Tài Khoản (Tổng thể - VNĐ):</h3><div class="summary-item"><span>Tiền mặt: </span><span class="text-red-600">-22.500&nbsp;₫</span></div><div class="summary-item"><span>Momo: </span><span class="text-green-600">0&nbsp;₫</span></div><div class="summary-item"><span>Thẻ tín dụng A: </span><span class="text-green-600">0&nbsp;₫</span></div><div class="summary-item"><span>Techcombank: </span><span class="text-green-600">0&nbsp;₫</span></div><div class="summary-item"><span>BIDV: </span><span class="text-green-600">0&nbsp;₫</span></div><div class="summary-item"><span>Khác: </span><span class="text-green-600">0&nbsp;₫</span></div><div class="summary-item"><span>Sacombank: </span><span class="text-green-600">0&nbsp;₫</span></div></div>
            </div>
        </div>

		<div class="section expense-breakdown-section">
			<h2 class="section-header collapsible-header active" data-collapsible-target="expense-breakdown-content">
				<span id="expense-breakdown-title-text">Phân Loại Chi Tiêu Tháng 05/2025 - VNĐ</span>
				</h2>
			<div class="collapsible-content active" id="expense-breakdown-content">
				<div class="md:flex md:gap-6">
					<div class="md:w-1/2"> <div class="mb-4"> <label for="expenseChartTypeSelector" class="mr-2 font-medium">Kiểu biểu đồ:</label>
							<select id="expenseChartTypeSelector" class="p-2 border rounded-md">
								<option value="pie" selected="">Biểu đồ tròn</option>
								<option value="bar">Biểu đồ cột</option>
							</select>
						</div>

						<div id="expensePieChartContainer" class="chart-container" style="display: block;">
							<canvas id="expenseCategoryChart" style="display: block; box-sizing: border-box; height: 350px; width: 24px;" height="437" width="31"></canvas>
						</div>

						<div id="expenseBarChartContainer" class="chart-container" style="display: none;">
							<canvas id="expenseCategoryBarChart" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" height="0" width="0"></canvas> </div>
						<p id="no-expense-data-chart" class="text-center text-gray-500 mt-4" style="display: none;">Không có dữ liệu chi tiêu để vẽ biểu đồ.</p>

					</div>

					<div id="expense-category-list-container" class="expense-category-list md:w-1/2"><ul class="space-y-2"><li class="flex justify-between items-center text-sm">
									<div class="flex items-center">
										<span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: #FF6384"></span>
										<span>Ăn uống</span>
									</div>
									<div class="text-right">
										<span class="font-semibold">22.500&nbsp;₫</span>
										<span class="text-gray-500 dark:text-gray-400 ml-2">(100.0%)</span>
									</div>
								 </li></ul></div>
				</div>
			</div>
		</div>

		<div class="section statistics-table-section">
			<h2 class="section-header collapsible-header active" data-collapsible-target="statistics-table-content">
				<div class="header-text-icon">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; margin-right: 8px;" class="text-blue-600 dark:text-blue-400">
						<path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"></path>
					</svg>
					Thống Kê Chi Tiết <span id="stats-table-month-display">(Tháng 05/2025)</span>
				</div>
				<svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
				</svg>
			</h2>
			<div class="collapsible-content active" id="statistics-table-content">
				<table class="w-full mt-3">
					<tbody id="detailed-stats-tbody">
						<tr>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-300">Tổng Thu Nhập:</td>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-right font-semibold text-green-600 dark:text-green-400" id="stats-total-income">0&nbsp;₫</td>
						</tr>
						<tr>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-300">Tổng Chi Tiêu:</td>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-right font-semibold text-red-600 dark:text-red-400" id="stats-total-expense">22.500&nbsp;₫</td>
						</tr>
						<tr>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-300">Dòng tiền ròng (Thu - Chi):</td>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-right font-bold text-red-600 dark:text-red-400" id="stats-net-cashflow">-22.500&nbsp;₫</td>
						</tr>
						<tr>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-300">Số lượng giao dịch Thu:</td>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-right text-gray-800 dark:text-gray-200" id="stats-income-tx-count">0</td>
						</tr>
						<tr>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-300">Số lượng giao dịch Chi:</td>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-right text-gray-800 dark:text-gray-200" id="stats-expense-tx-count">1</td>
						</tr>
						<tr>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-300">Hạng mục chi nhiều nhất:</td>
							<td class="py-2 px-4 border-b border-gray-200 dark:border-gray-700 text-right text-gray-800 dark:text-gray-200" id="stats-top-expense-cat">Ăn uống</td>
						</tr>
						<tr>
							<td class="py-2 px-4 font-medium text-gray-700 dark:text-gray-300">Số tiền (Hạng mục chi nhiều nhất):</td> <td class="py-2 px-4 text-right text-red-600 dark:text-red-400 font-semibold" id="stats-top-expense-cat-amount">22.500&nbsp;₫</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

        <div class="section chart-section">
            <h2 class="section-header collapsible-header" data-collapsible-target="charts-grid-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M7.5 14.25V18a2.25 2.25 0 002.25 2.25h3.5A2.25 2.25 0 0015 18v-3.75M3.375 4.5c-.621 0-1.125.504-1.125 1.125v14.25c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H3.375z"></path></svg>
                    Biểu Đồ Tổng Quan
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
            </h2>
            <div class="collapsible-content" id="charts-grid-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div> <h3 class="text-lg font-semibold mb-2 text-center" id="income-expense-chart-title">Biểu Đồ Thu vs Chi Tháng 05/2025 - VNĐ</h3>
                        <div class="chart-container"><canvas id="incomeExpenseChart" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" height="0" width="0"></canvas></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-center">Chi Tiêu 7 Ngày Qua (Biểu đồ đường - VNĐ)</h3>
                        <div class="chart-container"><canvas id="last7DaysChart" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" height="0" width="0"></canvas></div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-lg font-semibold mb-2 text-center">So Sánh Tháng Này &amp; Tháng Trước (VNĐ)</h3>
                        <div class="chart-container"><canvas id="monthComparisonChart" style="display: block; box-sizing: border-box; height: 0px; width: 0px;" height="0" width="0"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section comparison-section">
            <h2 class="section-header collapsible-header active" data-collapsible-target="comparison-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-3.75h.008v.008H12v-.008zM12 12.75h.008v.008H12v-.008z"></path></svg>
                    Thống Kê &amp; So Sánh Tuần (VNĐ)
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
            </h2>
            <div class="collapsible-content active" id="comparison-content">
                <div class="filter-container">
                    <div class="flex items-center"><label for="filter-comparison-year">Năm:</label><input type="number" id="filter-comparison-year" class="p-2 border rounded-md w-24" min="2000" max="2100"></div>
                    <div class="flex items-center flex-grow"><label for="filter-comparison-week">Tuần:</label><select id="filter-comparison-week" class="p-2 border rounded-md w-full"><option value="none">-- Chọn tuần --</option><option value="2025-W52">Tuần 52 (22/12/2025 - 28/12/2025)</option><option value="2025-W51">Tuần 51 (15/12/2025 - 21/12/2025)</option><option value="2025-W50">Tuần 50 (8/12/2025 - 14/12/2025)</option><option value="2025-W49">Tuần 49 (1/12/2025 - 7/12/2025)</option><option value="2025-W48">Tuần 48 (24/11/2025 - 30/11/2025)</option><option value="2025-W47">Tuần 47 (17/11/2025 - 23/11/2025)</option><option value="2025-W46">Tuần 46 (10/11/2025 - 16/11/2025)</option><option value="2025-W45">Tuần 45 (3/11/2025 - 9/11/2025)</option><option value="2025-W44">Tuần 44 (27/10/2025 - 2/11/2025)</option><option value="2025-W43">Tuần 43 (20/10/2025 - 26/10/2025)</option><option value="2025-W42">Tuần 42 (13/10/2025 - 19/10/2025)</option><option value="2025-W41">Tuần 41 (6/10/2025 - 12/10/2025)</option><option value="2025-W40">Tuần 40 (29/9/2025 - 5/10/2025)</option><option value="2025-W39">Tuần 39 (22/9/2025 - 28/9/2025)</option><option value="2025-W38">Tuần 38 (15/9/2025 - 21/9/2025)</option><option value="2025-W37">Tuần 37 (8/9/2025 - 14/9/2025)</option><option value="2025-W36">Tuần 36 (1/9/2025 - 7/9/2025)</option><option value="2025-W35">Tuần 35 (25/8/2025 - 31/8/2025)</option><option value="2025-W34">Tuần 34 (18/8/2025 - 24/8/2025)</option><option value="2025-W33">Tuần 33 (11/8/2025 - 17/8/2025)</option><option value="2025-W32">Tuần 32 (4/8/2025 - 10/8/2025)</option><option value="2025-W31">Tuần 31 (28/7/2025 - 3/8/2025)</option><option value="2025-W30">Tuần 30 (21/7/2025 - 27/7/2025)</option><option value="2025-W29">Tuần 29 (14/7/2025 - 20/7/2025)</option><option value="2025-W28">Tuần 28 (7/7/2025 - 13/7/2025)</option><option value="2025-W27">Tuần 27 (30/6/2025 - 6/7/2025)</option><option value="2025-W26">Tuần 26 (23/6/2025 - 29/6/2025)</option><option value="2025-W25">Tuần 25 (16/6/2025 - 22/6/2025)</option><option value="2025-W24">Tuần 24 (9/6/2025 - 15/6/2025)</option><option value="2025-W23">Tuần 23 (2/6/2025 - 8/6/2025)</option><option value="2025-W22">Tuần 22 (26/5/2025 - 1/6/2025)</option><option value="2025-W21">Tuần 21 (19/5/2025 - 25/5/2025)</option><option value="2025-W20">Tuần 20 (12/5/2025 - 18/5/2025)</option><option value="2025-W19">Tuần 19 (5/5/2025 - 11/5/2025)</option><option value="2025-W18">Tuần 18 (28/4/2025 - 4/5/2025)</option><option value="2025-W17">Tuần 17 (21/4/2025 - 27/4/2025)</option><option value="2025-W16">Tuần 16 (14/4/2025 - 20/4/2025)</option><option value="2025-W15">Tuần 15 (7/4/2025 - 13/4/2025)</option><option value="2025-W14">Tuần 14 (31/3/2025 - 6/4/2025)</option><option value="2025-W13">Tuần 13 (24/3/2025 - 30/3/2025)</option><option value="2025-W12">Tuần 12 (17/3/2025 - 23/3/2025)</option><option value="2025-W11">Tuần 11 (10/3/2025 - 16/3/2025)</option><option value="2025-W10">Tuần 10 (3/3/2025 - 9/3/2025)</option><option value="2025-W09">Tuần 09 (24/2/2025 - 2/3/2025)</option><option value="2025-W08">Tuần 08 (17/2/2025 - 23/2/2025)</option><option value="2025-W07">Tuần 07 (10/2/2025 - 16/2/2025)</option><option value="2025-W06">Tuần 06 (3/2/2025 - 9/2/2025)</option><option value="2025-W05">Tuần 05 (27/1/2025 - 2/2/2025)</option><option value="2025-W04">Tuần 04 (20/1/2025 - 26/1/2025)</option><option value="2025-W03">Tuần 03 (13/1/2025 - 19/1/2025)</option><option value="2025-W02">Tuần 02 (6/1/2025 - 12/1/2025)</option><option value="2025-W01">Tuần 01 (30/12/2024 - 5/1/2025)</option></select></div>
                </div>
                <div id="weekly-comparison-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4" style="display: none;">
                    <div><h3 class="text-lg font-semibold mb-2 text-blue-700">Tuần Được Chọn (<span id="selected-week-display"></span>)</h3><div class="summary-item"><span>Số Dư Đầu Tuần:</span><span id="current-week-start-balance" class="text-blue-600">0</span></div><div class="summary-item"><span>Tổng Thu Tuần Này:</span><span id="current-week-income" class="text-green-600">0</span></div><div class="summary-item"><span>Tổng Chi Tuần Này:</span><span id="current-week-expenses" class="text-red-600">0</span></div><div class="summary-item"><span>Thay Đổi Ròng:</span><span id="current-week-net-change" class="font-bold">0</span></div></div>
                    <div><h3 class="text-lg font-semibold mb-2 text-gray-700">Tuần Trước Đó (<span id="previous-week-display"></span>)</h3><div class="summary-item"><span>Tổng Chi Tuần Trước:</span><span id="previous-week-expenses" class="text-red-600">0</span></div><hr class="my-3 border-gray-300"><h3 class="text-lg font-semibold mb-2 text-purple-700">So Sánh Chi Tiêu</h3><div class="summary-item"><span>Chênh Lệch (Này - Trước):</span><span id="spending-difference" class="font-bold">0</span></div></div>
                </div>
                <p id="no-comparison-data" class="text-center text-gray-500 mt-4" style="display: block;">Chọn một năm và tuần để xem thống kê.</p>
            </div>
        </div>

        <div class="section category-customization-section">
            <h2 class="section-header collapsible-header active" data-collapsible-target="category-customization-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 0015 0m-15 0a7.5 7.5 0 1115 0m-15 0H3m18 0h-1.5m-15.036-7.026A7.5 7.5 0 015.974 3.474m12.052 0A7.5 7.5 0 0118.026 4.974m0 14.052a7.5 7.5 0 01-1.526 1.526M5.974 19.026A7.5 7.5 0 014.5 18m0-12a7.5 7.5 0 00-1.526 1.526M18 4.5a7.5 7.5 0 00-1.526-1.526"></path></svg>
                    Tùy Chỉnh Hạng Mục
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
            </h2>
            <div class="collapsible-content active" id="category-customization-content">
                <div class="category-management">
					<div> <h3>Hạng Mục Thu</h3>
						<div class="mb-4"> <label for="new-income-category-name">Tên hạng mục thu mới:</label>
							<input type="text" id="new-income-category-name" placeholder="VD: Tiền cho thuê nhà">
							<button id="add-income-category-button" class="btn-primary btn-add-category">
								<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
								Thêm Hạng Mục Thu
							</button>
						</div>

                        <h4 class="collapsible-list-header active" data-collapsible-target="income-category-list-admin">
                            <span>Danh sách hạng mục thu:</span>
                            <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px; margin-left: auto;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
                            </svg>
                        </h4>
                        <ul id="income-category-list-admin" class="category-list collapsible-list-content active" style="max-height: 326px;"><li>Lương<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Thưởng<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Tiền được trả nợ<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Nhận tiền chuyển khoản<span> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-lock-fill inline-block ml-2 text-gray-400" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path></svg></span></li><li>Lãi tiết kiệm<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Thu nhập từ đầu tư<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Thu nhập phụ<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Thu nhập khác (chung)<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li></ul>
						</div>
					<div> <h3>Hạng Mục Chi</h3>
						<div class="mb-4"> <label for="new-expense-category-name">Tên hạng mục chi mới:</label>
							<input type="text" id="new-expense-category-name" placeholder="VD: Du lịch">
							<button id="add-expense-category-button" class="btn-primary btn-add-category">
								<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
								Thêm Hạng Mục Chi
							</button>
						</div>

						<h4 class="collapsible-list-header active" data-collapsible-target="expense-category-list-admin">
							<span>Danh sách hạng mục chi:</span>
							<svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px; margin-left: auto;">
								<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
							</svg>
						</h4>
						<ul id="expense-category-list-admin" class="category-list collapsible-list-content active" style="max-height: 489px;"><li>Ăn uống<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Đi lại<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Nhà ở<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Hóa đơn (Điện, nước, internet)<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Mua sắm (Quần áo, đồ dùng)<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Giải trí<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Sức khỏe<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Giáo dục<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Chi cho đầu tư<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Trả nợ (cho người khác)<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Chuyển tiền đi<span> <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-lock-fill inline-block ml-2 text-gray-400" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path></svg></span></li><li>Chi phí khác (chung)<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li></ul>
						</div>
					<div> <h3>Quản Lý Tài Khoản</h3>
						<div class="mb-4"> <label for="new-account-name">Tên tài khoản mới:</label>
							<input type="text" id="new-account-name" placeholder="VD: Ví ShopeePay, Tiết kiệm Ngân hàng X" class="p-2 border rounded-md w-full mb-2">
							<button id="add-account-button" class="btn-primary btn-add-category">
								<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px; height:20px; margin-right:6px;">
									<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
								</svg>
								Thêm Tài Khoản
							</button>
						</div>

						<h4 class="collapsible-list-header active" data-collapsible-target="account-list-admin">
							<span>Danh sách tài khoản hiện có:</span>
							<svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px; margin-left: auto;">
								<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
							</svg>
						</h4>
						<ul id="account-list-admin" class="category-list collapsible-list-content active" style="max-height: 285px;"><li>Tiền mặt<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Momo<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Thẻ tín dụng A<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Techcombank<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>BIDV<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Khác<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li><li>Sacombank<button class="btn-delete text-xs px-2 py-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"></path> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"></path> </svg>Xóa</button></li></ul>
						</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section data-io-section">
            <h2 class="section-header collapsible-header active" data-collapsible-target="data-io-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg>
                    Quản lý Dữ liệu
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
            </h2>
            <div class="collapsible-content active" id="data-io-content">
                <div class="button-group">
                    <button id="export-button" class="btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg>Xuất Dữ Liệu (JSON)</button>
                    <button id="export-csv-button" class="btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path>
                        </svg>
                        Xuất Dữ Liệu (CSV)
                    </button>
                    <button id="import-button" class="btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"></path></svg>Nhập Dữ Liệu (JSON)</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
                <p class="text-sm text-gray-500 mt-3">Lưu ý: Nhập dữ liệu sẽ ghi đè toàn bộ dữ liệu hiện tại.</p>
            </div>
        </div>
		
		 <div id="virtualNumericKeyboard" class="fixed bottom-0 left-0 right-0 bg-gray-200 dark:bg-gray-800 p-2 shadow-lg z-50" style="display: none;">
			<div class="grid grid-cols-4 gap-1 text-center">
				<button data-key="1" class="virtual-key py-3 text-lg sm:text-xl">1</button>
				<button data-key="2" class="virtual-key py-3 text-lg sm:text-xl">2</button>
				<button data-key="3" class="virtual-key py-3 text-lg sm:text-xl">3</button>
				<button data-key="backspace" class="virtual-key key-action row-span-2 flex items-center justify-center py-3">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
						<path d="M5.83 5.146a.5.5 0 0 0 0 .708L7.975 8l-2.147 2.146a.5.5 0 0 0 .707.708L8.683 8.707l2.147 2.147a.5.5 0 0 0 .707-.708L9.39 8l2.147-2.146a.5.5 0 0 0-.707-.708L8.683 7.293 6.536 5.146a.5.5 0 0 0-.707 0z"></path>
						<path d="M13.683 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7.08a2 2 0 0 1-1.519-.698L.241 8.65a1 1 0 0 1 0-1.302L5.084 1.7A2 2 0 0 1 6.603 1h7.08zm-7.08 1a1 1 0 0 0-.76.35L1 7.35a.5.5 0 0 0 0 .65l4.284 4.284a1 1 0 0 0 .759.35h7.08a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1h-7.08z"></path>
					</svg>
				</button>
				<button data-key="4" class="virtual-key py-3 text-lg sm:text-xl">4</button>
				<button data-key="5" class="virtual-key py-3 text-lg sm:text-xl">5</button>
				<button data-key="6" class="virtual-key py-3 text-lg sm:text-xl">6</button>
				<button data-key="7" class="virtual-key py-3 text-lg sm:text-xl">7</button>
				<button data-key="8" class="virtual-key py-3 text-lg sm:text-xl">8</button>
				<button data-key="9" class="virtual-key py-3 text-lg sm:text-xl">9</button>
				<button data-key="done" class="virtual-key key-done row-span-2 flex items-center justify-center py-3 text-lg sm:text-xl">Tiếp</button>
				<button data-key="000" class="virtual-key key-action py-3 text-lg sm:text-xl">000</button>
				<button data-key="0" class="virtual-key py-3 text-lg sm:text-xl">0</button>
				<button data-key="." class="virtual-key key-action py-3 text-lg sm:text-xl">.</button>
			</div>
		</div>
	<script>
	
        Chart.register(ChartDataLabels);
        const USD_TO_VND_RATE = 25000; // Giữ nguyên hoặc cho phép người dùng cấu hình nếu muốn
        const TRANSFER_CATEGORY_OUT = "Chuyển tiền đi";
        const TRANSFER_CATEGORY_IN = "Nhận tiền chuyển";

        function migrateOriginalAmountsForOldVNDTransactions() {
            const MIGRATION_KEY_ORIGINAL_AMOUNT_VND = 'migration_original_amount_vnd_v1_done';
            if (localStorage.getItem(MIGRATION_KEY_ORIGINAL_AMOUNT_VND)) {
                console.log("Di chuyển originalAmount cho giao dịch VNĐ cũ đã được thực hiện trước đó.");
                return;
            }

            let transactions = JSON.parse(localStorage.getItem('transactions_v2') || '[]');
            let changed = false;
            if (transactions.length > 0) {
                console.log("Bắt đầu kiểm tra và di chuyển originalAmount cho giao dịch VNĐ cũ...");
                transactions.forEach(tx => {
                    if (tx.originalCurrency === 'VND' && typeof tx.originalAmount === 'number' && typeof tx.amount === 'number') {
                        // Heuristic: Nếu amount gần bằng originalAmount * 1000 VÀ originalAmount có vẻ là số "nhỏ" (có thể chứa thập phân)
                        // thì originalAmount này có thể là giá trị "base" từ thời x1000.
                        // Chúng ta muốn originalAmount bây giờ phản ánh giá trị đầy đủ sẽ được hiển thị trong form.
                        const isLikelyOldScaledVnd = Math.abs(tx.amount - (tx.originalAmount * 1000)) < 1 && // amount ~ originalAmount * 1000
                                                  tx.originalAmount.toString().includes('.'); // originalAmount có dạng thập phân

                        if (isLikelyOldScaledVnd) {
                            console.log(`Di chuyển originalAmount cho giao dịch ID ${tx.id}: từ ${tx.originalAmount} thành ${tx.amount}`);
                            tx.originalAmount = tx.amount; // Giờ originalAmount sẽ là giá trị đầy đủ
                            changed = true;
                        }
                    }
                });

                if (changed) {
                    localStorage.setItem('transactions_v2', JSON.stringify(transactions));
                    console.log("Hoàn tất di chuyển originalAmount. Dữ liệu đã được cập nhật.");
                } else {
                    console.log("Không có originalAmount nào cần di chuyển hoặc đã ở định dạng mới.");
                }
                localStorage.setItem(MIGRATION_KEY_ORIGINAL_AMOUNT_VND, 'true');
            }
        }
        // BẠN CÓ THỂ GỌI HÀM NÀY MỘT LẦN KHI ỨNG DỤNG KHỞI ĐỘNG, TRƯỚC KHI loadUserPreferences
        // migrateOriginalAmountsForOldVNDTransactions(); 
        // SAU KHI CHẮC CHẮN NÓ HOẠT ĐỘNG ĐÚNG VÀ CHỈ CHẠY MỘT LẦN, BẠN CÓ THỂ XÓA HOẶC VÔ HIỆU HÓA LỜI GỌI NÀY.
        // --------------------------------------------------------------------
        // KẾT THÚC PHẦN CẢNH BÁO DI CHUYỂN DỮ LIỆU
        // --------------------------------------------------------------------


        // --- CÁC BIẾN DOM (Giữ nguyên hoặc điều chỉnh nếu ID thay đổi) ---
        const darkModeToggleCheckbox = document.getElementById('darkModeToggleCheckbox');
        const DARK_MODE_CLASS = 'dark-mode';
        const THEME_STORAGE_KEY = 'themePreference';

        const transactionForm = document.getElementById('transaction-form');
        const formTitleEl = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-transaction-button');
        const transactionList = document.getElementById('transaction-list');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const currentBalanceEl = document.getElementById('current-balance');
        const accountBalanceListEl = document.getElementById('account-balance-list');
        const datetimeInput = document.getElementById('datetime-input');
        const categoryInput = document.getElementById('category');
		
		// >>> THÊM 3 DÒNG MỚI CỦA BẠN VÀO ĐÂY:
		const transactionSuggestionAreaEl = document.getElementById('transaction-suggestion-area');
		const suggestedDescriptionEl = document.getElementById('suggested-description');
		const suggestedAmountEl = document.getElementById('suggested-amount');
		const applySuggestionButtonEl = document.getElementById('apply-suggestion-button');
		const dismissSuggestionButtonEl = document.getElementById('dismiss-suggestion-button');
		let currentSuggestedTransaction = null; // Để lưu trữ giao dịch được gợi ý
		
		// >>> THÊM 3 DÒNG MỚI CỦA BẠN VÀO ĐÂY:
        const summaryIncomeMonthDisplayEl = document.getElementById('summary-income-month-display');
        const summaryExpenseMonthDisplayEl = document.getElementById('summary-expense-month-display');
        const summaryBalanceMonthDisplayEl = document.getElementById('summary-balance-month-display');
		
        // const categoryContainer = categoryInput.parentElement; // Dòng này bạn có dùng không?
        const amountTextInput = document.getElementById('amount-input'); // QUAN TRỌNG CHO NÚT "000"
        const formCurrencySelector = document.getElementById('form-currency-selector');
        const descriptionInput = document.getElementById('description');
        const accountInput = document.getElementById('account');
        const accountLabel = document.getElementById('account-label');
        // const toAccountContainer = document.querySelector('.form-field-transfer'); // Dòng này bạn có dùng không?
        const toAccountInput = document.getElementById('to-account');
        const noTransactionsMessage = document.getElementById('no-transactions');
        const filterMonthSelect = document.getElementById('filter-month');
        const messageBox = document.getElementById('message-box');

        const incomeExpenseChartCanvas = document.getElementById('incomeExpenseChart').getContext('2d');
        const expenseCategoryChartCanvas = document.getElementById('expenseCategoryChart').getContext('2d');
        const expenseCategoryListContainerEl = document.getElementById('expense-category-list-container');
        const noExpenseDataEl = document.getElementById('no-expense-data');
        const last7DaysChartCanvas = document.getElementById('last7DaysChart').getContext('2d');
        const monthComparisonChartCanvas = document.getElementById('monthComparisonChart').getContext('2d');
		// ... các biến hiện có ...
		const expenseCategoryBarCtx = document.getElementById('expenseCategoryBarChart').getContext('2d');


		const expenseChartTypeSelector = document.getElementById('expenseChartTypeSelector');
		const expensePieChartContainer = document.getElementById('expensePieChartContainer');
		const expenseBarChartContainer = document.getElementById('expenseBarChartContainer');
	
		// const noExpenseDataEl = document.getElementById('no-expense-data-list'); // Đổi tên hoặc giữ nguyên nếu bạn đã có cho list

		// Các element hiển thị thông báo "không có dữ liệu"
		// (Đảm bảo ID trong HTML của bạn khớp với các ID này)
		const noExpenseDataChartEl = document.getElementById('no-expense-data-chart'); // MỚI (cho khu vực biểu đồ)
		const noExpenseDataListEl = document.getElementById('no-expense-data-list');   // ID này bạn đã cập nhật trong HTML cho phần danh sách


        const filterComparisonYearInput = document.getElementById('filter-comparison-year');
        const filterComparisonWeekSelect = document.getElementById('filter-comparison-week');
        const weeklyComparisonContentEl = document.getElementById('weekly-comparison-content');
        const selectedWeekDisplayEl = document.getElementById('selected-week-display');
        const currentWeekStartBalanceEl = document.getElementById('current-week-start-balance');
        const currentWeekIncomeEl = document.getElementById('current-week-income');
        const currentWeekExpensesEl = document.getElementById('current-week-expenses');
        const currentWeekNetChangeEl = document.getElementById('current-week-net-change');
        const previousWeekDisplayEl = document.getElementById('previous-week-display');
        const previousWeekExpensesEl = document.getElementById('previous-week-expenses');
        const spendingDifferenceEl = document.getElementById('spending-difference');
        const noComparisonDataEl = document.getElementById('no-comparison-data');

        const typeRadioButtons = document.querySelectorAll('input[name="type"]');
        const exportButton = document.getElementById('export-button');
        const exportCsvButton = document.getElementById('export-csv-button');
        const importButton = document.getElementById('import-button');
        const importFileInput = document.getElementById('import-file-input');

        const newIncomeCategoryNameInput = document.getElementById('new-income-category-name');
        const addIncomeCategoryButton = document.getElementById('add-income-category-button');
        const incomeCategoryListAdminEl = document.getElementById('income-category-list-admin');
        const newExpenseCategoryNameInput = document.getElementById('new-expense-category-name');
        const addExpenseCategoryButton = document.getElementById('add-expense-category-button');
        const expenseCategoryListAdminEl = document.getElementById('expense-category-list-admin');
        const newAccountNameInput = document.getElementById('new-account-name');
        const addAccountButton = document.getElementById('add-account-button');
        const accountListAdminEl = document.getElementById('account-list-admin');

        // Nút mới
        const addTripleZeroButton = document.getElementById('add-triple-zero-button');


        let transactions = [];
        let incomeExpenseChart;
        let expenseCategoryChart;
		let expenseCategoryBarChart; // Biến cho instance biểu đồ cột
        let last7DaysChart;
        let monthComparisonChart;
        let editingTransactionId = null;

        let incomeCategories = [];
        let expenseCategories = [];
        let accounts = [];

        const defaultIncomeCategories = [ { value: "Lương", text: "Lương" }, { value: "Thưởng", text: "Thưởng" }, { value: "Tiền được trả nợ", text: "Tiền được trả nợ" }, { value: TRANSFER_CATEGORY_IN, text: "Nhận tiền chuyển khoản" }, { value: "Lãi tiết kiệm", text: "Lãi tiết kiệm" }, { value: "Thu nhập từ đầu tư", text: "Thu nhập từ đầu tư" }, { value: "Thu nhập phụ", text: "Thu nhập phụ" }, { value: "Thu nhập khác", text: "Thu nhập khác (chung)" } ];
        const defaultExpenseCategories = [ { value: "Ăn uống", text: "Ăn uống" }, { value: "Đi lại", text: "Đi lại" }, { value: "Nhà ở", text: "Nhà ở" }, { value: "Hóa đơn", text: "Hóa đơn (Điện, nước, internet)" }, { value: "Mua sắm", text: "Mua sắm (Quần áo, đồ dùng)" }, { value: "Giải trí", text: "Giải trí" }, { value: "Sức khỏe", text: "Sức khỏe" }, { value: "Giáo dục", text: "Giáo dục" }, { value: "Chi cho đầu tư", text: "Chi cho đầu tư" }, { value: "Trả nợ", text: "Trả nợ (cho người khác)" }, { value: TRANSFER_CATEGORY_OUT, text: "Chuyển tiền đi" }, { value: "Chi phí khác", text: "Chi phí khác (chung)" } ];
        const defaultAccounts = [ { value: "Tiền mặt", text: "Tiền mặt" }, { value: "Momo", text: "Momo" }, { value: "Thẻ tín dụng A", text: "Thẻ tín dụng A" }, { value: "Techcombank", text: "Techcombank" }, { value: "BIDV", text: "BIDV" }, { value: "Khác", text: "Khác" } ];
        const categoryColors = [ '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#8366FF', '#289F40', '#D26384', '#3C64C8', '#C89632' ];

        // --- HÀM TIỆN ÍCH (Giữ nguyên các hàm tiện ích của bạn) ---
        function showMessage(message, type = 'success') { messageBox.textContent = message; messageBox.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'message-success' : 'message-error'}`; messageBox.style.display = 'block'; setTimeout(() => { messageBox.style.display = 'none'; }, 3000); }
        
		function formatCurrency(amount, currencyCode = 'VND') {
					if (isNaN(amount) || amount === null) amount = 0;

					if (currencyCode === 'VND') {
						// Sử dụng 'en-US' để định dạng số có dấu phẩy hàng nghìn
						const numberFormatter = new Intl.NumberFormat('en-US', {
							style: 'decimal', // Chỉ định dạng số, không kèm ký hiệu tiền tệ từ bước này
							minimumFractionDigits: 0,
							maximumFractionDigits: 0
						});
						// Thêm ký hiệu '₫' và một khoảng trắng không ngắt dòng (\u00A0)
						return numberFormatter.format(amount) + '\u00A0₫';
					} else if (currencyCode === 'USD') {
						// Giữ nguyên định dạng chuẩn cho USD (đã dùng dấu phẩy hàng nghìn)
						return new Intl.NumberFormat('en-US', {
							style: 'currency',
							currency: 'USD',
							minimumFractionDigits: 2,
							maximumFractionDigits: 2
						}).format(amount);
					} else {
						// Đối với các loại tiền tệ khác, bạn có thể giữ nguyên logic cũ
						// sử dụng locale 'vi-VN' hoặc chọn một locale khác như 'en-US'
						// để có dấu phẩy hàng nghìn nếu muốn.
						// Dưới đây là logic gốc cho các loại tiền tệ khác:
						const options = {
							style: 'currency',
							currency: currencyCode,
							minimumFractionDigits: 0, // Theo code gốc của bạn
							maximumFractionDigits: 2  // Theo code gốc của bạn
						};
						const locale = 'vi-VN'; // Locale gốc của bạn cho các trường hợp khác
						return new Intl.NumberFormat(locale, options).format(amount);
					}
				}

        function formatDateTimeLocalInput(date) { /* ... mã gốc của bạn ... */ 
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        function formatIsoDateTime(date) { /* ... mã gốc của bạn ... */ 
            if (!date || isNaN(new Date(date).getTime())) date = new Date();
            else date = new Date(date);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }
        function formatDisplayDateTime(isoString) { /* ... mã gốc của bạn ... */ 
             if (!isoString) return '';
            try {
                let date = new Date(isoString);
                if (isNaN(date.getTime())) return isoString; 
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                console.error("Error formatting display date/time:", e, "Input:", isoString);
                return isoString;
            }
        }
        function formatDateTimeForCSV(isoString) { /* ... mã gốc của bạn ... */
            if (!isoString) return '';
            try {
                const d = new Date(isoString);
                if (isNaN(d.getTime())) return isoString;
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
            } catch (e) { return isoString; }
        }

        // --- HÀM NORMALIZEAMOUNTSTRING (CẬP NHẬT) ---
		function normalizeAmountString(amountStr) {
			if (typeof amountStr !== 'string' || !amountStr.trim()) {
				return "";
			}
			let str = amountStr.trim();
			const hasComma = str.includes(',');
			const hasPeriod = str.includes('.');

			if (hasComma && hasPeriod) {
				if (str.lastIndexOf(',') > str.lastIndexOf('.')) { // Kiểu châu Âu: 1.234,56
					str = str.replace(/\./g, ''); // Xóa dấu chấm phân cách hàng nghìn
					str = str.replace(',', '.');  // Chuyển dấu phẩy thập phân thành dấu chấm
				} else { // Kiểu Mỹ: 1,234.56
					str = str.replace(/,/g, ''); // Xóa dấu phẩy phân cách hàng nghìn
				}
			} else if (hasComma) { // Chỉ có dấu phẩy
				const commaCount = (str.match(/,/g) || []).length;
				if (commaCount === 1) {
					const decimalPart = str.substring(str.lastIndexOf(',') + 1);
					const integerPartStr = str.substring(0, str.lastIndexOf(','));
					if (/^\d*$/.test(integerPartStr.replace(/,/g, '')) && /^\d+$/.test(decimalPart) && str.lastIndexOf(',') > 0 && decimalPart.length > 0) {
						 if (decimalPart.length <= 3) { // Ưu tiên là thập phân nếu phần sau dấu phẩy ngắn
							str = str.replace(',', '.');
						 } else { // Ví dụ "1,2345" -> có thể là 12345
							str = str.replace(/,/g, '');
						 }
					} else { // Cấu trúc không rõ ràng là thập phân
						str = str.replace(/,/g, '');
					}
				} else { // Nhiều dấu phẩy
					str = str.replace(/,/g, ''); // Coi tất cả là phân cách hàng nghìn
				}
			} else if (hasPeriod) { // Chỉ có dấu chấm
				const periodCount = (str.match(/\./g) || []).length;
				if (periodCount > 1) {
					// Xóa tất cả các dấu chấm ngoại trừ dấu chấm cuối cùng
					// Ví dụ: "1.234.567" -> "1234.567"
					// Ví dụ: "1.000.000" -> "1000.000" (để parseFloat ra 1000)
					str = str.replace(/\.(?=.*\.)/g, '');
				}
				// Nếu chỉ có 1 dấu chấm (ví dụ "22.5"), nó sẽ được giữ nguyên cho parseFloat.
			}
			return str;
		}


        function parseAmountInput(amountStr, currency) {
            if (!amountStr) return 0;
            
            const normalizedStr = normalizeAmountString(amountStr); 
            let val = parseFloat(normalizedStr);

            if (isNaN(val)) {
                console.warn(`NormalizeAmountString failed or produced NaN for input: '${amountStr}'. Normalized string was: '${normalizedStr}'. Attempting direct parsing.`);
                let directParseStr = String(amountStr).trim();
                if (directParseStr.includes(',') && !directParseStr.includes('.')) {
                    directParseStr = directParseStr.replace(/,/g, '.');
                } else { 
                    directParseStr = directParseStr.replace(/[^0-9.]/g, (match, offset, fullString) => {
                        return (match === '.' && fullString.indexOf('.') === offset) ? '.' : '';
                    });
                }
                val = parseFloat(directParseStr);
            }
            
            if (isNaN(val)) return 0;

            if (currency === 'USD') {
                val = val * USD_TO_VND_RATE; 
            } 

            return Math.round(val); // VNĐ giờ sẽ là số nguyên sau khi làm tròn
        }
		
		function toggleExpenseChartDisplay() {
			if (!expenseChartTypeSelector || !expensePieChartContainer || !expenseBarChartContainer || !noExpenseDataChartEl) {
				// console.error("toggleExpenseChartDisplay: DOM elements for chart toggling are missing.");
				return;
			}

			const selectedType = expenseChartTypeSelector.value;
			// Kiểm tra xem có dữ liệu không (dựa vào việc một trong hai biểu đồ đã được khởi tạo và có dữ liệu)
			const chartsHaveData = (expenseCategoryChart && expenseCategoryChart.data.labels && expenseCategoryChart.data.labels.length > 0) ||
								   (expenseCategoryBarChart && expenseCategoryBarChart.data.labels && expenseCategoryBarChart.data.labels.length > 0);

			if (!chartsHaveData && totalExpenses === 0) { // Kiểm tra thêm totalExpenses từ renderExpenseCategoryChartAndList (cần truyền vào hoặc dùng biến global)
														// Hoặc đơn giản hơn là dựa vào trạng thái của noExpenseDataChartEl được set trong renderExpenseCategoryChartAndList
				expensePieChartContainer.style.display = 'none';
				expenseBarChartContainer.style.display = 'none';
				noExpenseDataChartEl.style.display = 'block';
				return;
			}
			
			// Nếu hàm render đã ẩn/hiện noExpenseDataChartEl rồi thì không cần dòng này nữa
			// noExpenseDataChartEl.style.display = 'none'; 

			if (selectedType === 'pie') {
				expensePieChartContainer.style.display = 'block';
				expenseBarChartContainer.style.display = 'none';
			} else if (selectedType === 'bar') {
				expensePieChartContainer.style.display = 'none';
				expenseBarChartContainer.style.display = 'block';
			}
		}
		// --- Luu bo nho ---
		function findAndDisplayTransactionSuggestion() {
			if (!transactionForm || editingTransactionId) { // Không gợi ý khi đang sửa
				hideTransactionSuggestion();
				return;
			}

			const typeRadio = document.querySelector('input[name="type"]:checked');
			const currentType = typeRadio ? typeRadio.value : null;
			const currentCategory = categoryInput.value;
			const currentAccount = accountInput.value; // Có thể thêm điều kiện này

			if (!currentType || !currentCategory) {
				hideTransactionSuggestion();
				return;
			}

			// Tìm kiếm giao dịch gần nhất khớp với loại và hạng mục (và tài khoản nếu muốn)
			// Ưu tiên các giao dịch gần đây hơn
			const recentTransactions = [...transactions].sort((a, b) => new Date(b.datetime) - new Date(a.datetime));

			currentSuggestedTransaction = recentTransactions.find(tx => 
				tx.type === currentType && 
				tx.category === currentCategory &&
				// tx.account === currentAccount && // Bỏ comment dòng này nếu muốn khớp cả tài khoản
				!tx.isTransfer // Thường không cần gợi ý cho giao dịch chuyển tiền theo cách này
			);

			if (currentSuggestedTransaction) {
				if (suggestedDescriptionEl) suggestedDescriptionEl.textContent = currentSuggestedTransaction.description || "(không có mô tả)";
				if (suggestedAmountEl) {
					// Hiển thị số tiền gốc nếu có và khác VNĐ, nếu không thì hiển thị số tiền đã quy đổi
					if (currentSuggestedTransaction.originalCurrency && currentSuggestedTransaction.originalCurrency !== 'VND' && typeof currentSuggestedTransaction.originalAmount === 'number') {
						suggestedAmountEl.textContent = formatCurrency(currentSuggestedTransaction.originalAmount, currentSuggestedTransaction.originalCurrency);
					} else {
						suggestedAmountEl.textContent = formatCurrency(currentSuggestedTransaction.amount, 'VND');
					}
				}
				if (transactionSuggestionAreaEl) transactionSuggestionAreaEl.style.display = 'block';
			} else {
				hideTransactionSuggestion();
			}
		}

		function hideTransactionSuggestion() {
			if (transactionSuggestionAreaEl) transactionSuggestionAreaEl.style.display = 'none';
			currentSuggestedTransaction = null;
		}

		function applyTransactionSuggestion() {
			if (currentSuggestedTransaction) {
				// Điền số tiền (giá trị gốc) và đơn vị tiền tệ gốc
				if (currentSuggestedTransaction.originalCurrency && typeof currentSuggestedTransaction.originalAmount === 'number') {
					amountTextInput.value = String(currentSuggestedTransaction.originalAmount); // Điền giá trị gốc
					formCurrencySelector.value = currentSuggestedTransaction.originalCurrency;
				} else { // Fallback nếu không có thông tin tiền tệ gốc rõ ràng
					amountTextInput.value = String(currentSuggestedTransaction.amount); // Điền giá trị đã quy đổi
					formCurrencySelector.value = 'VND'; 
				}

				descriptionInput.value = currentSuggestedTransaction.description || "";

				// Tùy chọn: có thể điền cả tài khoản nếu logic tìm kiếm của bạn bao gồm tài khoản
				// accountInput.value = currentSuggestedTransaction.account;

				showMessage('Đã áp dụng gợi ý từ giao dịch cũ.', 'info');
				hideTransactionSuggestion();
				amountTextInput.focus(); // Chuyển focus để người dùng có thể sửa nhanh nếu cần
			}
		}		
		
        // --- DARK MODE LOGIC (Giữ nguyên) ---
		function applyTheme(theme) {
			// console.log('Applying theme:', theme);
			if (theme === 'dark') {
				document.body.classList.add(DARK_MODE_CLASS);
				if (darkModeToggleCheckbox) darkModeToggleCheckbox.checked = true;
				localStorage.setItem(THEME_STORAGE_KEY, 'dark');
			} else {
				document.body.classList.remove(DARK_MODE_CLASS);
				if (darkModeToggleCheckbox) darkModeToggleCheckbox.checked = false;
				localStorage.setItem(THEME_STORAGE_KEY, 'light');
			}
			updateAllChartColorsForTheme(theme); // Gọi hàm cập nhật màu biểu đồ
		}

		function toggleTheme() {
			// console.log('toggleTheme called. Checkbox checked:', darkModeToggleCheckbox ? darkModeToggleCheckbox.checked : 'checkbox not found');
			if (!darkModeToggleCheckbox) {
				console.error("darkModeToggleCheckbox not found in toggleTheme");
				return;
			}
			applyTheme(darkModeToggleCheckbox.checked ? 'dark' : 'light');
		}
		
		function loadThemePreference() {
			// console.log('loadThemePreference called'); // Thêm để kiểm tra
			const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
			const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

			if (savedTheme) {
				applyTheme(savedTheme);
			} else if (prefersDarkScheme) {
				applyTheme('dark');
			} else {
				applyTheme('light'); // Mặc định là light nếu không có gì được lưu và không có ưu tiên hệ thống
			}
		}
		
		function updateAllChartColorsForTheme(theme) {
			const isDarkMode = theme === 'dark';
			const gridColor = isDarkMode ? 'rgba(107, 114, 128, 0.2)' : 'rgba(209, 213, 219, 0.5)';
			const ticksColor = isDarkMode ? '#9ca3af' : '#6b7280';
			const axisLineColor = isDarkMode ? '#4b5563' : '#d1d5db';
			const legendAndAxisTitleColor = isDarkMode ? '#d1d5db' : '#374151';
			const chartMainTitleColor = isDarkMode ? '#e5e7eb' : '#1f2937';
			let pieSliceBorderColor = isDarkMode ? (window.getComputedStyle(document.body).backgroundColor || '#374151') : '#ffffff';
			const datalabelPieColor = '#ffffff';
			const datalabelGeneralColor = isDarkMode ? '#e0e0e0' : '#333333';

			const charts = [
				incomeExpenseChart, expenseCategoryChart, last7DaysChart,
				monthComparisonChart, expenseCategoryBarChart // Đã bao gồm biểu đồ cột
			].filter(c => c && c.ctx && typeof c.update === 'function');

			charts.forEach(chart => {
				if (!chart.options) return;
				try {
					if (chart.options.plugins) {
						if (chart.options.plugins.legend && chart.options.plugins.legend.labels) {
							chart.options.plugins.legend.labels.color = legendAndAxisTitleColor;
						}
						if (chart.options.plugins.title && chart.options.plugins.title.display) {
							chart.options.plugins.title.color = chartMainTitleColor;
						}
					}

					if (chart.options.scales) {
						Object.keys(chart.options.scales).forEach(scaleKey => {
							const scale = chart.options.scales[scaleKey];
							if (scale) {
								if (scale.grid) scale.grid.color = gridColor;
								if (typeof scale.borderColor !== 'undefined') scale.borderColor = axisLineColor;
								if (scale.ticks) scale.ticks.color = ticksColor;
								if (scale.title && scale.title.display) scale.title.color = legendAndAxisTitleColor;
							}
						});
					}

					if (chart.options.plugins && chart.options.plugins.datalabels) {
						chart.options.plugins.datalabels.color = (chart === expenseCategoryChart) ? datalabelPieColor : datalabelGeneralColor;
					}
					
					if (chart === expenseCategoryChart && chart.data.datasets && chart.data.datasets.length > 0) {
						chart.data.datasets[0].borderColor = pieSliceBorderColor;
					}
					
					chart.update();
				} catch (e) {
					console.error("[Theme] Error updating chart colors:", chart.config ? chart.config.type : 'Unknown Chart', e);
				}
			});
		}

        function setDefaultDateTime() { if(datetimeInput) datetimeInput.value = formatDateTimeLocalInput(new Date()); }
        function setDefaultComparisonYear() { if(filterComparisonYearInput) filterComparisonYearInput.value = new Date().getFullYear(); }
		function loadUserPreferences() {
			// Ví dụ cho transactions (giữ nguyên cách bạn đã làm hoặc cải thiện)
			const storedTransactions = localStorage.getItem('transactions_v2');
			transactions = [];
			if (storedTransactions) {
				try {
					transactions = JSON.parse(storedTransactions);
					console.log("Loaded transactions_v2:", transactions); // KIỂM TRA TRANSACTIONS
					if (!Array.isArray(transactions)) {
						console.warn("Dữ liệu transactions_v2 từ localStorage không phải là mảng, đặt lại thành mảng rỗng.");
						transactions = [];
					}
				} catch (error) {
					console.error("Lỗi khi parse transactions_v2 từ localStorage:", error);
					transactions = [];
					showMessage('Có lỗi khi tải dữ liệu giao dịch. Dữ liệu có thể đã bị hỏng.', 'error');
				}
			} else {
				console.log("Không tìm thấy transactions_v2 trong localStorage, sử dụng mảng rỗng.");
				transactions = []; // Đảm bảo transactions luôn là một mảng
			}

			// --- LÀM TƯƠNG TỰ CHO incomeCategories ---
			const storedIncomeCategories = localStorage.getItem('customIncomeCategories_v2');
			incomeCategories = []; // Khởi tạo
			if (storedIncomeCategories) {
				try {
					incomeCategories = JSON.parse(storedIncomeCategories);
					console.log("Loaded customIncomeCategories_v2:", incomeCategories); // KIỂM TRA incomeCategories
					if (!Array.isArray(incomeCategories)) {
						console.warn("customIncomeCategories_v2 không phải mảng, dùng giá trị mặc định.");
						incomeCategories = [...defaultIncomeCategories]; // Sử dụng default nếu lỗi
						console.log("Fell back to defaultIncomeCategories (not array):", incomeCategories);
					} else if (incomeCategories.length === 0 || !incomeCategories.find(c => c.value === TRANSFER_CATEGORY_IN)) {
						console.warn("customIncomeCategories_v2 rỗng hoặc thiếu hạng mục chuyển tiền cần thiết, dùng giá trị mặc định.");
						incomeCategories = [...defaultIncomeCategories];
						console.log("Fell back to defaultIncomeCategories (empty or missing transfer):", incomeCategories);
					}
				} catch (error) {
					console.error("Lỗi khi parse customIncomeCategories_v2:", error);
					incomeCategories = [...defaultIncomeCategories];
					console.log("Fell back to defaultIncomeCategories (parse error):", incomeCategories);
				}
			} else { // Nếu không có gì trong localStorage, dùng default
				 console.log("Không tìm thấy customIncomeCategories_v2, sử dụng defaultIncomeCategories.");
				 incomeCategories = [...defaultIncomeCategories];
			}

			// --- LÀM TƯƠNG TỰ CHO expenseCategories --- (đoạn này bạn đã có, chỉ để tham khảo cấu trúc)
			const storedExpenseCategories = localStorage.getItem('customExpenseCategories_v2');
			expenseCategories = [];
			if (storedExpenseCategories) {
				try {
					expenseCategories = JSON.parse(storedExpenseCategories);
					console.log("Loaded customExpenseCategories_v2:", expenseCategories); // KIỂM TRA expenseCategories
					if (!Array.isArray(expenseCategories)) {
						console.warn("customExpenseCategories_v2 không phải mảng, dùng giá trị mặc định.");
						expenseCategories = [...defaultExpenseCategories];
						console.log("Fell back to defaultExpenseCategories (not array):", expenseCategories);
					} else if (expenseCategories.length === 0 || !expenseCategories.find(c => c.value === TRANSFER_CATEGORY_OUT)) {
						 console.warn("customExpenseCategories_v2 rỗng hoặc thiếu hạng mục chuyển tiền cần thiết, dùng giá trị mặc định.");
						expenseCategories = [...defaultExpenseCategories];
						console.log("Fell back to defaultExpenseCategories (empty or missing transfer):", expenseCategories);
					}
				} catch (error) {
					console.error("Lỗi khi parse customExpenseCategories_v2:", error);
					expenseCategories = [...defaultExpenseCategories];
					console.log("Fell back to defaultExpenseCategories (parse error):", expenseCategories);
				}
			} else {
				 console.log("Không tìm thấy customExpenseCategories_v2, sử dụng defaultExpenseCategories.");
				 expenseCategories = [...defaultExpenseCategories];
			}

			// --- LÀM TƯƠNG TỰ CHO accounts ---
			const storedAccounts = localStorage.getItem('customAccounts_v2');
			accounts = []; // Khởi tạo
			if (storedAccounts) {
				try {
					accounts = JSON.parse(storedAccounts);
					console.log("Loaded customAccounts_v2:", accounts); // KIỂM TRA accounts
					if (!Array.isArray(accounts) || accounts.length === 0) {
						console.warn("customAccounts_v2 không phải mảng hoặc rỗng, dùng giá trị mặc định.");
						accounts = [...defaultAccounts];
						console.log("Fell back to defaultAccounts (not array or empty):", accounts);
					}
				} catch (error) {
					console.error("Lỗi khi parse customAccounts_v2:", error);
					accounts = [...defaultAccounts];
					console.log("Fell back to defaultAccounts (parse error):", accounts);
				}
			} else {
				 console.log("Không tìm thấy customAccounts_v2, sử dụng defaultAccounts.");
				 accounts = [...defaultAccounts];
			}

			// Sau khi đã tải hoặc đặt lại tất cả, log ra trạng thái cuối cùng
			console.log("Dữ liệu cuối cùng sau khi tải (loadUserPreferences):", { transactions, incomeCategories, expenseCategories, accounts });
		}

        function saveUserPreferences() { localStorage.setItem('customIncomeCategories_v2', JSON.stringify(incomeCategories)); localStorage.setItem('customExpenseCategories_v2', JSON.stringify(expenseCategories)); localStorage.setItem('customAccounts_v2', JSON.stringify(accounts)); }
        function saveTransactions() { localStorage.setItem('transactions_v2', JSON.stringify(transactions)); }
        
        // --- CÁC HÀM RENDER (Giữ nguyên cấu trúc, logic hiển thị sẽ tự điều chỉnh theo giá trị số tiền mới) ---
        function renderAccountListAdmin() { if (!accountListAdminEl) return; accountListAdminEl.innerHTML = ''; accounts.forEach(acc => { const li = document.createElement('li'); li.textContent = acc.text; const deleteButton = document.createElement('button'); deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>Xóa`; deleteButton.classList.add('btn-delete', 'text-xs', 'px-2', 'py-1', 'ml-2'); deleteButton.onclick = () => { if (confirm(`Bạn có chắc muốn xóa tài khoản "${acc.text}" không? Lưu ý: Các giao dịch cũ liên quan đến tài khoản này sẽ không tự động cập nhật.`)) { accounts = accounts.filter(a => a.value !== acc.value); saveUserPreferences(); renderAccountListAdmin(); populateAccountDropdowns(); updateAccountBalances(); showMessage(`Đã xóa tài khoản "${acc.text}".`, 'success'); } }; li.appendChild(deleteButton); accountListAdminEl.appendChild(li); }); }
		function renderCategoryList(listElement, categoriesArray, type) { if (!listElement) return; listElement.innerHTML = ''; categoriesArray.forEach(cat => { const isSpecialTransferCategory = (cat.value === TRANSFER_CATEGORY_IN || cat.value === TRANSFER_CATEGORY_OUT); const li = document.createElement('li'); li.textContent = cat.text; if (!isSpecialTransferCategory) { const deleteButton = document.createElement('button'); deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>Xóa`; deleteButton.classList.add('btn-delete', 'text-xs', 'px-2', 'py-1', 'ml-2'); deleteButton.onclick = () => { if (confirm(`Bạn có chắc muốn xóa hạng mục "${cat.text}" không?`)) { if (type === 'income') incomeCategories = incomeCategories.filter(c => c.value !== cat.value); else expenseCategories = expenseCategories.filter(c => c.value !== cat.value); saveUserPreferences(); renderCustomCategoryLists(); populateCategories(); applyMainFilter(); } }; li.appendChild(deleteButton); } else { const lockIcon = document.createElement('span'); lockIcon.innerHTML = ` <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-lock-fill inline-block ml-2 text-gray-400" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>`; li.appendChild(lockIcon); } listElement.appendChild(li); }); }
        function renderCustomCategoryLists() { renderCategoryList(incomeCategoryListAdminEl, incomeCategories, 'income'); renderCategoryList(expenseCategoryListAdminEl, expenseCategories, 'expense'); }
        function addCategory(name, type) { if (!name || name.trim() === '') { showMessage('Tên hạng mục không được để trống.', 'error'); return false; } const newCategoryValue = name.trim(); const newCategory = { value: newCategoryValue, text: newCategoryValue }; if (type === 'income') { if (incomeCategories.some(cat => cat.value.toLowerCase() === newCategoryValue.toLowerCase())) { showMessage('Hạng mục thu này đã tồn tại.', 'error'); return false; } incomeCategories.push(newCategory); } else { if (expenseCategories.some(cat => cat.value.toLowerCase() === newCategoryValue.toLowerCase())) { showMessage('Hạng mục chi này đã tồn tại.', 'error'); return false; } expenseCategories.push(newCategory); } saveUserPreferences(); renderCustomCategoryLists(); populateCategories(); showMessage(`Đã thêm hạng mục "${newCategory.text}"!`, 'success'); return true; }
        function addAccount(name) { if (!name || name.trim() === '') { showMessage('Tên tài khoản không được để trống.', 'error'); return false; } const newAccountName = name.trim(); if (accounts.some(acc => acc.value.toLowerCase() === newAccountName.toLowerCase() || acc.text.toLowerCase() === newAccountName.toLowerCase())) { showMessage('Tài khoản này đã tồn tại.', 'error'); return false; } const newAccount = { value: newAccountName, text: newAccountName }; accounts.push(newAccount); saveUserPreferences(); renderAccountListAdmin(); populateAccountDropdowns(); updateAccountBalances(); showMessage(`Đã thêm tài khoản "${newAccount.text}"!`, 'success'); return true; }
        function populateAccountDropdowns() { if (!accountInput || !toAccountInput) return; const currentFromAccount = accountInput.value; const currentToAccount = toAccountInput.value; accountInput.innerHTML = ''; toAccountInput.innerHTML = ''; if (!accounts || accounts.length === 0) accounts = [...defaultAccounts]; accounts.forEach(acc => { accountInput.add(new Option(acc.text, acc.value)); toAccountInput.add(new Option(acc.text, acc.value)); }); if (accounts.some(acc => acc.value === currentFromAccount)) accountInput.value = currentFromAccount; else if (accounts.length > 0) accountInput.value = accounts[0].value; if (accounts.some(acc => acc.value === currentToAccount)) toAccountInput.value = currentToAccount; else if (accounts.length > 1) toAccountInput.value = accounts[1].value; else if (accounts.length > 0) toAccountInput.value = accounts[0].value; }
        function populateCategories() { if (!categoryInput) return; const selectedTypeRadio = document.querySelector('input[name="type"]:checked'); const selectedType = selectedTypeRadio ? selectedTypeRadio.value : 'Chi'; const currentCategoryValue = categoryInput.value; categoryInput.innerHTML = ''; let categoriesToPopulate = (selectedType === 'Thu') ? incomeCategories : expenseCategories; categoriesToPopulate = categoriesToPopulate.filter(cat => cat.value !== TRANSFER_CATEGORY_IN && cat.value !== TRANSFER_CATEGORY_OUT); if (!categoriesToPopulate || categoriesToPopulate.length === 0) { const defaultCats = (selectedType === 'Thu') ? [...defaultIncomeCategories] : [...defaultExpenseCategories]; categoriesToPopulate = defaultCats.filter(cat => cat.value !== TRANSFER_CATEGORY_IN && cat.value !== TRANSFER_CATEGORY_OUT); } categoriesToPopulate.forEach(category => categoryInput.add(new Option(category.text, category.value))); if (categoriesToPopulate.some(cat => cat.value === currentCategoryValue)) categoryInput.value = currentCategoryValue; else if (categoriesToPopulate.length > 0) categoryInput.value = categoriesToPopulate[0].value; }
		function toggleFormFields() {
			const selectedTypeRadio = document.querySelector('input[name="type"]:checked');
			const selectedType = selectedTypeRadio ? selectedTypeRadio.value : 'Chi'; // Mặc định là 'Chi' nếu không có gì được chọn

			// Lấy các element DOM của các container field
			// Đảm bảo rằng các class này tồn tại trong HTML của bạn
			const categoryFieldContainer = document.querySelector('.form-field-normal'); 
			const toAccountFieldContainer = document.querySelector('.form-field-transfer');

			// Kiểm tra xem các container có thực sự được tìm thấy không (để tránh lỗi)
			if (!categoryFieldContainer) {
				console.error("Lỗi: Không tìm thấy container cho trường Hạng mục (class 'form-field-normal').");
			}
			if (!toAccountFieldContainer) {
				console.error("Lỗi: Không tìm thấy container cho trường Đến Tài khoản (class 'form-field-transfer').");
			}

			// Cập nhật dataset trên form (đã có)
			if (transactionForm) { // Giả sử transactionForm là biến global trỏ đến form
			  transactionForm.dataset.transactionMode = selectedType;
			}


			if (selectedType === 'Transfer') {
				// Cập nhật label (đã có)
				if (accountLabel) accountLabel.textContent = 'Từ Tài khoản:'; // Giả sử accountLabel là biến global

				// Ẩn trường Hạng mục và bỏ yêu cầu
				if (categoryFieldContainer) categoryFieldContainer.style.display = 'none';
				if (categoryInput) categoryInput.removeAttribute('required'); // Giả sử categoryInput là biến global

				// Hiển thị trường Đến Tài khoản và đặt là bắt buộc
				if (toAccountFieldContainer) toAccountFieldContainer.style.display = 'block'; // Hoặc 'grid', 'flex' tùy theo layout của bạn
				if (toAccountInput) toAccountInput.setAttribute('required', ''); // Giả sử toAccountInput là biến global
				
			} else { // Cho 'Thu' hoặc 'Chi'
				// Cập nhật label (đã có)
				if (accountLabel) accountLabel.textContent = 'Tài khoản:';

				// Hiển thị trường Hạng mục và đặt là bắt buộc
				if (categoryFieldContainer) categoryFieldContainer.style.display = 'block'; // Hoặc 'grid', 'flex'
				if (categoryInput) categoryInput.setAttribute('required', '');

				// Ẩn trường Đến Tài khoản và bỏ yêu cầu
				if (toAccountFieldContainer) toAccountFieldContainer.style.display = 'none';
				if (toAccountInput) toAccountInput.removeAttribute('required');
				
				populateCategories(); // Gọi hàm điền lại danh mục cho Thu/Chi
			}
		}
		

        // --- HÀM XỬ LÝ SUBMIT GIAO DỊCH (CẬP NHẬT CÁCH LƯU originalAmount) ---
        function handleTransactionSubmit(e) {
            e.preventDefault();
            const datetimeValue = datetimeInput.value;
            const typeRadio = document.querySelector('input[name="type"]:checked');
            const type = typeRadio ? typeRadio.value : null;
            const amountRaw = amountTextInput.value; // Giá trị thô từ ô input
            const currency = formCurrencySelector.value; // Đơn vị tiền tệ người dùng chọn
            let categoryValue = (type !== 'Transfer') ? categoryInput.value : null;
            const accountValue = accountInput.value;
            const toAccountValue = (type === 'Transfer') ? toAccountInput.value : null;
            const descriptionValue = descriptionInput.value.trim();
            
            // --- Các kiểm tra đầu vào giữ nguyên ---
            if (!datetimeValue || !type || !amountRaw || !accountValue) { showMessage('Vui lòng điền đầy đủ các trường bắt buộc.', 'error'); return; }
            if (type !== 'Transfer' && !categoryValue) { showMessage('Vui lòng chọn hạng mục.', 'error'); return; }
            if (type === 'Transfer' && !toAccountValue) { showMessage('Vui lòng chọn tài khoản nhận cho giao dịch chuyển tiền.', 'error'); return; }
            if (type === 'Transfer' && accountValue === toAccountValue) { showMessage('Tài khoản chuyển và tài khoản nhận không được trùng nhau.', 'error'); return; }

            // parseAmountInput giờ sẽ trả về giá trị đầy đủ, không còn x1000
            let amount = parseAmountInput(amountRaw, currency); 
            if (isNaN(amount) || amount <= 0 && !(type === 'Transfer' && amount === 0) /*Cho phép chuyển 0đ nếu cần*/) { 
                // Điều chỉnh lại điều kiện amount <=0 nếu muốn cho phép giao dịch 0 đồng
                // Hiện tại đang là phải > 0
                 if (amount <= 0 && type !== 'Transfer') { // Chỉ cho phép chuyển tiền 0 đồng, thu/chi phải >0
                    showMessage('Số tiền không hợp lệ hoặc phải lớn hơn 0.', 'error'); return;
                 } else if (amount < 0) { // Không cho phép số tiền âm
                    showMessage('Số tiền không được là số âm.', 'error'); return;
                 }
            }

            const transactionDateTime = formatIsoDateTime(new Date(datetimeValue));
            const persistedTransactionType = type; // Loại giao dịch thực tế (Thu/Chi/Transfer)

            // Giá trị số hóa từ ô input, trước khi quy đổi USD (nếu có)
            // Sẽ được lưu vào originalAmount
            const rawNumericValue = parseFloat(normalizeAmountString(amountRaw)); 
            if(isNaN(rawNumericValue)){
                showMessage('Số tiền nhập vào không hợp lệ.', 'error'); return;
            }


            if (editingTransactionId) {
                // ... (Phần logic sửa giao dịch của bạn giữ nguyên cấu trúc)
                // Chỉ cần đảm bảo các trường amount, originalAmount, originalCurrency được cập nhật đúng
                const existingTransactionIndex = transactions.findIndex(t => t.id === editingTransactionId || (t.isTransfer && (t.id.startsWith(editingTransactionId) || t.transferPairId.startsWith(editingTransactionId))));
                if (existingTransactionIndex === -1 && type !== 'Transfer') { showMessage('Lỗi: Giao dịch gốc để sửa không tìm thấy.', 'error'); editingTransactionId = null; return; }
                
                // Xóa giao dịch cũ để thêm lại bản cập nhật
                if (transactions.find(t => t.id.startsWith(editingTransactionId) && t.isTransfer) || type === 'Transfer') { transactions = transactions.filter(t => !t.id.startsWith(editingTransactionId) && !(t.transferPairId && t.transferPairId.startsWith(editingTransactionId))); } else if (existingTransactionIndex !== -1) { transactions.splice(existingTransactionIndex, 1); }
                
                const baseId = editingTransactionId; // Giữ lại ID gốc nếu là sửa
                if (type === 'Transfer') {
                    categoryValue = null;
                    const transferOutId = `${baseId}_out_edited_${Date.now()}`;
                    const transferInId = `${baseId}_in_edited_${Date.now()}`;
                    transactions.push({ id: transferOutId, datetime: transactionDateTime, description: descriptionValue || `Chuyển tiền từ ${accountValue} đến ${toAccountValue}`, category: TRANSFER_CATEGORY_OUT, amount, type: 'Chi', account: accountValue, currency: 'VND', isTransfer: true, transferPairId: transferInId, originalAmount: rawNumericValue, originalCurrency: currency });
                    transactions.push({ id: transferInId, datetime: transactionDateTime, description: descriptionValue || `Nhận tiền từ ${accountValue} vào ${toAccountValue}`, category: TRANSFER_CATEGORY_IN, amount, type: 'Thu', account: toAccountValue, currency: 'VND', isTransfer: true, transferPairId: transferOutId, originalAmount: rawNumericValue, originalCurrency: currency });
                    showMessage('Giao dịch chuyển tiền đã được cập nhật!', 'success');
                } else {
                    transactions.push({ id: baseId, datetime: transactionDateTime, description: descriptionValue, category: categoryValue, amount, type, account: accountValue, currency: 'VND', isTransfer: false, transferPairId: null, originalAmount: rawNumericValue, originalCurrency: currency });
                    showMessage(`Giao dịch ${type === 'Thu' ? 'thu' : 'chi'} đã được cập nhật!`, 'success');
                }
                editingTransactionId = null;
            } else { // Thêm giao dịch mới
                const newIdBase = Date.now().toString();
                if (type === 'Transfer') {
                    const transferOutId = `${newIdBase}_out`;
                    const transferInId = `${newIdBase}_in`;
                    transactions.push({ id: transferOutId, datetime: transactionDateTime, description: descriptionValue || `Chuyển tiền từ ${accountValue} đến ${toAccountValue}`, category: TRANSFER_CATEGORY_OUT, amount, type: 'Chi', account: accountValue, currency: 'VND', isTransfer: true, transferPairId: transferInId, originalAmount: rawNumericValue, originalCurrency: currency });
                    transactions.push({ id: transferInId, datetime: transactionDateTime, description: descriptionValue || `Nhận tiền từ ${accountValue} vào ${toAccountValue}`, category: TRANSFER_CATEGORY_IN, amount, type: 'Thu', account: toAccountValue, currency: 'VND', isTransfer: true, transferPairId: transferOutId, originalAmount: rawNumericValue, originalCurrency: currency });
                    showMessage('Giao dịch chuyển tiền đã được thêm!', 'success');
                } else {
                    transactions.push({ id: newIdBase, datetime: transactionDateTime, description: descriptionValue, category: categoryValue, amount, type, account: accountValue, currency: 'VND', isTransfer: false, transferPairId: null, originalAmount: rawNumericValue, originalCurrency: currency });
                    showMessage(`Giao dịch ${type === 'Thu' ? 'thu' : 'chi'} đã được thêm!`, 'success');
                }
            }
            saveTransactions();
            populateMonthFilter(); // Cập nhật bộ lọc tháng (nếu có tháng mới)
            applyMainFilter();     // Áp dụng lại bộ lọc và render lại tất cả
            resetForm(persistedTransactionType); // Reset form, giữ lại loại giao dịch vừa chọn
        }
        
	// --- HÀM RESET FORM (Cập nhật để giữ lại lựa chọn tài khoản) ---
	function resetForm(persistedType = null) {
	    // Lưu lại giá trị tài khoản đã chọn trước khi reset
	    const previousAccountValue = accountInput.value;
	    const previousToAccountValue = toAccountInput.value; // Sẽ là '' nếu không phải transfer
	
	    transactionForm.reset(); // Reset các trường input cơ bản
	    setDefaultDateTime();    // Đặt lại ngày giờ về hiện tại
	    formCurrencySelector.value = 'VND'; // Đặt lại đơn vị tiền tệ
	
	    // Khôi phục loại giao dịch (Thu/Chi/Transfer) nếu được truyền vào
	    if (persistedType) {
	        const radioToSelect = document.querySelector(`input[name="type"][value="${persistedType}"]`);
	        if (radioToSelect) {
	            radioToSelect.checked = true;
	        }
	    } else {
	        // Mặc định chọn "Chi" nếu không có persistedType
	        const typeChiRadio = document.getElementById('type-chi');
	        if (typeChiRadio) typeChiRadio.checked = true;
	    }
	
	    editingTransactionId = null; // Reset ID đang sửa
	    // Cập nhật tiêu đề form và nút submit về trạng thái "Thêm mới"
	    if (formTitleEl) formTitleEl.textContent = 'Thêm Giao Dịch Mới';
	    if (submitButton) {
	        submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Thêm Giao Dịch';
	    }
	
	    toggleFormFields(); // Cập nhật hiển thị các trường dựa trên loại giao dịch
	    
	    // Điền lại danh sách tài khoản và cố gắng khôi phục lựa chọn trước đó
	    populateAccountDropdowns(); // Hàm này sẽ điền các options
	
	    // Cố gắng khôi phục giá trị tài khoản đã chọn
	    if (accountInput && Array.from(accountInput.options).some(opt => opt.value === previousAccountValue)) {
	        accountInput.value = previousAccountValue;
	    }
	    // Nếu là giao dịch chuyển tiền và giá trị "Đến tài khoản" trước đó hợp lệ
	    if (document.querySelector('input[name="type"]:checked')?.value === 'Transfer' && 
	        toAccountInput && 
	        Array.from(toAccountInput.options).some(opt => opt.value === previousToAccountValue)) {
	        toAccountInput.value = previousToAccountValue;
	    }
	
	
	    // Điền lại danh mục nếu không phải là giao dịch chuyển tiền
	    // và giữ lại lựa chọn hạng mục nếu có thể (tùy thuộc vào việc bạn có muốn giữ lại hạng mục không)
	    // Hiện tại, populateCategories sẽ chọn hạng mục đầu tiên của loại giao dịch mới.
	    // Nếu bạn muốn giữ lại hạng mục, cần logic tương tự như giữ lại tài khoản.
	    const currentTransactionType = document.querySelector('input[name="type"]:checked');
	    if (currentTransactionType && currentTransactionType.value !== 'Transfer') {
	        populateCategories(); // Điều này sẽ chọn hạng mục đầu tiên cho loại Thu/Chi
	    }
	    
	    // Đặt lại focus vào trường đầu tiên hoặc trường số tiền (tùy chọn)
	    // datetimeInput.focus(); 
	    // Hoặc
	    // amountTextInput.focus();
	}

        function getMonthDisplayText(selectedMonthValue, withParentheses = true) {
            let text;
            if (selectedMonthValue === 'all' || !selectedMonthValue) {
                text = "Tất cả";
            } else {
                const parts = selectedMonthValue.split('-');
                if (parts.length === 2) {
                    const [year, month] = parts;
                    text = `Tháng ${month}/${year}`;
                } else {
                    text = "Đã chọn";
                }
            }
            return withParentheses ? `(${text})` : text;
        }

        // --- HÀM SỬA GIAO DỊCH (CẬP NHẬT CÁCH ĐIỀN `amountTextInput`) ---
        window.loadTransactionForEdit = function(transactionId) {
            let transactionToEdit = transactions.find(t => t.id === transactionId);
            let baseIdForEdit = transactionId; // ID cơ sở để chỉnh sửa

            if (!transactionToEdit) { // Có thể là một phần của giao dịch chuyển tiền
                const transferPart = transactions.find(t => t.isTransfer && (t.id === transactionId || t.transferPairId === transactionId));
                if (transferPart) {
                    baseIdForEdit = transferPart.id.split('_')[0]; // Lấy ID gốc của cặp chuyển tiền
                    // Tìm cả hai phần của giao dịch chuyển tiền dựa trên baseIdForEdit
                    const outTx = transactions.find(t => t.id.startsWith(baseIdForEdit) && t.type === 'Chi' && t.isTransfer);
                    const inTx = transactions.find(t => t.id.startsWith(baseIdForEdit) && t.type === 'Thu' && t.isTransfer);
                    if (outTx && inTx) {
                        transactionToEdit = outTx; // Dùng outTx làm cơ sở để điền form, vì nó chứa tài khoản nguồn
                        datetimeInput.value = formatDateTimeLocalInput(new Date(outTx.datetime));
                        document.getElementById('type-transfer').checked = true;
                        
                        // QUAN TRỌNG: Điền vào ô input số tiền giá trị originalAmount (là giá trị thô người dùng đã nhập)
                        amountTextInput.value = String(outTx.originalAmount); 
                        formCurrencySelector.value = outTx.originalCurrency; // Đơn vị tiền tệ gốc khi nhập

                        descriptionInput.value = outTx.description.startsWith("Chuyển tiền từ") ? outTx.description : (inTx.description.startsWith("Nhận tiền từ") ? inTx.description : outTx.description);
                        accountInput.value = outTx.account;
                        toAccountInput.value = inTx.account;
                    } else {
                        showMessage('Lỗi: Không tìm thấy đủ thông tin giao dịch chuyển tiền để sửa.', 'error'); return;
                    }
                } else {
                    showMessage('Lỗi: Không tìm thấy giao dịch.', 'error'); return;
                }
            } else { // Giao dịch thu/chi thông thường
                datetimeInput.value = formatDateTimeLocalInput(new Date(transactionToEdit.datetime));
                document.querySelector(`input[name="type"][value="${transactionToEdit.type}"]`).checked = true;
                
                // QUAN TRỌNG: Điền vào ô input số tiền giá trị originalAmount
                amountTextInput.value = String(transactionToEdit.originalAmount);
                formCurrencySelector.value = transactionToEdit.originalCurrency;

                descriptionInput.value = transactionToEdit.description;
                accountInput.value = transactionToEdit.account;
                if (transactionToEdit.type !== 'Transfer') categoryInput.value = transactionToEdit.category;
            }

            editingTransactionId = baseIdForEdit; // Lưu ID cơ sở để submit biết là đang sửa
            formTitleEl.textContent = 'Sửa Giao Dịch';
            submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>Lưu Thay Đổi`;
            toggleFormFields(); // Quan trọng để hiện/ẩn đúng trường cho loại giao dịch
            populateAccountDropdowns(); // Tải lại danh sách tài khoản
            if (document.querySelector('input[name="type"]:checked').value !== 'Transfer') {
                populateCategories(); // Tải lại danh mục nếu không phải chuyển tiền
                if(transactionToEdit && transactionToEdit.type !== 'Transfer') categoryInput.value = transactionToEdit.category;
            }
            const formSection = document.querySelector('.form-section .collapsible-header');
            if(formSection && !formSection.classList.contains('active')) formSection.click();
            formSection.scrollIntoView({ behavior: 'smooth' });
        }

        // --- CÁC HÀM RENDER, UPDATE CHARTS, FILTER (Giữ nguyên logic, chúng sẽ dùng giá trị `amount` đã đúng) ---
        window.deleteTransaction = function(transactionId) { if (!confirm('Bạn có chắc muốn xóa giao dịch này?')) return; const transactionToDelete = transactions.find(t => t.id === transactionId); if (transactionToDelete && transactionToDelete.isTransfer) { transactions = transactions.filter(t => t.id !== transactionToDelete.id && t.transferPairId !== transactionToDelete.id); } else { const baseIdMatch = transactionId.match(/^(\d+)(_out|_in)?$/); if(baseIdMatch && baseIdMatch[1]){ const baseId = baseIdMatch[1]; transactions = transactions.filter(t => !t.id.startsWith(baseId) && !(t.transferPairId && t.transferPairId.startsWith(baseId))); } else { transactions = transactions.filter(t => t.id !== transactionId); } } saveTransactions(); applyMainFilter(); showMessage('Đã xóa giao dịch.', 'success'); }

        function renderMainTransactions(txsToRender = transactions) {
            transactionList.innerHTML = '';
            if (txsToRender.length === 0) { noTransactionsMessage.style.display = 'block'; return; }
            noTransactionsMessage.style.display = 'none';
            txsToRender.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            txsToRender.forEach(tx => {
                const row = transactionList.insertRow();
                row.insertCell().textContent = formatDisplayDateTime(tx.datetime);
                let displayDescription = tx.description;
                let displayCategory = tx.category;
                let displayAccount = accounts.find(a => a.value === tx.account)?.text || tx.account;
                if (tx.isTransfer) {
                    const pair = transactions.find(p => p.id === tx.transferPairId);
                    const pairAccountName = pair ? (accounts.find(a => a.value === pair.account)?.text || pair.account) : 'N/A';
                    if (tx.type === 'Chi') { displayDescription = displayDescription || `Chuyển đến ${pairAccountName}`; }
                    else { displayDescription = displayDescription || `Nhận từ ${pairAccountName}`; }
                }
                row.insertCell().textContent = displayDescription;
                row.insertCell().textContent = displayCategory;
                const amountCell = row.insertCell();
                const vndAmountFormatted = formatCurrency(tx.amount);
                if (tx.originalCurrency === 'USD' && typeof tx.originalAmount === 'number') {
                    const originalUsdFormatted = formatCurrency(tx.originalAmount, 'USD');
                    amountCell.innerHTML = `${vndAmountFormatted} <span class="text-xs text-gray-500 block sm:inline ml-1">(${originalUsdFormatted} gốc)</span>`;
                } else {
                    amountCell.textContent = vndAmountFormatted;
                }
                amountCell.classList.add(tx.type === 'Thu' ? 'text-green-600' : 'text-red-600');
                row.insertCell().textContent = tx.type === 'Thu' ? 'Thu Nhập' : (tx.type === 'Chi' ? 'Chi Tiêu' : 'Chuyển Tiền');
                row.insertCell().textContent = displayAccount;
                const actionsCell = row.insertCell();
                actionsCell.classList.add('text-center');
                const editBtn = document.createElement('button');
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square mr-1" viewBox="0 0 16 16"> <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/> <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/> </svg>Sửa`;
                editBtn.classList.add('btn-edit');
                const editId = tx.isTransfer ? tx.id.split('_')[0] : tx.id;
                editBtn.onclick = () => loadTransactionForEdit(editId);
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>Xóa`;
                deleteBtn.classList.add('btn-delete');
                const deleteId = tx.isTransfer ? tx.id.split('_')[0] : tx.id;
                deleteBtn.onclick = () => deleteTransaction(deleteId);
                actionsCell.appendChild(editBtn); actionsCell.appendChild(deleteBtn);
            });
        }

        function updateAllSummariesAndCharts(transactionsToAnalyze = transactions) { updateMainSummaryAndChart(transactionsToAnalyze); renderExpenseCategoryChartAndList(transactionsToAnalyze); updateAccountBalances(); renderLast7DaysChart(); renderMonthComparisonChart(); }
		function updateMainSummaryAndChart(summaryTransactionsToUse = transactions, monthForDisplay = (filterMonthSelect ? filterMonthSelect.value : 'all')) {
			// summaryTransactionsToUse: là mảng giao dịch đã được lọc (thường bởi bộ lọc tháng chung).
			// monthForDisplay: là tháng được chọn từ bộ lọc tháng chung (ví dụ: "2025-05" hoặc "all").
			//                  Tham số này có thể không cần thiết nếu hàm này chỉ cập nhật biểu đồ
			//                  và tiêu đề biểu đồ được cập nhật ở nơi khác (như trong applyMainFilter).

			let totalIncome = 0;
			let totalExpenses = 0;

			// Đảm bảo summaryTransactionsToUse là một mảng trước khi lặp
			if (typeof summaryTransactionsToUse !== 'undefined' && Array.isArray(summaryTransactionsToUse)) {
				summaryTransactionsToUse.forEach(tx => {
					if (tx.type === 'Thu') totalIncome += tx.amount;
					else if (tx.type === 'Chi') totalExpenses += tx.amount;
				});
			} else {
				console.warn("updateMainSummaryAndChart: summaryTransactionsToUse không phải là mảng hoặc không được định nghĩa. Đặt lại thành 0.");
				// totalIncome và totalExpenses sẽ giữ giá trị 0 đã khởi tạo
			}

			// Cập nhật BIỂU ĐỒ CHUNG "Thu vs Chi" (nếu có)
			// Giả sử bạn có hàm renderOrUpdateMainChart và biến incomeExpenseChartCanvas đã được khai báo toàn cục
			if (typeof renderOrUpdateMainChart === 'function' && incomeExpenseChartCanvas) {
				renderOrUpdateMainChart(totalIncome, totalExpenses);
			} else {
				// console.warn("updateMainSummaryAndChart: renderOrUpdateMainChart function or incomeExpenseChartCanvas is not available.");
			}

			// --- CÁC DÒNG SAU ĐÂY ĐÃ BỊ XÓA HOẶC VÔ HIỆU HÓA ---
			// Lý do: Phần cập nhật text của "Tóm tắt tài chính" giờ đây do hàm 'updateSummarySectionText'
			// (được điều khiển bởi menu 'summary-filter-month') đảm nhiệm.

			// const selectedMonthValue = filterMonthSelect.value; // Không dùng trực tiếp filterMonthSelect.value ở đây nữa nếu dùng monthForDisplay
			// const monthDisplayTextForLabels = getMonthDisplayText(monthForDisplay, true);

			// const summaryIncomeMonthDisplayEl = document.getElementById('summary-income-month-display');
			// if (summaryIncomeMonthDisplayEl) summaryIncomeMonthDisplayEl.textContent = monthDisplayTextForLabels;

			// const summaryExpenseMonthDisplayEl = document.getElementById('summary-expense-month-display');
			// if (summaryExpenseMonthDisplayEl) summaryExpenseMonthDisplayEl.textContent = monthDisplayTextForLabels;

			// const summaryBalanceMonthDisplayEl = document.getElementById('summary-balance-month-display');
			// if (summaryBalanceMonthDisplayEl) summaryBalanceMonthDisplayEl.textContent = monthDisplayTextForLabels;

			// if (totalIncomeEl) totalIncomeEl.textContent = formatCurrency(totalIncome);
			// if (totalExpensesEl) totalExpensesEl.textContent = formatCurrency(totalExpenses);
			// if (currentBalanceEl) {
			//     currentBalanceEl.textContent = formatCurrency(totalIncome - totalExpenses);
			//     currentBalanceEl.className = (totalIncome - totalExpenses >= 0) ? 'text-blue-600 font-bold' : 'text-red-600 font-bold';
			// }
		}
		

		function updateSummarySectionText(summaryTransactions, monthForDisplay) {
			let totalIncome = 0;
			let totalExpenses = 0;

			if (typeof summaryTransactions !== 'undefined' && Array.isArray(summaryTransactions)) {
				summaryTransactions.forEach(tx => {
					if (tx.type === 'Thu') totalIncome += tx.amount;
					else if (tx.type === 'Chi') totalExpenses += tx.amount;
				});
			}

			const monthDisplayTextForLabels = getMonthDisplayText(monthForDisplay, true);

			// Sử dụng các biến DOM toàn cục đã khai báo
			if (summaryIncomeMonthDisplayEl) summaryIncomeMonthDisplayEl.textContent = monthDisplayTextForLabels;
			if (summaryExpenseMonthDisplayEl) summaryExpenseMonthDisplayEl.textContent = monthDisplayTextForLabels;
			if (summaryBalanceMonthDisplayEl) summaryBalanceMonthDisplayEl.textContent = monthDisplayTextForLabels;

			if (totalIncomeEl) totalIncomeEl.textContent = formatCurrency(totalIncome);
			if (totalExpensesEl) totalExpensesEl.textContent = formatCurrency(totalExpenses);

			if (currentBalanceEl) {
				const balance = totalIncome - totalExpenses;
				currentBalanceEl.textContent = formatCurrency(balance);
				let balanceClasses = 'font-bold';
				if (balance >= 0) {
					balanceClasses += ' text-blue-600 dark:text-blue-400';
				} else {
					balanceClasses += ' text-red-600 dark:text-red-400';
				}
				currentBalanceEl.className = balanceClasses;
			}
		}

        function renderOrUpdateMainChart(income, expenses) { const data = { labels: ['Tổng Thu', 'Tổng Chi'], datasets: [{ label: 'Số tiền (VNĐ)', data: [income, expenses], backgroundColor: [categoryColors[1], categoryColors[0]], }] }; if (incomeExpenseChart) { incomeExpenseChart.data = data; incomeExpenseChart.update(); } else { incomeExpenseChart = new Chart(incomeExpenseChartCanvas, { type: 'bar', data, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } } } }); } }

		function renderExpenseCategoryChartAndList(transactionsToAnalyze = transactions) {
			const expenseTransactions = transactionsToAnalyze.filter(t => t.type === 'Chi' && !t.isTransfer);
			const expenseByCategory = {};
			let totalExpensesInFilteredPeriod = 0; // Đổi tên biến để rõ ràng hơn

			expenseTransactions.forEach(tx => {
				const category = tx.category || "Chưa phân loại"; // Xử lý hạng mục null/undefined
				expenseByCategory[category] = (expenseByCategory[category] || 0) + tx.amount;
				totalExpensesInFilteredPeriod += tx.amount;
			});

			// Xử lý khi không có dữ liệu chi tiêu để vẽ biểu đồ
			if (totalExpensesInFilteredPeriod === 0) {
				if (expensePieChartContainer) expensePieChartContainer.style.display = 'none';
				if (expenseBarChartContainer) expenseBarChartContainer.style.display = 'none';
				if (noExpenseDataChartEl) noExpenseDataChartEl.style.display = 'block';

				if (expenseCategoryChart) { expenseCategoryChart.destroy(); expenseCategoryChart = null; }
				if (expenseCategoryBarChart) { expenseCategoryBarChart.destroy(); expenseCategoryBarChart = null; }

				// Xử lý danh sách chi tiết (có thể bạn đã có)
				if (expenseCategoryListContainerEl) expenseCategoryListContainerEl.innerHTML = ''; // Hoặc hiển thị thông báo
				if (noExpenseDataListEl) noExpenseDataListEl.style.display = 'block';
				return;
			}

			// Nếu có dữ liệu, ẩn thông báo "không có dữ liệu"
			if (noExpenseDataChartEl) noExpenseDataChartEl.style.display = 'none';
			if (noExpenseDataListEl) noExpenseDataListEl.style.display = 'none';

			const sortedCategoriesArray = Object.entries(expenseByCategory).sort(([, a], [, b]) => b - a);
			const categoryLabels = sortedCategoriesArray.map(entry => entry[0]);
			const categoryData = sortedCategoriesArray.map(entry => entry[1]);
			const backgroundColors = categoryLabels.map((_, i) => categoryColors[i % categoryColors.length]);

			// Lấy các giá trị màu sắc dựa trên theme hiện tại (nên được định nghĩa trong updateAllChartColorsForTheme và truyền vào hoặc lấy từ đó)
			const currentThemeIsDark = document.body.classList.contains(DARK_MODE_CLASS);
			const pieBorderColor = '#FFFFFF'; // <-- LUÔN LÀ MÀU TRẮNG
			const legendAndTickColor = currentThemeIsDark ? '#9ca3af' : '#6b7280';
			const gridLineColor = currentThemeIsDark ? 'rgba(107, 114, 128, 0.2)' : 'rgba(209, 213, 219, 0.5)';
			const datalabelPieColor = '#ffffff';
			const datalabelBarColor = currentThemeIsDark ? '#e0e0e0' : '#333333';

			// 1. BIỂU ĐỒ TRÒN (PIE/DOUGHNUT)
			const pieChartData = {
				labels: categoryLabels,
				datasets: [{
					data: categoryData,
					backgroundColor: backgroundColors,
					borderColor: pieBorderColor, // <--- THUỘC TÍNH CẦN THAY ĐỔI
					borderWidth: 2 // Bạn có thể điều chỉnh độ dày của viền ở đây
				}]
			};
			
			const pieChartOptions = {
				responsive: true, maintainAspectRatio: false,
				plugins: {
					legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15, color: legendAndTickColor } },
					tooltip: {
						callbacks: {
							label: function(context) {
								let label = context.label || '';
								if (label) { label += ': '; }
								const value = context.raw;
								label += formatCurrency(value, 'VND');
								if (totalExpensesInFilteredPeriod > 0) {
									const percentage = (value / totalExpensesInFilteredPeriod * 100).toFixed(1);
									label += ` (${percentage}%)`;
								}
								return label;
							}
						}
					},
					datalabels: {
						formatter: (value, ctx) => {
							if (totalExpensesInFilteredPeriod === 0) return '';
							const percentage = (value / totalExpensesInFilteredPeriod) * 100;
							return percentage > 5 ? percentage.toFixed(0) + '%' : '';
						},
						color: datalabelPieColor, font: { weight: 'bold' }
					}
				}
			};

			if (expenseCategoryChart) {
				expenseCategoryChart.data = pieChartData;
				expenseCategoryChart.options.plugins.legend.labels.color = legendAndTickColor;
				expenseCategoryChart.data.datasets[0].borderColor = pieBorderColor; // Quan trọng khi theme thay đổi
				expenseCategoryChart.options.plugins.datalabels.color = datalabelPieColor; // Cập nhật màu datalabel
				expenseCategoryChart.update();
			} else {
				if (expenseCategoryChartCanvas) { // Chỉ tạo nếu canvas tồn tại
					 expenseCategoryChart = new Chart(expenseCategoryChartCanvas, { type: 'doughnut', data: pieChartData, options: pieChartOptions, plugins: [ChartDataLabels] });
				} else {
					console.error("Canvas for expenseCategoryChart not found!");
				}
			}

			// 2. BIỂU ĐỒ CỘT NGANG (BAR)
			const barChartData = {
				labels: categoryLabels,
				datasets: [{
					label: 'Số tiền chi', data: categoryData, backgroundColor: backgroundColors,
					borderColor: backgroundColors, // Hoặc màu đậm hơn: backgroundColors.map(c => Chart.helpers.color(c).darken(0.1).rgbString()) - API cũ
					borderWidth: 1
				}]
			};
			const barChartOptions = {
				indexAxis: 'y', responsive: true, maintainAspectRatio: false,
				scales: {
					x: {
						beginAtZero: true, title: { display: true, text: 'Số tiền (VNĐ)', color: legendAndTickColor },
						ticks: { callback: function(value) { return formatCurrency(value, 'VND').replace(/\s*VNĐ$/, ''); }, color: legendAndTickColor },
						grid: { color: gridLineColor }
					},
					y: {
						ticks: { color: legendAndTickColor },
						grid: { display: false }
					}
				},
				plugins: {
					legend: { display: false },
					tooltip: {
						callbacks: { /* ... như trên ... */ }
					},
					datalabels: {
						anchor: 'end', align: 'end', formatter: (value) => formatCurrency(value, 'VND'),
						color: datalabelBarColor, font: { weight: 'bold', size: 10 }, padding: { left: 4 }
					}
				}
			};

			if (expenseCategoryBarChart) {
				expenseCategoryBarChart.data = barChartData;
				// Cập nhật các màu sắc options
				expenseCategoryBarChart.options.scales.x.title.color = legendAndTickColor;
				expenseCategoryBarChart.options.scales.x.ticks.color = legendAndTickColor;
				expenseCategoryBarChart.options.scales.x.grid.color = gridLineColor;
				expenseCategoryBarChart.options.scales.y.ticks.color = legendAndTickColor;
				expenseCategoryBarChart.options.plugins.datalabels.color = datalabelBarColor;
				expenseCategoryBarChart.update();
			} else {
				if (expenseCategoryBarCtx) { // Chỉ tạo nếu context tồn tại
					expenseCategoryBarChart = new Chart(expenseCategoryBarCtx, { type: 'bar', data: barChartData, options: barChartOptions, plugins: [ChartDataLabels] });
				} else {
					console.error("Canvas context for expenseCategoryBarChart not found!");
				}
			}

			// Cập nhật danh sách chi tiết (giữ nguyên logic của bạn, đảm bảo dùng sortedCategoriesArray)
			if(expenseCategoryListContainerEl && totalExpensesInFilteredPeriod > 0) {
				expenseCategoryListContainerEl.innerHTML = '';
				let listHTML = '<ul class="space-y-2">';
				sortedCategoriesArray.forEach(([label, amount], index) => {
					const percentage = (amount / totalExpensesInFilteredPeriod * 100).toFixed(1);
					const color = backgroundColors[index % backgroundColors.length];
					listHTML += `<li class="flex justify-between items-center text-sm">
									<div class="flex items-center">
										<span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
										<span>${label}</span>
									</div>
									<div class="text-right">
										<span class="font-semibold">${formatCurrency(amount)}</span>
										<span class="text-gray-500 dark:text-gray-400 ml-2">(${percentage}%)</span>
									</div>
								 </li>`;
				});
				listHTML += '</ul>';
				expenseCategoryListContainerEl.innerHTML = listHTML;
			} else if (expenseCategoryListContainerEl) {
				expenseCategoryListContainerEl.innerHTML = ''; // Xóa nếu không có data
			}

			toggleExpenseChartDisplay(); // Gọi để hiển thị đúng biểu đồ
		}

        function updateAccountBalances() {
            accountBalanceListEl.innerHTML = '<h3>Số Dư Theo Tài Khoản (Tổng thể - VNĐ):</h3>'; const balances = {};
            accounts.forEach(acc => balances[acc.value] = 0);
            transactions.forEach(tx => { if (balances[tx.account] !== undefined) { if (tx.type === 'Thu') balances[tx.account] += tx.amount; else if (tx.type === 'Chi') balances[tx.account] -= tx.amount; } });
            Object.keys(balances).forEach(accValue => {
                const acc = accounts.find(a => a.value === accValue);
                if (acc) {
                    const balanceItem = document.createElement('div');
                    balanceItem.classList.add('summary-item');
                    balanceItem.innerHTML = `<span>${acc.text}: </span><span class="${balances[accValue] >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(balances[accValue])}</span>`;
                    accountBalanceListEl.appendChild(balanceItem);
                }
            });
        }

        function getPastDate(daysAgo) { const date = new Date(); date.setDate(date.getDate() - daysAgo); date.setHours(0, 0, 0, 0); return date; }
        function renderLast7DaysChart() { const today = new Date(); today.setHours(23,59,59,999); const sevenDaysAgo = getPastDate(6); const dailyExpenses = {}; const labels = []; for (let i = 0; i < 7; i++) { const d = new Date(sevenDaysAgo); d.setDate(d.getDate() + i); const dateString = d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }); labels.push(dateString); dailyExpenses[dateString] = 0; } transactions.filter(tx => { const txDate = new Date(tx.datetime); return tx.type === 'Chi' && txDate >= sevenDaysAgo && txDate <= today; }).forEach(tx => { const dateString = new Date(tx.datetime).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }); if (dailyExpenses[dateString] !== undefined) dailyExpenses[dateString] += tx.amount; }); const dataValues = labels.map(label => dailyExpenses[label]); const data = { labels: labels, datasets: [{ label: 'Chi tiêu hàng ngày (VNĐ)', data: dataValues, borderColor: categoryColors[3], backgroundColor: 'transparent', tension: 0.1, fill: false }] }; if (last7DaysChart) { last7DaysChart.data = data; last7DaysChart.update(); } else { last7DaysChart = new Chart(last7DaysChartCanvas, { type: 'line', data, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } } } }); } }
        function renderMonthComparisonChart() { const currentMonthFilter = filterMonthSelect.value; if (!currentMonthFilter || currentMonthFilter === 'all') return; const [currentYear, currentMonthNum] = currentMonthFilter.split('-').map(Number); let prevYear = currentYear; let prevMonthNum = currentMonthNum - 1; if (prevMonthNum === 0) { prevMonthNum = 12; prevYear--; } const prevMonthFilter = `${prevYear}-${String(prevMonthNum).padStart(2, '0')}`; let currentMonthIncome = 0, currentMonthExpenses = 0, prevMonthIncome = 0, prevMonthExpenses = 0; transactions.forEach(tx => { const txMonth = tx.datetime.substring(0, 7); if (txMonth === currentMonthFilter) { if (tx.type === 'Thu') currentMonthIncome += tx.amount; else if (tx.type === 'Chi') currentMonthExpenses += tx.amount; } else if (txMonth === prevMonthFilter) { if (tx.type === 'Thu') prevMonthIncome += tx.amount; else if (tx.type === 'Chi') prevMonthExpenses += tx.amount; } }); const data = { labels: ['Tháng Trước', 'Tháng Này'], datasets: [ { label: 'Tổng Thu', data: [prevMonthIncome, currentMonthIncome], backgroundColor: categoryColors[1] }, { label: 'Tổng Chi', data: [prevMonthExpenses, currentMonthExpenses], backgroundColor: categoryColors[0] } ] }; if (monthComparisonChart) { monthComparisonChart.data = data; monthComparisonChart.update(); } else { monthComparisonChart = new Chart(monthComparisonChartCanvas, { type: 'bar', data, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', plugins: { datalabels: { display: false } } } }); } }
		function updateDetailedStatisticsTable(transactionsToAnalyze) {
			let totalIncome = 0;
			let totalExpense = 0;
			let incomeTxCount = 0;
			let expenseTxCount = 0;
			const nonTransferExpenseByCategory = {}; // Để tính hạng mục chi nhiều nhất không bao gồm chuyển tiền

			transactionsToAnalyze.forEach(tx => {
				if (tx.type === 'Thu') {
					totalIncome += tx.amount;
					incomeTxCount++;
				} else if (tx.type === 'Chi') {
					totalExpense += tx.amount; // Tổng chi vẫn tính cả tiền chuyển đi
					expenseTxCount++;
					// Chỉ tính vào nonTransferExpenseByCategory nếu đó là chi tiêu thực tế (không phải isTransfer)
					if (tx.category && !tx.isTransfer) {
						nonTransferExpenseByCategory[tx.category] = (nonTransferExpenseByCategory[tx.category] || 0) + tx.amount;
					}
				}
			});

			const netCashflow = totalIncome - totalExpense;

			let topExpenseCategoryName = '-';
			let topExpenseCategoryAmount = 0;

			if (Object.keys(nonTransferExpenseByCategory).length > 0) {
				topExpenseCategoryName = Object.keys(nonTransferExpenseByCategory).reduce((a, b) => nonTransferExpenseByCategory[a] > nonTransferExpenseByCategory[b] ? a : b);
				topExpenseCategoryAmount = nonTransferExpenseByCategory[topExpenseCategoryName];
			}

			// Hàm nhỏ để cập nhật textContent an toàn
			const setText = (id, value) => {
				const el = document.getElementById(id);
				if (el) el.textContent = value;
				else console.warn(`Element with ID '${id}' not found for statistics table.`);
			};

			setText('stats-total-income', formatCurrency(totalIncome));
			setText('stats-total-expense', formatCurrency(totalExpense));

			const statsNetCashflowEl = document.getElementById('stats-net-cashflow');
			if (statsNetCashflowEl) {
				statsNetCashflowEl.textContent = formatCurrency(netCashflow);
				// Xóa các class màu cũ của Tailwind trước khi thêm class mới
				statsNetCashflowEl.classList.remove('text-blue-600', 'dark:text-blue-400', 'text-red-600', 'dark:text-red-400');
				if (netCashflow >= 0) {
					statsNetCashflowEl.classList.add('text-blue-600', 'dark:text-blue-400');
				} else {
					statsNetCashflowEl.classList.add('text-red-600', 'dark:text-red-400');
				}
			} else {
				console.warn("Element with ID 'stats-net-cashflow' not found.");
			}

			setText('stats-income-tx-count', incomeTxCount);
			setText('stats-expense-tx-count', expenseTxCount);
			setText('stats-top-expense-cat', topExpenseCategoryName);
			setText('stats-top-expense-cat-amount', formatCurrency(topExpenseCategoryAmount));

			// Cập nhật tháng hiển thị trong tiêu đề bảng
			const selectedMonthForStatsTitle = filterMonthSelect.value; // Đảm bảo filterMonthSelect đã được khai báo
			const statsTableMonthDisplayText = getMonthDisplayText(selectedMonthForStatsTitle, false);
			const statsTableMonthDisplayEl = document.getElementById('stats-table-month-display');
			if (statsTableMonthDisplayEl) {
				statsTableMonthDisplayEl.textContent = `(${statsTableMonthDisplayText})`;
			} else {
				console.warn("Element with ID 'stats-table-month-display' not found.");
			}
		}

        function filterTransactionsByMonth() { applyMainFilter(); }
		function applyMainFilter() { const selectedMonth = filterMonthSelect.value; let filteredTransactions = (selectedMonth === 'all') ? [...transactions] : transactions.filter(tx => tx.datetime && tx.datetime.startsWith(selectedMonth)); const monthDisplayForTitles = getMonthDisplayText(selectedMonth, false); const expenseBreakdownTitleTextEl = document.getElementById('expense-breakdown-title-text'); if (expenseBreakdownTitleTextEl) { expenseBreakdownTitleTextEl.textContent = `Phân Loại Chi Tiêu ${monthDisplayForTitles} - VNĐ`; } const incomeExpenseChartTitleEl = document.getElementById('income-expense-chart-title'); if (incomeExpenseChartTitleEl) { incomeExpenseChartTitleEl.textContent = `Biểu Đồ Thu vs Chi ${monthDisplayForTitles} - VNĐ`; } renderMainTransactions(filteredTransactions); updateAllSummariesAndCharts(filteredTransactions); updateDetailedStatisticsTable(filteredTransactions); updateSummarySectionText(filteredTransactions, selectedMonth); }
        function getISOWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }
        function getWeekIdFromDateTime(dateTimeStr) { if (!dateTimeStr) return null; const date = new Date(dateTimeStr); if (isNaN(date.getTime())) return null; const year = date.getFullYear(); const weekNumber = getISOWeekNumber(date); return `${year}-W${String(weekNumber).padStart(2, '0')}`; }
        function getStartDateOfISOWeek(year, week) { const simple = new Date(year, 0, 1 + (week - 1) * 7); const dow = simple.getDay(); const ISOweekStart = simple; if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1); else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay()); ISOweekStart.setHours(0,0,0,0); return ISOweekStart; }
        function getWeekDates(weekId) { if (!weekId || !weekId.includes('-W')) return { start: null, end: null }; const [yearStr, weekNumStr] = weekId.split('-W'); const year = parseInt(yearStr); const week = parseInt(weekNumStr, 10); if (isNaN(year) || isNaN(week)) return { start: null, end: null }; const startDate = getStartDateOfISOWeek(year, week); const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); return { start: startDate, end: endDate }; }
        function getNumberOfISOWeeks(year) { const date = new Date(year, 11, 28); return getISOWeekNumber(date); }
        function getAllWeekIdsInYear(year) { if (isNaN(year) || year < 1900 || year > 2200) return []; const numWeeks = getNumberOfISOWeeks(year); const weekIds = []; for (let i = 1; i <= numWeeks; i++) weekIds.push(`${year}-W${String(i).padStart(2, '0')}`); return weekIds; }
        function getPreviousWeekId(weekId) { if (!weekId || !weekId.includes('-W')) return null; let [yearStr, weekNumStr] = weekId.split('-W'); let year = parseInt(yearStr); let week = parseInt(weekNumStr); if (week > 1) return `${year}-W${String(week - 1).padStart(2, '0')}`; else { year--; const numWeeksInPrevYear = getNumberOfISOWeeks(year); return `${year}-W${String(numWeeksInPrevYear).padStart(2, '0')}`; } }

        function populateComparisonWeekFilter() {
            const year = parseInt(filterComparisonYearInput.value);
            if (isNaN(year)) { filterComparisonWeekSelect.innerHTML = '<option value="none">-- Chọn năm hợp lệ --</option>'; return; }
            const weekIds = getAllWeekIdsInYear(year).reverse();
            filterComparisonWeekSelect.innerHTML = '<option value="none">-- Chọn tuần --</option>';
            weekIds.forEach(id => {
                const {start, end} = getWeekDates(id);
                const optionText = `${id.replace(year + "-W","Tuần ")} (${start.toLocaleDateString('vi-VN')} - ${end.toLocaleDateString('vi-VN')})`;
                filterComparisonWeekSelect.add(new Option(optionText, id));
            });
        }
		
		function populateMonthFilter() {
			if (!filterMonthSelect) { // filterMonthSelect là biến toàn cục
				console.warn("populateMonthFilter: filterMonthSelect is not defined.");
				return;
			}
			const months = new Set();
			if (typeof transactions !== 'undefined' && Array.isArray(transactions)) {
				transactions.forEach(tx => {
					if (tx.datetime && typeof tx.datetime === 'string' && tx.datetime.length >= 7) {
						months.add(tx.datetime.substring(0, 7));
					}
				});
			}
			const sortedMonths = Array.from(months).sort().reverse();
			filterMonthSelect.innerHTML = '<option value="all">Tất cả các tháng</option>'; // Luôn có lựa chọn "Tất cả"

			sortedMonths.forEach(monthStr => {
				if (monthStr && typeof monthStr === 'string' && monthStr.includes('-')) {
					const parts = monthStr.split('-');
					if (parts.length === 2) {
						const year = parts[0];
						const month = parts[1];
						const displayText = `Tháng ${month}/${year}`; // Văn bản thuần
						const option = new Option(displayText, monthStr);
						filterMonthSelect.add(option);
					}
				}
			});

			// Đặt giá trị mặc định (ví dụ: tháng mới nhất hoặc "Tất cả")
			const currentSystemMonthFormatted = new Date().toISOString().substring(0, 7);
			if (sortedMonths.includes(currentSystemMonthFormatted)) {
				filterMonthSelect.value = currentSystemMonthFormatted;
			} else if (sortedMonths.length > 0 && sortedMonths[0] && typeof sortedMonths[0] === 'string') {
				filterMonthSelect.value = sortedMonths[0];
			} else {
				filterMonthSelect.value = "all";
			}
		}

		function populateSpecificMonthFilter(selectElement) {
			if (!selectElement) {
				console.warn("populateSpecificMonthFilter: selectElement is not provided.");
				return;
			}

			const months = new Set();
			if (typeof transactions !== 'undefined' && Array.isArray(transactions)) {
				transactions.forEach(tx => {
					if (tx.datetime) {
						try {
							if (typeof tx.datetime === 'string' && tx.datetime.length >= 7) {
								months.add(tx.datetime.substring(0, 7));
							} else {
								console.warn("populateSpecificMonthFilter: Định dạng tx.datetime không hợp lệ hoặc quá ngắn:", tx.datetime);
							}
						} catch (e) {
							console.error("populateSpecificMonthFilter: Lỗi khi lấy substring từ tx.datetime:", tx.datetime, e);
						}
					}
				});
			}

			const sortedMonths = Array.from(months).sort().reverse();
			selectElement.innerHTML = '<option value="all">Tất cả các tháng</option>'; // Reset các options cũ

			sortedMonths.forEach(monthStr => {
				if (monthStr && typeof monthStr === 'string' && monthStr.includes('-')) {
					const parts = monthStr.split('-');
					if (parts.length === 2) {
						const year = parts[0];
						const month = parts[1];
						const displayText = `Tháng ${month}/${year}`; // Văn bản thuần túy
						const option = new Option(displayText, monthStr);
						selectElement.add(option);
					} else {
						console.warn("populateSpecificMonthFilter: Định dạng monthStr không đúng sau khi split:", monthStr);
					}
				} else {
					console.warn("populateSpecificMonthFilter: Giá trị monthStr không hợp lệ trong sortedMonths:", monthStr);
				}
			});

			// Đặt giá trị mặc định cho menu chọn tháng
			const currentSystemMonthFormatted = new Date().toISOString().substring(0, 7);
			if (sortedMonths.includes(currentSystemMonthFormatted)) {
				selectElement.value = currentSystemMonthFormatted;
			} else if (sortedMonths.length > 0 && sortedMonths[0] && typeof sortedMonths[0] === 'string' && sortedMonths[0].includes('-')) {
				selectElement.value = sortedMonths[0];
			} else {
				selectElement.value = "all";
			}
		}

        function calculateWeeklyStats(transactionsInPeriod, weekStartDate) { let income = 0, expenses = 0, startBalance = 0; const allSortedTransactions = [...transactions].sort((a,b) => new Date(a.datetime) - new Date(b.datetime)); for (const tx of allSortedTransactions) { const txDate = new Date(tx.datetime); if (txDate < weekStartDate) { if (tx.type === 'Thu') startBalance += tx.amount; else if (tx.type === 'Chi') startBalance -= tx.amount; } else break; } transactionsInPeriod.forEach(tx => { if (tx.type === 'Thu') income += tx.amount; else if (tx.type === 'Chi') expenses += tx.amount; }); return { startBalance, income, expenses, netChange: income - expenses }; }

        function updateWeeklyComparisonDisplay() {
            const selectedWeekId = filterComparisonWeekSelect.value;
            if (selectedWeekId === 'none') { weeklyComparisonContentEl.style.display = 'none'; noComparisonDataEl.style.display = 'block'; return; }
            weeklyComparisonContentEl.style.display = 'grid'; noComparisonDataEl.style.display = 'none';
            const currentWeekDates = getWeekDates(selectedWeekId);
            if (!currentWeekDates.start) { weeklyComparisonContentEl.style.display = 'none'; noComparisonDataEl.style.display = 'block'; noComparisonDataEl.textContent = 'Tuần không hợp lệ.'; return; }
            const currentWeekTransactions = transactions.filter(tx => { const txDate = new Date(tx.datetime); return txDate >= currentWeekDates.start && txDate <= currentWeekDates.end; });
            const currentWeekStats = calculateWeeklyStats(currentWeekTransactions, currentWeekDates.start);
            selectedWeekDisplayEl.textContent = `${selectedWeekId.replace(filterComparisonYearInput.value + "-W","Tuần ")} (${currentWeekDates.start.toLocaleDateString('vi-VN')} - ${currentWeekDates.end.toLocaleDateString('vi-VN')})`;
            currentWeekStartBalanceEl.textContent = formatCurrency(currentWeekStats.startBalance);
            currentWeekIncomeEl.textContent = formatCurrency(currentWeekStats.income);
            currentWeekExpensesEl.textContent = formatCurrency(currentWeekStats.expenses);
            currentWeekNetChangeEl.textContent = formatCurrency(currentWeekStats.netChange);
            currentWeekNetChangeEl.className = currentWeekStats.netChange >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';
            const prevWeekId = getPreviousWeekId(selectedWeekId);
            if (prevWeekId) {
                const prevWeekDates = getWeekDates(prevWeekId);
                if(prevWeekDates.start) {
                    const prevWeekTransactions = transactions.filter(tx => { const txDate = new Date(tx.datetime); return txDate >= prevWeekDates.start && txDate <= prevWeekDates.end; });
                    const prevWeekStats = calculateWeeklyStats(prevWeekTransactions, prevWeekDates.start);
                    previousWeekDisplayEl.textContent = `${prevWeekId.replace(filterComparisonYearInput.value + "-W","Tuần ")} (${prevWeekDates.start.toLocaleDateString('vi-VN')} - ${prevWeekDates.end.toLocaleDateString('vi-VN')})`;
                    previousWeekExpensesEl.textContent = formatCurrency(prevWeekStats.expenses);
                    const difference = currentWeekStats.expenses - prevWeekStats.expenses;
                    spendingDifferenceEl.textContent = formatCurrency(difference);
                    spendingDifferenceEl.className = difference >= 0 ? 'font-bold text-red-600' : 'font-bold text-green-600';
                } else { previousWeekDisplayEl.textContent = "N/A"; previousWeekExpensesEl.textContent = formatCurrency(0); spendingDifferenceEl.textContent = formatCurrency(0); }
            } else { previousWeekDisplayEl.textContent = "N/A"; previousWeekExpensesEl.textContent = formatCurrency(0); spendingDifferenceEl.textContent = formatCurrency(0); }
        }

        function escapeCSVValue(value) { if (value == null) return ''; value = String(value); if (value.includes(',') || value.includes('\n') || value.includes('"')) { value = value.replace(/\"/g, '""'); return `"${value}"`; } return value; }
        function exportToCSV() { if (transactions.length === 0) { showMessage('Không có dữ liệu giao dịch để xuất.', 'error'); return; } const headers = [ 'ID Giao Dịch', 'Ngày Giờ (YYYY-MM-DD HH:mm:ss)', 'Nội dung', 'Hạng mục', 'Loại (Thu/Chi)', 'Số Tiền (VNĐ)', 'Tài khoản', 'Là Chuyển Khoản?', 'ID Liên Kết CK', 'Số Tiền Gốc', 'Đơn Vị Gốc' ]; const rows = transactions.map(tx => { const accountName = accounts.find(acc => acc.value === tx.account)?.text || tx.account; return [ tx.id, formatDateTimeForCSV(tx.datetime), tx.description, tx.category, tx.type, tx.amount, accountName, tx.isTransfer ? 'Có' : 'Không', tx.isTransfer ? tx.transferPairId : '', tx.originalAmount, tx.originalCurrency ].map(escapeCSVValue); }); let csvContent = "\ufeff"; csvContent += headers.join(',') + '\n'; rows.forEach(rowArray => { csvContent += rowArray.join(',') + '\n'; }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', `transactions_${new Date().toISOString().slice(0,10)}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showMessage('Dữ liệu đã được xuất ra CSV!', 'success'); } else { showMessage('Trình duyệt của bạn không hỗ trợ tải file trực tiếp.', 'error'); } }
        function exportData() { const dataToExport = { transactions, incomeCategories, expenseCategories, accounts }; const dataStr = JSON.stringify(dataToExport, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `financial_data_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showMessage('Dữ liệu đã được xuất!', 'success'); }
        function handleImportFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (importedData.transactions && importedData.incomeCategories && importedData.expenseCategories && importedData.accounts) { if (!confirm('Nhập dữ liệu sẽ ghi đè toàn bộ dữ liệu hiện tại. Bạn có chắc chắn muốn tiếp tục?')) { importFileInput.value = ''; return; } transactions = importedData.transactions; incomeCategories = importedData.incomeCategories; expenseCategories = importedData.expenseCategories; accounts = importedData.accounts; saveTransactions(); saveUserPreferences(); initializeApp(); showMessage('Dữ liệu đã được nhập thành công!', 'success'); } else { showMessage('Lỗi: Định dạng file không hợp lệ.', 'error'); } } catch (error) { showMessage(`Lỗi khi nhập file: ${error.message}`, 'error'); console.error("Import error:", error); } finally { importFileInput.value = ''; } }; reader.readAsText(file); }

        // --- HÀM FUNCTION VIRTUAL KEYBOARD ---
		let activeInputForVirtualKeyboard = null; // Biến theo dõi ô input đang active với bàn phím ảo

		function showVirtualKeyboard(inputElement) {
			const virtualKeyboardEl = document.getElementById('virtualNumericKeyboard'); // Lấy element ở đây
			if (virtualKeyboardEl && inputElement) {
				console.log("[Keyboard] Showing virtual keyboard for:", inputElement.id);
				virtualKeyboardEl.style.display = 'grid'; // Hoặc 'block' tùy theo CSS layout bàn phím
				activeInputForVirtualKeyboard = inputElement;
				// ... (code hiện tại của bạn để hiển thị bàn phím) ...
				virtualKeyboardEl.style.display = 'grid'; // Hoặc 'block'
				activeInputForVirtualKeyboard = inputElement;

				// Thêm logic cuộn ở đây:
				setTimeout(() => { // Dùng setTimeout để đảm bảo bàn phím đã render và có kích thước
					const keyboardHeight = virtualKeyboardEl.offsetHeight;
					const inputRect = activeInputForVirtualKeyboard.getBoundingClientRect();
					const viewportHeight = window.innerHeight;

					// Tính xem phần dưới của input có bị che không, hoặc một khoảng không gian cần thiết bên dưới input
					const spaceNeededBelowInput = 50; // Khoảng đệm để nhìn thấy trường tiếp theo hoặc nút submit
					const inputBottomPosition = inputRect.bottom;

					if (inputBottomPosition > (viewportHeight - keyboardHeight - spaceNeededBelowInput)) {
						const scrollAmount = inputBottomPosition - (viewportHeight - keyboardHeight - spaceNeededBelowInput);
						window.scrollBy(0, scrollAmount);
						console.log(`[Keyboard] Scrolled by: ${scrollAmount}px`);
					}
					// Hoặc một cách đơn giản hơn là cuộn trường input vào tầm nhìn,
					// nhưng cần cẩn thận để không cuộn quá nhiều nếu bàn phím che mất nó từ dưới lên.
					// activeInputForVirtualKeyboard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
					// Tuy nhiên, scrollIntoView có thể không hoạt động tốt với fixed keyboard,
					// window.scrollBy thường cho kiểm soát tốt hơn trong trường hợp này.

				}, 100); // Chờ một chút để DOM cập nhật				
				// Không dùng readonly ở đây nữa, sẽ xử lý bằng blur và preventDefault
			} else {
				console.error("[Keyboard] Cannot show virtual keyboard. virtualKeyboardEl or inputElement is missing.");
			}
		}

		function hideVirtualKeyboard() {
			const virtualKeyboardEl = document.getElementById('virtualNumericKeyboard'); // Lấy element ở đây
			if (virtualKeyboardEl) {
				console.log("[Keyboard] Hiding virtual keyboard");
				virtualKeyboardEl.style.display = 'none';
				if (activeInputForVirtualKeyboard) {
					// Cân nhắc có nên activeInputForVirtualKeyboard.blur(); ở đây không
					// Nếu người dùng nhấn "Done", focus sẽ chuyển sang nút submit
				}
				activeInputForVirtualKeyboard = null;
			}
		}
		
		// --- HÀM KHỞI TẠO ỨNG DỤNG ---
		function initializeApp() {
			console.log("[Debug] initializeApp CALLED")
			console.log("[APP] initializeApp CALLED");
			// migrateOriginalAmountsForOldVNDTransactions();

			loadThemePreference(); // Quan trọng: gọi đầu tiên
			loadUserPreferences();

			if (formCurrencySelector) formCurrencySelector.value = 'VND';
			setDefaultDateTime();
			setDefaultComparisonYear();
			const typeChiRadio = document.getElementById('type-chi');
			if (typeChiRadio) typeChiRadio.checked = true;

			populateAccountDropdowns();
			toggleFormFields();
			renderCustomCategoryLists();
			renderAccountListAdmin();

			populateMonthFilter();
			applyMainFilter();

			populateComparisonWeekFilter();
			updateWeeklyComparisonDisplay();

			// Collapsible sections
			const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
			collapsibleHeaders.forEach(header => {
				const contentId = header.dataset.collapsibleTarget;
				const content = document.getElementById(contentId);
				if (!content) { console.error(`Collapsible Error: Content ID '${contentId}' not found.`, header); return; }
				const storedState = localStorage.getItem(`collapsibleState_${contentId}`);
				let isActive = header.classList.contains('active'); // Default từ HTML
				if (storedState === 'expanded') isActive = true;
				if (storedState === 'collapsed') isActive = false;

				if (isActive) {
					header.classList.add('active');
					content.classList.add('active');
					// Nếu dùng maxHeight cho section lớn
					// if (content.classList.contains('collapsible-content')) { // Chỉ áp dụng cho content chính
					//    setTimeout(() => { if (content.classList.contains('active')) content.style.maxHeight = content.scrollHeight + "px"; }, 50);
					// }
				} else {
					header.classList.remove('active');
					content.classList.remove('active');
					// if (content.classList.contains('collapsible-content')) content.style.maxHeight = null;
				}
				header.addEventListener('click', () => {
					header.classList.toggle('active');
					content.classList.toggle('active');
					localStorage.setItem(`collapsibleState_${contentId}`, content.classList.contains('active') ? 'expanded' : 'collapsed');
					// if (content.classList.contains('collapsible-content') && content.classList.contains('active')) {
					//     content.style.maxHeight = content.scrollHeight + "px";
					// } else if (content.classList.contains('collapsible-content')) {
					//     content.style.maxHeight = null;
					// }
				});
			});

			const listHeaders = document.querySelectorAll('.collapsible-list-header');
			listHeaders.forEach(header => {
				const contentId = header.dataset.collapsibleTarget;
				const contentList = document.getElementById(contentId);
				if (!contentList) { console.error(`Collapsible List Error: Content UL ID '${contentId}' not found.`, header); return; }
				if (header.classList.contains('active')) {
					if (!contentList.classList.contains('active')) contentList.classList.add('active');
					setTimeout(() => { if (contentList.classList.contains('active')) contentList.style.maxHeight = contentList.scrollHeight + "px"; }, 150);
				} else {
					if (contentList.classList.contains('active')) contentList.classList.remove('active');
					contentList.style.maxHeight = null;
				}
				header.addEventListener('click', () => {
					header.classList.toggle('active');
					contentList.classList.toggle('active');
					if (contentList.classList.contains('active')) {
						contentList.style.maxHeight = contentList.scrollHeight + "px";
					} else {
						contentList.style.maxHeight = null;
					}
				});
			});

			// Event listener cho bộ chọn kiểu biểu đồ chi tiêu
			if (expenseChartTypeSelector) {
				expenseChartTypeSelector.addEventListener('change', toggleExpenseChartDisplay);
			} else {
				console.warn("[APP] expenseChartTypeSelector not found.");
			}

			// Nút "Thêm 000"
			if (addTripleZeroButton && amountTextInput) {
				addTripleZeroButton.addEventListener('click', function() { /* ... code của bạn ... */ });
			}
					
		// Đặt hàm này ở đâu đó trong phần script của bạn, có thể ở đầu phần script cho các hàm tiện ích
		function formatAndPreserveCursor(inputElement, valueToFormat) {
			const originalValue = valueToFormat;
			let cursorPos = inputElement.selectionStart;
			const originalLength = originalValue.length;

			// 1. Loại bỏ các ký tự không hợp lệ và dấu phẩy cũ, chỉ giữ lại số và một dấu chấm thập phân
			let cleanValue = originalValue.replace(/[^0-9.]/g, "");
			const parts = cleanValue.split('.');
			let integerPart = parts[0];
			let decimalPart = parts.length > 1 ? parts.slice(1).join('') : ""; // Nối lại nếu có nhiều dấu chấm

			// Chỉ cho phép một dấu chấm thập phân
			if (parts.length > 2) {
				decimalPart = parts[1] + parts.slice(2).join(''); // Lấy phần đầu tiên sau dấu chấm và nối phần còn lại
			}
			 if (decimalPart.length > 2 && inputElement.id === 'amount-input' && document.getElementById('form-currency-selector').value === 'USD') {
				// Giới hạn 2 số thập phân cho USD, có thể mở rộng cho các tiền tệ khác nếu cần
				// decimalPart = decimalPart.substring(0, 2);
				// Với VND, bạn có thể không muốn giới hạn số thập phân khi nhập,
				// việc làm tròn sẽ do hàm parseAmountInput đảm nhiệm khi submit.
				// Hiện tại, không giới hạn số chữ số thập phân khi nhập để linh hoạt.
			}


			// 2. Định dạng phần nguyên với dấu phẩy
			let formattedInteger = "";
			if (integerPart) {
				// Bỏ qua việc parse thành số rồi format lại nếu đang gõ số 0 ở đầu (ví dụ: 007)
				if (/^0+$/.test(integerPart) && integerPart.length > 1 && (decimalPart === "" || decimalPart === undefined)) {
					 // Giữ nguyên nếu chỉ là các số 0 (ví dụ 00) để cho phép nhập 0.5 sau đó
					 // formattedInteger = integerPart; // Tạm thời để người dùng nhập 007
				} else {
					const num = parseInt(integerPart, 10); // Parse để bỏ số 0 ở đầu (vd: 007 -> 7)
					if (!isNaN(num)) {
						 formattedInteger = new Intl.NumberFormat('en-US').format(num);
					} else if (integerPart === "" && (decimalPart !== "" || valueToFormat === ".")) {
						formattedInteger = "0"; // Nếu chỉ có phần thập phân, ví dụ ".5" -> "0.5"
					} else {
						formattedInteger = ""; // Nếu integerPart không hợp lệ và không có phần thập phân
					}
				}
			} else if (decimalPart !== "" || valueToFormat === ".") {
				formattedInteger = "0"; // Nếu không có phần nguyên nhưng có phần thập phân
			}


			// 3. Ghép lại giá trị đã định dạng
			let newFormattedValue = formattedInteger;
			if (decimalPart !== "" || (valueToFormat.endsWith('.') && !valueToFormat.endsWith('..'))) { // Cho phép dấu chấm ở cuối khi đang gõ
				newFormattedValue += "." + decimalPart;
			}
			 // Nếu giá trị ban đầu là "." hoặc "0." thì giữ nguyên sau khi thêm số 0
			if (valueToFormat === ".") newFormattedValue = "0.";
			if (valueToFormat === "0." && decimalPart==="") newFormattedValue = "0.";


			// Xử lý trường hợp đặc biệt: nếu người dùng chỉ nhập "0", thì hiển thị "0"
			if (integerPart === "0" && decimalPart === "" && !valueToFormat.includes('.')) {
				newFormattedValue = "0";
			}
			// Nếu người dùng xóa hết, newFormattedValue có thể là "0" do Intl.NumberFormat(NaN) hoặc (0)
			// Cần đảm bảo nếu input rỗng thì hiển thị rỗng
			if (originalValue.trim() === "") {
				newFormattedValue = "";
			}


			// 4. Cập nhật giá trị và đặt lại con trỏ
			inputElement.value = newFormattedValue;

			// Tính toán vị trí con trỏ mới
			// Logic này cố gắng giữ vị trí con trỏ tương đối dựa trên số lượng chữ số đã thay đổi.
			// Nó không hoàn hảo 100% cho mọi trường hợp phức tạp (xóa/chèn ở giữa)
			// nhưng sẽ tốt hơn là chỉ đặt con trỏ về cuối.
			if (cursorPos !== null) {
				let newCursorPos = cursorPos;
				const newLength = newFormattedValue.length;

				// Đếm số dấu phẩy trong giá trị cũ và mới trước vị trí con trỏ ước tính
				const oldCommasBefore = (originalValue.substring(0, cursorPos).match(/,/g) || []).length;
				// Ước tính vị trí con trỏ mới trước khi điều chỉnh dấu phẩy
				let tempNewCursorPos = cursorPos + (newLength - originalLength);
				if (tempNewCursorPos < 0) tempNewCursorPos = 0;
				if (tempNewCursorPos > newLength) tempNewCursorPos = newLength;

				const newCommasBefore = (newFormattedValue.substring(0, tempNewCursorPos).match(/,/g) || []).length;

				newCursorPos = tempNewCursorPos + (newCommasBefore - oldCommasBefore);

				// Đảm bảo con trỏ không vượt quá giới hạn
				if (newCursorPos < 0) newCursorPos = 0;
				if (newCursorPos > newLength) newCursorPos = newLength;

				// Đặc biệt khi xóa lùi và ký tự bị xóa là dấu phẩy
				if (inputElement.id === 'amount-input' && originalValue.charAt(cursorPos -1) === ',' && newLength < originalLength) {
					// Nếu người dùng vừa xóa dấu phẩy, vị trí con trỏ nên ở trước dấu phẩy đó
					// (giờ đã biến mất), tức là vị trí hiện tại của ký tự đứng trước dấu phẩy
					// newCursorPos = cursorPos -1; // Đã được xử lý bởi logic trên
				}


				inputElement.setSelectionRange(newCursorPos, newCursorPos);
			}
		}


		// Đảm bảo biến amountTextInput đã được khai báo ở phạm vi có thể truy cập
		// const amountTextInput = document.getElementById('amount-input');

		if (amountTextInput) {
			amountTextInput.addEventListener('input', function(e) {
				// Chỉ định dạng nếu không phải là xóa (để tránh xung đột khi xóa dấu phẩy)
				// Hoặc nếu bạn muốn nó luôn định dạng:
				formatAndPreserveCursor(e.target, e.target.value);
			});

			amountTextInput.addEventListener('keydown', function(e) {
				// Cho phép: backspace, delete, tab, escape, enter, home, end, left, right arrows
				if ([46, 8, 9, 27, 13, 35, 36, 37, 39].indexOf(e.keyCode) !== -1 ||
					// Cho phép: Ctrl+A, Command+A, Ctrl+C, Ctrl+V, Ctrl+X
					((e.keyCode === 65 || e.keyCode === 88 || e.keyCode === 67 || e.keyCode === 86) && (e.ctrlKey === true || e.metaKey === true)) ||
					// Cho phép: số từ 0-9 trên bàn phím chính
					(e.keyCode >= 48 && e.keyCode <= 57 && !e.shiftKey) ||
					// Cho phép: số từ 0-9 trên numpad
					(e.keyCode >= 96 && e.keyCode <= 105) ||
					// Cho phép: dấu chấm (period) và dấu chấm trên numpad (decimal point)
					(e.keyCode === 190 || e.keyCode === 110)) {
					// Nếu là dấu chấm, kiểm tra xem đã có dấu chấm chưa
					if ((e.keyCode === 190 || e.keyCode === 110) && this.value.includes('.')) {
						e.preventDefault(); // Ngăn nhập nhiều hơn một dấu chấm
					}
					return; // Cho phép các phím này
				}
				// Ngăn chặn tất cả các phím khác không được liệt kê ở trên
				e.preventDefault();
			});
		}
			

			// ----- VIRTUAL KEYBOARD LOGIC -----
			const virtualKeyboardEl = document.getElementById('virtualNumericKeyboard');
			const amountInputForKeyboard = document.getElementById('amount-input'); // Đổi tên biến để tránh nhầm lẫn với amountTextInput toàn cục nếu có

			if (amountInputForKeyboard && virtualKeyboardEl) {
				console.log('[Keyboard] Initializing event listeners for virtual keyboard.');

				// Sử dụng 'click' để có kiểm soát tốt hơn trên mobile và ngăn bàn phím OS
				amountInputForKeyboard.addEventListener('click', function(event) {
					// Chỉ kích hoạt bàn phím ảo trên thiết bị cảm ứng
					if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
						console.log("[Keyboard] Amount input CLICKED on touch device.");
						event.preventDefault(); // QUAN TRỌNG: Ngăn hành vi mặc định (mở bàn phím OS)
						
						// Nếu bàn phím ảo đang ẩn hoặc chưa được hiển thị cho input này, thì hiện nó
						if (virtualKeyboardEl.style.display === 'none' || virtualKeyboardEl.style.display === '' || activeInputForVirtualKeyboard !== this) {
							showVirtualKeyboard(this);
						}
						// Ngăn việc focus thực sự vào input để tránh bàn phím OS tự động bật lên sau đó
						this.blur(); 
					}
				});

				// Xử lý khi focus vào input (ví dụ bằng phím Tab trên desktop)
				// Trên mobile, chúng ta muốn click là chính, focus có thể gây ra hiện bàn phím OS không mong muốn
				amountInputForKeyboard.addEventListener('focus', function(e) {
					if ('ontouchstart' in window || navigator.maxTouchPoints > 0) { // Nếu là thiết bị cảm ứng
						console.log("[Keyboard] Amount input FOCUSED on touch device - attempting to blur and show virtual.");
						e.target.blur(); // LUÔN BLUR ngay để ngăn bàn phím OS
						// Sau đó, nếu bàn phím ảo đang ẩn, hiện nó.
						if (virtualKeyboardEl.style.display === 'none' || virtualKeyboardEl.style.display === '') {
							showVirtualKeyboard(this);
						}
					} else {
						// Trên desktop, cho phép focus bình thường, không hiện bàn phím ảo tự động khi focus
						console.log("[Keyboard] Amount input FOCUSED on non-touch device.");
					}
				});

				// Gán sự kiện cho các nút trên bàn phím ảo
				virtualKeyboardEl.addEventListener('touchstart', function(event) {
					if (!activeInputForVirtualKeyboard) {
						console.warn("[Keyboard] Virtual keyboard key pressed, but no active input target.");
						return;
					}

					const targetButton = event.target.closest('button.virtual-key');
					if (!targetButton) return; // Chỉ xử lý nếu click vào nút có class 'virtual-key'

					const key = targetButton.dataset.key;
					console.log("[Keyboard] Virtual key pressed:", key);

					let currentValue = activeInputForVirtualKeyboard.value;

					if (key === 'backspace') {
						activeInputForVirtualKeyboard.value = currentValue.slice(0, -1);
					} else if (key === 'done') {
						hideVirtualKeyboard();
						// Tùy chọn: chuyển focus sang nút submit hoặc một hành động khác
						if (submitButton) submitButton.focus();
					} else if (key === '.') {
						if (!currentValue.includes('.')) { // Chỉ cho phép một dấu chấm
							activeInputForVirtualKeyboard.value += key;
						}
					} else if (key) { // Các phím số (0-9) và '000'
						activeInputForVirtualKeyboard.value += key;
					}
					activeInputForVirtualKeyboard.value = newValue; // Cập nhật giá trị thô trước

					// GỌI HÀM ĐỊNH DẠNG NGAY SAU KHI BÀN PHÍM ẢO CẬP NHẬT GIÁ TRỊ
					if (activeInputForVirtualKeyboard.id === 'amount-input') { // Chỉ định dạng cho ô số tiền
						formatAndPreserveCursor(activeInputForVirtualKeyboard, activeInputForVirtualKeyboard.value);
					}				
					// Không nên gọi activeInputForVirtualKeyboard.focus() ở đây vì có thể kích hoạt lại bàn phím OS
				});
			} else {
				if (!virtualKeyboardEl) console.warn("[Keyboard] Virtual keyboard element with ID 'virtualNumericKeyboard' not found.");
				if (!amountInputForKeyboard) console.warn("[Keyboard] Amount input element with ID 'amount-input' not found for virtual keyboard.");

			}

			// Xử lý click ra ngoài để ẩn bàn phím ảo
			document.addEventListener('mousedown', function(event) {
				if (virtualKeyboardEl && virtualKeyboardEl.style.display !== 'none') {
					const isClickOnKeyboard = virtualKeyboardEl.contains(event.target);
					// activeInputForVirtualKeyboard có thể là null nếu bàn phím vừa được ẩn
					const isClickOnActiveInput = activeInputForVirtualKeyboard && activeInputForVirtualKeyboard.contains(event.target);

					if (!isClickOnKeyboard && !isClickOnActiveInput) {
						console.log("[Keyboard] Clicked outside, hiding virtual keyboard.");
						hideVirtualKeyboard();
					}
				}
			});
			
			document.querySelectorAll('.virtual-key').forEach(button => {
				let lastTap = 0;
				button.addEventListener('touchend', function(event) {
					const currentTime = new Date().getTime();
					const tapLength = currentTime - lastTap;
					if (tapLength < 300 && tapLength > 0) { 
						event.preventDefault();
						// console.log("Rapid touchend prevented on virtual key"); // Dòng log này có thể có hoặc không
					}
					lastTap = currentTime;
				});
			});	

			document.addEventListener('mousedown', function(event) {
				if (virtualKeyboard && virtualKeyboard.style.display !== 'none') {
					const isClickOnKeyboard = virtualKeyboard.contains(event.target);
					const isClickOnActiveInput = activeInputForVirtualKeyboard && activeInputForVirtualKeyboard.contains(event.target);
					if (!isClickOnKeyboard && !isClickOnActiveInput) {
						hideVirtualKeyboard();
					}
				}
			});
			// ----- END VIRTUAL KEYBOARD LOGIC -----
		    const fieldsForSuggestion = [
				...document.querySelectorAll('input[name="type"]'), // Tất cả các radio button loại
				categoryInput, 
				// accountInput // Thêm accountInput nếu muốn nó cũng kích hoạt gợi ý
			];

			fieldsForSuggestion.forEach(field => {
				if (field) { // Kiểm tra field tồn tại
					field.addEventListener('change', findAndDisplayTransactionSuggestion);
				}
			});

			// Gán sự kiện cho các nút trong khu vực gợi ý
			if (applySuggestionButtonEl) {
				applySuggestionButtonEl.addEventListener('click', applyTransactionSuggestion);
			}
			if (dismissSuggestionButtonEl) {
				dismissSuggestionButtonEl.addEventListener('click', hideTransactionSuggestion);
			}

			// Khi reset form, cũng ẩn gợi ý
			transactionForm.addEventListener('reset', hideTransactionSuggestion);	

			// Đăng ký các event listeners khác
			if(transactionForm) transactionForm.addEventListener('submit', handleTransactionSubmit);
			if(filterMonthSelect) filterMonthSelect.addEventListener('change', filterTransactionsByMonth);
			if(typeRadioButtons) typeRadioButtons.forEach(radio => {
				radio.addEventListener('change', () => {
					toggleFormFields(); 
					const currentType = document.querySelector('input[name="type"]:checked');
					if (currentType && currentType.value !== 'Transfer') {
						populateCategories();
					}
				});
			});
			if(filterComparisonYearInput) {
				filterComparisonYearInput.addEventListener('change', () => { populateComparisonWeekFilter(); updateWeeklyComparisonDisplay(); });
				filterComparisonYearInput.addEventListener('input', populateComparisonWeekFilter);
			}
			if(filterComparisonWeekSelect) filterComparisonWeekSelect.addEventListener('change', updateWeeklyComparisonDisplay);
			if (exportButton) exportButton.addEventListener('click', exportData);
			if (exportCsvButton) exportCsvButton.addEventListener('click', exportToCSV);
			if (importButton && importFileInput) importButton.addEventListener('click', () => importFileInput.click());
			if (importFileInput) importFileInput.addEventListener('change', handleImportFile);
			if (addIncomeCategoryButton && newIncomeCategoryNameInput) addIncomeCategoryButton.addEventListener('click', () => { if (addCategory(newIncomeCategoryNameInput.value, 'income')) newIncomeCategoryNameInput.value = ''; });
			if (addExpenseCategoryButton && newExpenseCategoryNameInput) addExpenseCategoryButton.addEventListener('click', () => { if (addCategory(newExpenseCategoryNameInput.value, 'expense')) newExpenseCategoryNameInput.value = ''; });
			if (addAccountButton && newAccountNameInput) { addAccountButton.addEventListener('click', () => { if (addAccount(newAccountNameInput.value)) { newAccountNameInput.value = ''; } }); }
			
			// Quan trọng: Gán listener cho dark mode toggle
			if (darkModeToggleCheckbox) {
				// console.log('[Debug] Attaching change listener to darkModeToggleCheckbox'); // Bạn có thể bỏ log này nếu dark mode đã ổn
				darkModeToggleCheckbox.addEventListener('change', toggleTheme);
			} else {
				console.error('[APP] darkModeToggleCheckbox NOT FOUND during listener attachment!');
			}
			console.log("[APP] initializeApp COMPLETED");
		}

		// KHỞI CHẠY ỨNG DỤNG
        initializeApp();
    </script>

</body></html>
