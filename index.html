<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ Theo Dõi Tài Chính Cá Nhân</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .form-section, .summary-section, .table-section, .chart-section, .comparison-section, .expense-breakdown-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }
        .form-section h2, .summary-section h2, .table-section h2, .chart-section h2, .comparison-section h2, .expense-breakdown-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 8px;
        }
        label {
            font-weight: 500;
            color: #374151;
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="datetime-local"], select { /* Removed number type as amount is text now */
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
         input#amount-input[type="text"] {
            /* No specific styles needed now, handled by general text input style */
         }

        input[type="text"]:focus, input[type="datetime-local"]:focus, select:focus {
            border-color: #3b82f6;
            outline: none;
        }
        .radio-group {
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .radio-group label {
            margin-right: 15px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 0;
        }
        .radio-group input[type="radio"] {
            margin-right: 5px;
            accent-color: #3b82f6;
        }
        .amount-currency-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .amount-currency-group input[type="text"] { /* Input is text */
            flex-grow: 1;
            margin-bottom: 0;
        }
        .amount-currency-group select {
            width: auto;
            margin-bottom: 0;
            padding: 10px 8px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-edit {
            background-color: #f59e0b;
            color: white;
        }
        .btn-edit:hover {
            background-color: #d97706;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
            font-size: 0.9rem;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #1f2937;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e5e7eb;
            font-size: 0.95rem;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item span:first-child {
            font-weight: 500;
            color: #374151;
        }
        .summary-item span:last-child {
            font-weight: 600;
        }
        .account-balance-list {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        .account-balance-list h3 {
             font-size: 1.1rem;
             font-weight: 600;
             color: #4b5563;
             margin-bottom: 10px;
        }
        .text-green-600 { color: #059669; }
        .text-red-600 { color: #dc2626; }
        .text-blue-600 { color: #2563eb; }
        .text-purple-600 { color: #7c3aed; }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        .filter-container label { margin-bottom: 0; margin-right: 5px;}
        .filter-container input[type="number"], .filter-container select {
            margin-bottom: 0;
            flex-grow: 1;
        }
        #message-box {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
        }
        .message-success { background-color: #d1fae5; color: #065f46; }
        .message-error { background-color: #fee2e2; color: #991b1b; }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        .expense-breakdown-section .chart-container {
            max-width: 350px;
            height: 350px;
        }
        .expense-category-list {
            margin-top: 20px;
        }
        .expense-category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .expense-category-item:last-child {
            border-bottom: none;
        }
        .category-color-swatch {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
            display: inline-block;
        }
        .category-name {
            flex-grow: 1;
        }
        .category-percentage {
            width: 50px;
            text-align: right;
            color: #6b7280;
            margin-left: 10px;
        }
        .category-amount {
            width: 100px;
            text-align: right;
            font-weight: 500;
            margin-left: 10px;
        }
        .comparison-section .grid > div {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }
         .comparison-section h3 {
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 5px;
            margin-top: 0;
        }
         .table-actions {
             display: flex;
             justify-content: flex-end;
             margin-bottom: 20px;
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600">Sổ Theo Dõi Tài Chính Cá Nhân</h1>
            <p class="text-gray-600">Ghi chép, quản lý thu chi hàng ngày và so sánh theo tuần.</p>
        </header>

        <div id="message-box" style="display: none;"></div>

        <div class="form-section">
             <h2>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                <span id="form-title">Thêm Giao Dịch Mới</span>
            </h2>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                <div><label for="datetime-input">Ngày & Giờ:</label><input type="datetime-local" id="datetime-input" required></div>
                <div>
                    <label>Loại giao dịch:</label>
                    <div class="radio-group">
                        <label for="type-thu">
                            <input type="radio" id="type-thu" name="type" value="Thu" required> Thu
                        </label>
                        <label for="type-chi">
                            <input type="radio" id="type-chi" name="type" value="Chi" checked required> Chi
                        </label>
                    </div>
                </div>
                <div> <label for="account">Tài khoản:</label>
                    <select id="account" required>
                        <option value="Tiền mặt">Tiền mặt</option>
                        <option value="Momo">Momo</option>
                        <option value="Thẻ tín dụng A">Thẻ tín dụng A</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="BIDV">BIDV</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div> <label for="category">Hạng mục:</label>
                    <select id="category" required>
                        </select>
                </div>
                 <div> <label for="amount-input">Số tiền:</label>
                    <div class="amount-currency-group">
                         <input type="text" inputmode="decimal" id="amount-input" placeholder="Nhập số (VD: 22.5)" required>
                         <select id="form-currency-selector">
                             <option value="VND">VNĐ (x1000)</option>
                             <option value="USD">USD (quy đổi)</option>
                         </select>
                    </div>
                 </div>
                <div> <label for="description">Nội dung chi tiết:</label>
                    <input type="text" id="description" placeholder="VD: Ăn trưa, Tiền điện">
                </div>
                <div class="md:col-span-2 mt-4">
                    <button type="submit" id="submit-transaction-button" class="btn-primary w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Thêm Giao Dịch
                    </button>
                </div>
            </form>
        </div>

        <div class="summary-section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 19.875v-6.75zM3 6.375C3 5.754 3.504 5.25 4.125 5.25h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 13.125V6.375zM12 3v2.25M12 17.25v2.25M6.375 12H4.125m15.75 0H17.625" /></svg>
                Tóm Tắt Tài Chính (VNĐ)
            </h2>
            <div id="summary-content">
                <div class="summary-item"><span>Tổng Thu (Tháng Lọc):</span><span id="total-income" class="text-green-600 font-semibold">0</span></div>
                <div class="summary-item"><span>Tổng Chi (Tháng Lọc):</span><span id="total-expenses" class="text-red-600 font-semibold">0</span></div>
                <div class="summary-item"><span>Số Dư (Tháng Lọc):</span><span id="current-balance" class="text-blue-600 font-bold">0</span></div>
            </div>
             <div id="account-balance-list" class="account-balance-list">
                <h3>Số Dư Theo Tài Khoản (Tổng thể - VNĐ):</h3>
            </div>
        </div>

        <div class="expense-breakdown-section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-blue-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v.01M15.088 11.129l.793-.793a.75.75 0 011.06 1.06l-.792.792a3.751 3.751 0 01-5.304 0L8.12 9.364a.75.75 0 011.06-1.06l.793.793" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 12a3.752 3.752 0 00-2.716 1.116l-.79.79a.75.75 0 001.06 1.06l.79-.79A2.252 2.252 0 0112 13.5a2.252 2.252 0 011.588.656l.79.79a.75.75 0 101.06-1.06l-.79-.79A3.752 3.752 0 0012 12z" />
                </svg>
                Phân Loại Chi Tiêu (Tháng Lọc - VNĐ)
            </h2>
            <div class="md:flex md:gap-6">
                <div class="chart-container md:w-1/2">
                    <canvas id="expenseCategoryChart"></canvas>
                </div>
                <div id="expense-category-list-container" class="expense-category-list md:w-1/2">
                    <p id="no-expense-data" class="text-center text-gray-500 mt-4">Không có dữ liệu chi tiêu để hiển thị.</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="chart-section">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15zM12 10.5v4.5m0 0l2.25-2.25M12 14.25l-2.25-2.25M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                    Biểu Đồ Thu vs Chi (Tháng Lọc - VNĐ)
                </h2>
                <div class="chart-container"><canvas id="incomeExpenseChart"></canvas></div>
            </div>
             <div class="chart-section">
                 <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-red-500"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" /> </svg>
                     Chi Tiêu 7 Ngày Qua (Biểu đồ đường - VNĐ)
                </h2>
                <div class="chart-container"><canvas id="last7DaysChart"></canvas></div>
            </div>
             <div class="chart-section md:col-span-2">
                 <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-purple-500"> <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" /> </svg>
                     So Sánh Tháng Này & Tháng Trước (VNĐ)
                </h2>
                <div class="chart-container"><canvas id="monthComparisonChart"></canvas></div>
            </div>
        </div>

        <div class="comparison-section">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-3.75h.008v.008H12v-.008zM12 12.75h.008v.008H12v-.008z" /></svg>
                Thống Kê & So Sánh Tuần (VNĐ)
            </h2>
            <div class="filter-container">
                <div class="flex items-center">
                    <label for="filter-comparison-year">Năm:</label>
                    <input type="number" id="filter-comparison-year" class="p-2 border rounded-md w-24" min="2000" max="2100">
                </div>
                <div class="flex items-center flex-grow">
                    <label for="filter-comparison-week">Tuần:</label>
                    <select id="filter-comparison-week" class="p-2 border rounded-md w-full"><option value="none">-- Chọn tuần --</option></select>
                </div>
            </div>
            <div id="weekly-comparison-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4" style="display: none;">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-blue-700">Tuần Được Chọn (<span id="selected-week-display"></span>)</h3>
                    <div class="summary-item"><span>Số Dư Đầu Tuần:</span><span id="current-week-start-balance" class="text-blue-600">0</span></div>
                    <div class="summary-item"><span>Tổng Thu Tuần Này:</span><span id="current-week-income" class="text-green-600">0</span></div>
                    <div class="summary-item"><span>Tổng Chi Tuần Này:</span><span id="current-week-expenses" class="text-red-600">0</span></div>
                    <div class="summary-item"><span>Thay Đổi Ròng:</span><span id="current-week-net-change" class="font-bold">0</span></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Tuần Trước Đó (<span id="previous-week-display"></span>)</h3>
                    <div class="summary-item"><span>Tổng Chi Tuần Trước:</span><span id="previous-week-expenses" class="text-red-600">0</span></div>
                    <hr class="my-3 border-gray-300">
                    <h3 class="text-lg font-semibold mb-2 text-purple-700">So Sánh Chi Tiêu</h3>
                    <div class="summary-item"><span>Chênh Lệch (Này - Trước):</span><span id="spending-difference" class="font-bold">0</span></div>
                </div>
            </div>
            <p id="no-comparison-data" class="text-center text-gray-500 mt-4">Chọn một năm và tuần để xem thống kê.</p>
        </div>

        <div class="table-section">
             <div class="table-actions">
                 <div class="filter-container">
                    <label for="filter-month">Lọc theo tháng:</label>
                    <select id="filter-month" class="p-2 border rounded-md"><option value="all">Tất cả</option></select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="transaction-table">
                    <thead>
                        <tr>
                            <th>Ngày & Giờ</th>
                            <th>Nội dung</th>
                            <th>Hạng mục</th>
                            <th>Số tiền (VNĐ)</th> <th>Loại</th>
                            <th>Tài khoản</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list">
                        </tbody>
                </table>
            </div>
            <p id="no-transactions" class="text-center text-gray-500 mt-4" style="display: none;">Chưa có giao dịch nào.</p>
        </div>
    </div>

    <script>
        // Register the datalabels plugin globally
        Chart.register(ChartDataLabels);

        // Constants
        const USD_TO_VND_RATE = 25000; // Define exchange rate

        // DOM Elements
        const transactionForm = document.getElementById('transaction-form');
        const formTitleEl = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-transaction-button');
        const transactionList = document.getElementById('transaction-list');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const currentBalanceEl = document.getElementById('current-balance');
        const accountBalanceListEl = document.getElementById('account-balance-list');
        const datetimeInput = document.getElementById('datetime-input');
        const categoryInput = document.getElementById('category');
        const amountTextInput = document.getElementById('amount-input'); // Input is text type
        const formCurrencySelector = document.getElementById('form-currency-selector');
        const descriptionInput = document.getElementById('description');
        const accountInput = document.getElementById('account');
        const noTransactionsMessage = document.getElementById('no-transactions');
        const filterMonthSelect = document.getElementById('filter-month');
        const messageBox = document.getElementById('message-box');
        const incomeExpenseChartCanvas = document.getElementById('incomeExpenseChart');
        const expenseCategoryChartCanvas = document.getElementById('expenseCategoryChart');
        const expenseCategoryListContainerEl = document.getElementById('expense-category-list-container');
        const noExpenseDataEl = document.getElementById('no-expense-data');
        const last7DaysChartCanvas = document.getElementById('last7DaysChart');
        const monthComparisonChartCanvas = document.getElementById('monthComparisonChart');
        const filterComparisonYearInput = document.getElementById('filter-comparison-year');
        const filterComparisonWeekSelect = document.getElementById('filter-comparison-week');
        const weeklyComparisonContentEl = document.getElementById('weekly-comparison-content');
        const selectedWeekDisplayEl = document.getElementById('selected-week-display');
        const currentWeekStartBalanceEl = document.getElementById('current-week-start-balance');
        const currentWeekIncomeEl = document.getElementById('current-week-income');
        const currentWeekExpensesEl = document.getElementById('current-week-expenses');
        const currentWeekNetChangeEl = document.getElementById('current-week-net-change');
        const previousWeekDisplayEl = document.getElementById('previous-week-display');
        const previousWeekExpensesEl = document.getElementById('previous-week-expenses');
        const spendingDifferenceEl = document.getElementById('spending-difference');
        const noComparisonDataEl = document.getElementById('no-comparison-data');
        const typeRadioButtons = document.querySelectorAll('input[name="type"]');

        let transactions = JSON.parse(localStorage.getItem('transactions_v2')) || [];
        let incomeExpenseChart;
        let expenseCategoryChart;
        let last7DaysChart;
        let monthComparisonChart;
        let editingTransactionId = null;

        const incomeCategories = [
            { value: "Lương", text: "Lương" }, { value: "Thưởng", text: "Thưởng" },
            { value: "Tiền được trả nợ", text: "Tiền được trả nợ" },
            { value: "Tiền được chuyển khoản", text: "Tiền được chuyển khoản (nhận)" },
            { value: "Lãi tiết kiệm", text: "Lãi tiết kiệm" },
            { value: "Thu nhập từ đầu tư", text: "Thu nhập từ đầu tư" },
            { value: "Thu nhập phụ", text: "Thu nhập phụ" },
            { value: "Thu nhập khác", text: "Thu nhập khác (chung)" }
        ];
        const expenseCategories = [
            { value: "Ăn uống", text: "Ăn uống" }, { value: "Đi lại", text: "Đi lại" },
            { value: "Nhà ở", text: "Nhà ở" },
            { value: "Hóa đơn", text: "Hóa đơn (Điện, nước, internet)" },
            { value: "Mua sắm", text: "Mua sắm (Quần áo, đồ dùng)" },
            { value: "Giải trí", text: "Giải trí" }, { value: "Sức khỏe", text: "Sức khỏe" },
            { value: "Giáo dục", text: "Giáo dục" }, { value: "Chi cho đầu tư", text: "Chi cho đầu tư" },
            { value: "Trả nợ", text: "Trả nợ (cho người khác)" },
            { value: "Chuyển khoản đi", text: "Chuyển khoản đi" },
            { value: "Chi phí khác", text: "Chi phí khác (chung)" }
        ];
        const categoryColors = [
            'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
            'rgba(199, 199, 199, 0.8)', 'rgba(83, 102, 255, 0.8)', 'rgba(40, 159, 64, 0.8)',
            'rgba(210, 99, 132, 0.8)', 'rgba(60, 100, 200, 0.8)'
        ];

        function showMessage(message, type = 'success') {
             messageBox.textContent = message;
             messageBox.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'text-green-800 bg-green-100 dark:bg-gray-800 dark:text-green-400' : 'text-red-800 bg-red-100 dark:bg-gray-800 dark:text-red-400'}`;
             messageBox.style.display = 'block';
             setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
         }

        /**
         * Formats a number as Vietnamese Dong (VNĐ).
         * @param {number} amount - The amount to format (always in VND).
         * @returns {string} - The formatted currency string.
         */
        function formatCurrency(amount) {
            const options = { style: 'currency', currency: 'VND' };
            const locale = 'vi-VN';
            // Allow decimals for VND display if needed
            options.minimumFractionDigits = 0;
            options.maximumFractionDigits = 2;
            if (isNaN(amount) || amount === null) {
                amount = 0;
            }
            return new Intl.NumberFormat(locale, options).format(amount);
        }


        function formatDateTimeLocalInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function formatIsoDateTime(date) {
             const year = date.getFullYear();
             const month = String(date.getMonth() + 1).padStart(2, '0');
             const day = String(date.getDate()).padStart(2, '0');
             const hours = String(date.getHours()).padStart(2, '0');
             const minutes = String(date.getMinutes()).padStart(2, '0');
             const seconds = String(date.getSeconds()).padStart(2, '0');
             return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
         }

        /**
         * Formats an ISO datetime string to 'YYYY-MM-DD HH:MM' for display.
         * @param {string} isoString - The ISO datetime string.
         * @returns {string} - The formatted display datetime string.
         */
        function formatDisplayDateTime(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return isoString;

                const year = date.getFullYear(); // Full year
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`; // Changed format
            } catch (e) {
                console.error("Error formatting display date/time:", e, "Input:", isoString);
                return isoString;
            }
        }

        function setDefaultDateTime() {
            datetimeInput.value = formatDateTimeLocalInput(new Date());
        }
        function setDefaultComparisonYear() {
            filterComparisonYearInput.value = new Date().getFullYear();
        }

        function populateCategories() {
            const selectedTypeRadio = document.querySelector('input[name="type"]:checked');
            const selectedType = selectedTypeRadio ? selectedTypeRadio.value : 'Chi';
            const currentCategoryValue = categoryInput.value;
            categoryInput.innerHTML = '';
            let categoriesToPopulate = (selectedType === 'Thu') ? incomeCategories : expenseCategories;

            categoriesToPopulate.forEach(category => {
                const option = document.createElement('option');
                option.value = category.value;
                option.textContent = category.text;
                categoryInput.appendChild(option);
            });
             if (categoriesToPopulate.some(cat => cat.value === currentCategoryValue)) {
                 categoryInput.value = currentCategoryValue;
             } else if (categoriesToPopulate.length > 0) {
                 categoryInput.value = categoriesToPopulate[0].value;
             }
        }

        function getISOWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

         function getWeekIdFromDateTime(dateTimeStr) {
            if (!dateTimeStr) return null;
            try {
                const date = new Date(dateTimeStr);
                 if (isNaN(date.getTime())) return null;
                const utcDate = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const weekYear = new Date(Date.UTC(utcDate.getFullYear(), utcDate.getMonth(), utcDate.getDate() + 4 - (utcDate.getUTCDay()||7))).getUTCFullYear();
                const weekNum = getISOWeekNumber(date);
                return `${weekYear}-W${String(weekNum).padStart(2, '0')}`;
            } catch (e) {
                 console.error("Error getting week ID from datetime:", e, "Input:", dateTimeStr);
                 return null;
            }
        }

        function getStartDateOfISOWeek(year, week) {
            const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const dow = simple.getUTCDay();
            const ISOweekStart = new Date(simple);
            if (dow <= 4) {
                ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
            } else {
                ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
            }
            return ISOweekStart;
        }

        function getWeekDates(weekId) {
            if (!weekId || !weekId.includes('-W')) return { start: null, end: null };
            const [yearStr, weekNumStr] = weekId.split('-W');
            const year = parseInt(yearStr, 10);
            const week = parseInt(weekNumStr, 10);
            if (isNaN(year) || isNaN(week) || week < 1 || week > 53) return { start: null, end: null };

            const startDate = getStartDateOfISOWeek(year, week);
            const endDate = new Date(startDate);
            endDate.setUTCDate(startDate.getUTCDate() + 6);

            const formatDate = (d) => d.toISOString().split('T')[0];
            return { start: formatDate(startDate), end: formatDate(endDate) };
        }
        function getNumberOfISOWeeks(year) {
            const dec28 = new Date(Date.UTC(year, 11, 28));
            return getISOWeekNumber(dec28);
        }
        function getAllWeekIdsInYear(year) {
            const weekIds = [];
            const numWeeks = getNumberOfISOWeeks(year);
            for (let i = 1; i <= numWeeks; i++) {
                weekIds.push(`${year}-W${String(i).padStart(2, '0')}`);
            }
            return weekIds;
        }
        function getPreviousWeekId(weekId) {
            if (!weekId || !weekId.includes('-W')) return null;
            const [yearStr, weekNumStr] = weekId.split('-W');
            let year = parseInt(yearStr, 10);
            let week = parseInt(weekNumStr, 10);

            if (week === 1) {
                year -= 1;
                week = getNumberOfISOWeeks(year);
            } else {
                week -= 1;
            }
            return `${year}-W${String(week).padStart(2, '0')}`;
        }

        function renderMainTransactions(filteredTransactions = transactions) {
            transactionList.innerHTML = '';
            noTransactionsMessage.style.display = filteredTransactions.length === 0 ? 'block' : 'none';

             if (filteredTransactions.length === 0 && transactions.length > 0 && filterMonthSelect.value !== 'all') {
                 noTransactionsMessage.textContent = 'Không có giao dịch nào cho tháng đã chọn.';
            } else if (transactions.length === 0) {
                noTransactionsMessage.textContent = 'Chưa có giao dịch nào.';
            }

            filteredTransactions.forEach(transaction => {
                const row = transactionList.insertRow();
                const transactionIdForButton = Number(transaction.id);
                row.innerHTML = `
                    <td>${formatDisplayDateTime(transaction.datetime)}</td> <td>${transaction.description || ''}</td>
                    <td>${transaction.category}</td>
                    <td class="${transaction.type === 'Thu' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(transaction.amount)}</td>
                    <td>${transaction.type}</td>
                    <td>${transaction.account}</td>
                    <td><button class="btn-edit text-xs px-2 py-1" onclick="loadTransactionForEdit(${transactionIdForButton})">Sửa</button></td>
                `;
            });
            updateAllSummariesAndCharts(filteredTransactions);
            populateMonthFilter();
        }

        function updateAllSummariesAndCharts(transactionsToAnalyze = transactions) {
             updateMainSummaryAndChart(transactionsToAnalyze);
             renderExpenseCategoryChartAndList(transactionsToAnalyze);
             updateAccountBalances();
             renderLast7DaysChart();
             renderMonthComparisonChart();
        }

        function updateMainSummaryAndChart(summaryTransactions = transactions) {
            const income = summaryTransactions.filter(t => t.type === 'Thu').reduce((sum, t) => sum + t.amount, 0);
            const expenses = summaryTransactions.filter(t => t.type === 'Chi').reduce((sum, t) => sum + t.amount, 0);

            totalIncomeEl.textContent = formatCurrency(income);
            totalExpensesEl.textContent = formatCurrency(expenses);
            currentBalanceEl.textContent = formatCurrency(income - expenses);

            renderOrUpdateMainChart(income, expenses);
        }

        function renderOrUpdateMainChart(income, expenses) {
             try {
                const total = income + expenses;
                const data = {
                    labels: ['Tổng Thu', 'Tổng Chi'],
                    datasets: [{
                        label: `Số tiền (VNĐ)`,
                        data: [income, expenses],
                        backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Biểu Đồ Thu vs Chi (Tháng Lọc - VNĐ)' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed;
                                    label += formatCurrency(value);
                                    if (total > 0) {
                                        const percentage = (value / total * 100).toFixed(1);
                                        label += ` (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, context) => {
                                if (total === 0) return '0%';
                                const percentage = (value / total * 100).toFixed(1) + '%';
                                return percentage;
                            },
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                };

                if (incomeExpenseChart) {
                    incomeExpenseChart.data = data;
                    incomeExpenseChart.options = options;
                    incomeExpenseChart.update();
                } else {
                    incomeExpenseChart = new Chart(incomeExpenseChartCanvas, {
                        type: 'pie',
                        data: data,
                        options: options
                    });
                }
             } catch (error) {
                 console.error("Error rendering/updating main income/expense chart:", error);
                 showMessage("Lỗi khi vẽ biểu đồ thu chi.", "error");
             }
        }

        function renderExpenseCategoryChartAndList(transactionsToAnalyze = transactions) {
            const expensesByCategory = {};
            let totalExpenses = 0;

            transactionsToAnalyze
                .filter(t => t.type === 'Chi')
                .forEach(t => {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                    totalExpenses += t.amount;
                });

            const categories = Object.keys(expensesByCategory);
            const amounts = Object.values(expensesByCategory);

            expenseCategoryListContainerEl.innerHTML = '';

            if (categories.length === 0 || totalExpenses === 0) {
                if(noExpenseDataEl) noExpenseDataEl.style.display = 'block';
                else console.warn("noExpenseDataEl not found");

                if (expenseCategoryChart) {
                    expenseCategoryChart.destroy();
                    expenseCategoryChart = null;
                }
                if(expenseCategoryChartCanvas) expenseCategoryChartCanvas.style.display = 'none';
                else console.warn("expenseCategoryChartCanvas not found");
                return;
            }

            if(noExpenseDataEl) noExpenseDataEl.style.display = 'none';
            if(expenseCategoryChartCanvas) expenseCategoryChartCanvas.style.display = 'block';


            const chartData = {
                labels: categories,
                datasets: [{
                    label: 'Chi tiêu theo hạng mục',
                    data: amounts,
                    backgroundColor: categories.map((_, index) => categoryColors[index % categoryColors.length]),
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            };

            if (expenseCategoryChart) {
                expenseCategoryChart.data = chartData;
                expenseCategoryChart.update();
            } else {
                if(expenseCategoryChartCanvas){
                    expenseCategoryChart = new Chart(expenseCategoryChartCanvas, {
                        type: 'doughnut',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { padding: 15, boxWidth: 12 }
                                },
                                title: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) { label += ': '; }
                                            const value = context.parsed;
                                            const percentage = totalExpenses > 0 ? (value / totalExpenses * 100).toFixed(1) : 0;
                                            label += formatCurrency(value) + ` (${percentage}%)`;
                                            return label;
                                        }
                                    }
                                },
                                datalabels: {
                                    formatter: (value, context) => {
                                        if (totalExpenses === 0) return '0%';
                                        const percentage = (value / totalExpenses * 100).toFixed(1) + '%';
                                        return percentage;
                                    },
                                    color: '#fff',
                                    font: {
                                        weight: 'bold',
                                        size: 10
                                    },
                                    display: function(context) {
                                        return (context.dataset.data[context.dataIndex] / totalExpenses * 100) > 5;
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.error("expenseCategoryChartCanvas is not available to create new chart.");
                }
            }

            categories.forEach((category, index) => {
                const amount = expensesByCategory[category];
                const percentage = totalExpenses > 0 ? (amount / totalExpenses * 100).toFixed(1) : 0;
                const color = categoryColors[index % categoryColors.length];

                const itemEl = document.createElement('div');
                itemEl.className = 'expense-category-item';
                itemEl.innerHTML = `
                    <div>
                        <span class="category-color-swatch" style="background-color: ${color};"></span>
                        <span class="category-name">${category}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="category-percentage">${percentage}%</span>
                        <span class="category-amount text-red-600">${formatCurrency(amount)}</span>
                    </div>
                `;
                expenseCategoryListContainerEl.appendChild(itemEl);
            });
            const totalItemEl = document.createElement('div');
            totalItemEl.className = 'expense-category-item font-semibold mt-2 pt-2 border-t border-gray-300';
            totalItemEl.innerHTML = `
                <span>Tổng chi tiêu</span>
                <span class="text-red-600">${formatCurrency(totalExpenses)}</span>
            `;
            expenseCategoryListContainerEl.appendChild(totalItemEl);
        }

        function updateAccountBalances() {
            const accountBalances = {};
            const uniqueAccounts = [...new Set(transactions.map(t => t.account))];
            uniqueAccounts.forEach(account => { accountBalances[account] = 0; });

            transactions.forEach(t => {
                if (accountBalances.hasOwnProperty(t.account)) {
                    accountBalances[t.account] += (t.type === 'Thu' ? t.amount : -t.amount);
                }
            });

            if (accountBalanceListEl) {
                accountBalanceListEl.innerHTML = '<h3>Số Dư Theo Tài Khoản (Tổng thể - VNĐ):</h3>';
                if (uniqueAccounts.length === 0) {
                     accountBalanceListEl.innerHTML += '<p class="text-gray-500 text-sm">Chưa có tài khoản nào được sử dụng.</p>';
                } else {
                    uniqueAccounts.sort().forEach(account => {
                        const balance = accountBalances[account];
                        const balanceColor = balance >= 0 ? 'text-blue-600' : 'text-red-600';
                        accountBalanceListEl.innerHTML += `
                            <div class="summary-item text-sm">
                                <span>${account}:</span>
                                <span class="${balanceColor} font-medium">${formatCurrency(balance)}</span>
                            </div>
                        `;
                    });
                }
            } else {
                console.error("Element with ID 'account-balance-list' not found.");
            }
        }

        function renderLast7DaysChart() {
             try {
                const today = new Date();
                const daysData = [];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(today.getDate() - i);
                    const dateString = formatDateTimeLocalInput(date).split('T')[0];
                    const dateLabel = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
                    daysData.push({ date: dateString, label: dateLabel, expense: 0 });
                }

                transactions.forEach(t => {
                    if (t.type === 'Chi' && t.datetime) {
                        try {
                            const transactionDate = new Date(t.datetime);
                             if (!isNaN(transactionDate.getTime())) {
                                const transactionDateString = formatDateTimeLocalInput(transactionDate).split('T')[0];
                                const dayEntry = daysData.find(d => d.date === transactionDateString);
                                if (dayEntry) {
                                    dayEntry.expense += t.amount;
                                }
                             } else {
                                 console.warn("Invalid datetime found in transaction for 7-day chart:", t);
                             }
                        } catch (dateError) {
                             console.error("Error processing datetime for 7-day chart transaction:", t, dateError);
                        }
                    }
                });


                const chartLabels = daysData.map(d => d.label);
                const chartDataPoints = daysData.map(d => d.expense);

                const data = {
                    labels: chartLabels,
                    datasets: [{
                        label: `Chi tiêu (VNĐ)`,
                        data: chartDataPoints,
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: 'rgba(220, 38, 38, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                };

                if (last7DaysChart) {
                    last7DaysChart.destroy();
                }
                last7DaysChart = new Chart(last7DaysChartCanvas, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { return formatCurrency(value); }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                     label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Error rendering/updating last 7 days chart:", error);
                showMessage("Lỗi khi vẽ biểu đồ 7 ngày qua.", "error");
            }
        }
        function renderMonthComparisonChart() {
             try {
                let currentMonthFilter = filterMonthSelect.value;
                let currentYear, currentMonth;

                if (currentMonthFilter === 'all') {
                    const today = new Date();
                    currentYear = today.getFullYear();
                    currentMonth = today.getMonth() + 1;
                    currentMonthFilter = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                } else {
                    [currentYear, currentMonth] = currentMonthFilter.split('-').map(Number);
                }

                let prevYear = currentYear;
                let prevMonth = currentMonth - 1;
                if (prevMonth === 0) {
                    prevMonth = 12;
                    prevYear -= 1;
                }
                const prevMonthFilter = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;

                const currentMonthTransactions = transactions.filter(t => t.datetime && t.datetime.startsWith(currentMonthFilter));
                const prevMonthTransactions = transactions.filter(t => t.datetime && t.datetime.startsWith(prevMonthFilter));

                const currentMonthIncome = currentMonthTransactions.filter(t => t.type === 'Thu').reduce((sum, t) => sum + t.amount, 0);
                const currentMonthExpenses = currentMonthTransactions.filter(t => t.type === 'Chi').reduce((sum, t) => sum + t.amount, 0);
                const prevMonthIncome = prevMonthTransactions.filter(t => t.type === 'Thu').reduce((sum, t) => sum + t.amount, 0);
                const prevMonthExpenses = prevMonthTransactions.filter(t => t.type === 'Chi').reduce((sum, t) => sum + t.amount, 0);

                const labels = [`Tháng ${prevMonth}/${prevYear}`, `Tháng ${currentMonth}/${currentYear}`];
                const data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Tổng Thu',
                            data: [prevMonthIncome, currentMonthIncome],
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Tổng Chi',
                            data: [prevMonthExpenses, currentMonthExpenses],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                };

                if (monthComparisonChart) {
                    monthComparisonChart.data = data;
                    monthComparisonChart.update();
                } else {
                    monthComparisonChart = new Chart(monthComparisonChartCanvas, {
                        type: 'bar',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: function(value) { return formatCurrency(value); } }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'So Sánh Thu Chi Tháng Này và Tháng Trước (VNĐ)'
                                },
                                tooltip: {
                                    callbacks: {
                                         label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed.y !== null) {
                                                label += formatCurrency(context.parsed.y);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
             } catch (error) {
                 console.error("Error rendering/updating month comparison chart:", error);
                 showMessage("Lỗi khi vẽ biểu đồ so sánh tháng.", "error");
             }
        }

        window.loadTransactionForEdit = function(transactionId) {
            const idToEdit = Number(transactionId);
            if (isNaN(idToEdit)) {
                showMessage('Lỗi: ID giao dịch không hợp lệ để sửa.', 'error');
                return;
            }

            const transactionToEdit = transactions.find(t => t.id === idToEdit);
            if (transactionToEdit) {
                datetimeInput.value = transactionToEdit.datetime;
                const typeRadioToSelect = document.querySelector(`input[name="type"][value="${transactionToEdit.type}"]`);
                if (typeRadioToSelect) typeRadioToSelect.checked = true;

                populateCategories();
                categoryInput.value = transactionToEdit.category;
                // Display the stored VND amount. User needs to re-enter considering the input rules.
                amountTextInput.value = transactionToEdit.amount / 1000; // Display amount / 1000 for VNĐ (x1000) input
                descriptionInput.value = transactionToEdit.description || '';
                accountInput.value = transactionToEdit.account;
                formCurrencySelector.value = 'VND'; // Default to VND for editing

                editingTransactionId = idToEdit;
                formTitleEl.textContent = "Sửa Giao Dịch";
                submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg> Cập Nhật Giao Dịch`;
                submitButton.classList.remove('btn-primary');
                submitButton.classList.add('btn-edit');
                transactionForm.scrollIntoView({ behavior: 'smooth' });
            } else {
                showMessage('Lỗi: Không tìm thấy giao dịch để sửa (ID: ' + idToEdit + ').', 'error');
                console.error("Transaction not found for ID:", idToEdit, "Available IDs:", transactions.map(t=>t.id));
            }
         }

        /**
         * Parses the amount input from text, handling potential commas and converting based on selected currency.
         * @param {string} amountStr - The input string from the amount field.
         * @param {string} currency - The selected currency ('VND' or 'USD').
         * @returns {number | null} - The parsed numeric amount in VND or null if invalid.
         */
        function parseAmountInput(amountStr, currency) {
            if (!amountStr) return null;
            // Replace comma with dot for decimal parsing, remove other non-numeric except dot
            const cleanedAmountStr = amountStr.replace(/,/g, '.').replace(/[^\d.]/g, '');
            const numericAmount = parseFloat(cleanedAmountStr);

            if (isNaN(numericAmount) || numericAmount < 0) {
                return null; // Invalid number or negative
            }

            let amountInVND;
            if (currency === 'USD') {
                amountInVND = numericAmount * USD_TO_VND_RATE;
            } else { // Assume VND
                amountInVND = numericAmount * 1000; // Multiply by 1000 if VND is selected
            }

            // Ensure amountInVND is a valid number after potential conversion/multiplication
            if (isNaN(amountInVND)) {
                 return null;
            }

            return amountInVND;
        }


        function handleTransactionSubmit(e) {
            e.preventDefault();

            const currentDateTime = datetimeInput.value;
            const currentDescription = descriptionInput.value.trim();
            const currentCategory = categoryInput.value;
            const selectedTypeRadio = document.querySelector('input[name="type"]:checked');
            const currentType = selectedTypeRadio ? selectedTypeRadio.value : null;
            const currentAccount = accountInput.value;
            const amountStr = amountTextInput.value; // Get value from text input
            const selectedFormCurrency = formCurrencySelector.value;

            const amountInVND = parseAmountInput(amountStr, selectedFormCurrency); // Use parsing function

            // Validation
            if (!currentDateTime || !currentCategory || amountInVND === null || !currentType || !currentAccount) {
                showMessage('Vui lòng điền đầy đủ Ngày & Giờ, Hạng mục, Số tiền hợp lệ, Tài khoản và chọn Loại giao dịch.', 'error');
                console.log("Validation failed:", {currentDateTime, currentCategory, amountEntered: amountStr, amountInVND, currentType, currentAccount});
                return;
            }
             if (amountInVND <= 0) {
                 showMessage('Số tiền cuối cùng (sau quy đổi/nhân) phải lớn hơn 0.', 'error');
                 return;
             }


            if (editingTransactionId !== null) {
                const idBeingEdited = Number(editingTransactionId);
                const transactionIndex = transactions.findIndex(t => t.id === idBeingEdited);
                if (transactionIndex !== -1) {
                    transactions[transactionIndex] = {
                        ...transactions[transactionIndex],
                        datetime: currentDateTime,
                        type: currentType,
                        category: currentCategory,
                        amount: amountInVND, // Store the final VND amount
                        description: currentDescription,
                        account: currentAccount,
                        lastModified: formatIsoDateTime(new Date())
                    };
                    showMessage('Cập nhật giao dịch thành công!', 'success');
                } else {
                    showMessage('Lỗi: Không tìm thấy giao dịch để cập nhật (ID: ' + idBeingEdited + ').', 'error');
                    editingTransactionId = null;
                }
            } else {
                const newTransaction = {
                    id: Number(Date.now()),
                    datetime: currentDateTime,
                    description: currentDescription,
                    category: currentCategory,
                    amount: amountInVND, // Store the final VND amount
                    type: currentType,
                    account: currentAccount,
                    createdAt: formatIsoDateTime(new Date())
                };
                transactions.push(newTransaction);
                showMessage('Thêm giao dịch thành công!', 'success');
            }

            transactions.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            localStorage.setItem('transactions_v2', JSON.stringify(transactions));

            applyMainFilter();
            populateComparisonWeekFilter();
            updateWeeklyComparisonDisplay();

            editingTransactionId = null;
            formTitleEl.textContent = "Thêm Giao Dịch Mới";
            submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Thêm Giao Dịch`;
            submitButton.classList.remove('btn-edit');
            submitButton.classList.add('btn-primary');
            transactionForm.reset();
            setDefaultDateTime();
            document.getElementById('type-chi').checked = true;
            populateCategories();
            formCurrencySelector.value = 'VND'; // Reset form currency selector to VND
         }

        function populateMonthFilter() {
            const currentFilterValue = filterMonthSelect.value;
            const months = new Set(transactions.map(t => t.datetime ? t.datetime.substring(0, 7) : ''));
            filterMonthSelect.innerHTML = '<option value="all">Tất cả các tháng</option>';

            Array.from(months)
                .filter(m => m)
                .sort()
                .reverse()
                .forEach(month => {
                    const [year, monthNum] = month.split('-');
                    filterMonthSelect.add(new Option(`Tháng ${monthNum}, Năm ${year}`, month));
                });
            filterMonthSelect.value = months.has(currentFilterValue) ? currentFilterValue : 'all';
         }

        function filterTransactionsByMonth() {
            const selectedMonth = filterMonthSelect.value;
            const filtered = selectedMonth === "all"
                ? transactions
                : transactions.filter(t => t.datetime && t.datetime.startsWith(selectedMonth));
            renderMainTransactions(filtered);
         }

        function applyMainFilter() {
            filterTransactionsByMonth();
        }

        function populateComparisonWeekFilter() {
            const year = parseInt(filterComparisonYearInput.value, 10);
            filterComparisonWeekSelect.innerHTML = '<option value="none">-- Chọn tuần --</option>';
            if (isNaN(year) || year < 2000 || year > 2100) {
                noComparisonDataEl.textContent = "Vui lòng chọn một năm hợp lệ.";
                noComparisonDataEl.style.display = 'block';
                weeklyComparisonContentEl.style.display = 'none';
                return;
            }

            const weekIds = getAllWeekIdsInYear(year);
            weekIds.reverse().forEach(weekId => {
                const { start, end } = getWeekDates(weekId);
                if (start && end) {
                    const option = document.createElement('option');
                    option.value = weekId;
                    const startDateDisplay = formatDisplayDateTime(start + "T00:00").split(' ')[0]; // Show YYYY-MM-DD
                    const endDateDisplay = formatDisplayDateTime(end + "T23:59").split(' ')[0]; // Show YYYY-MM-DD
                    option.textContent = `${weekId} (${startDateDisplay} - ${endDateDisplay})`;
                    filterComparisonWeekSelect.appendChild(option);
                }
            });
             const todayDateTimeStr = formatDateTimeLocalInput(new Date());
             const currentWeekId = getWeekIdFromDateTime(todayDateTimeStr);
            if (currentWeekId && weekIds.includes(currentWeekId)) {
                filterComparisonWeekSelect.value = currentWeekId;
            } else if (weekIds.length > 0) {
                 filterComparisonWeekSelect.value = weekIds[0];
             }
        }

        function calculateWeeklyStats(transactionsInPeriod, weekStartDateStr) {
            const income = transactionsInPeriod.filter(t => t.type === 'Thu').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactionsInPeriod.filter(t => t.type === 'Chi').reduce((sum, t) => sum + t.amount, 0);
            const netChange = income - expenses;

            let startBalance = 0;
            if (weekStartDateStr) {
                 startBalance = transactions
                    .filter(t => t.datetime && t.datetime < weekStartDateStr + "T00:00:00")
                    .reduce((balance, t) => balance + (t.type === 'Thu' ? t.amount : -t.amount), 0);
            }
            return { income, expenses, netChange, startBalance };
        }

        function updateWeeklyComparisonDisplay() {
            const selectedWeekId = filterComparisonWeekSelect.value;
            const selectedYear = parseInt(filterComparisonYearInput.value, 10);

            if (selectedWeekId === 'none' || isNaN(selectedYear)) {
                weeklyComparisonContentEl.style.display = 'none';
                noComparisonDataEl.textContent = "Chọn một năm và tuần để xem thống kê.";
                noComparisonDataEl.style.display = 'block';
                return;
            }

            const { start: currentWeekStart, end: currentWeekEnd } = getWeekDates(selectedWeekId);
            if (!currentWeekStart || !currentWeekEnd) {
                weeklyComparisonContentEl.style.display = 'none';
                noComparisonDataEl.textContent = "Dữ liệu tuần không hợp lệ.";
                noComparisonDataEl.style.display = 'block';
                return;
            }

            const currentWeekTransactions = transactions.filter(t => {
                if (!t.datetime) return false;
                const transactionDate = t.datetime.split('T')[0];
                return transactionDate >= currentWeekStart && transactionDate <= currentWeekEnd;
            });
            const currentWeekStats = calculateWeeklyStats(currentWeekTransactions, currentWeekStart);

            const previousWeekId = getPreviousWeekId(selectedWeekId);
            let previousWeekExpenses = 0;
            let prevWeekDisplay = "Không có";
            if (previousWeekId) {
                const { start: prevWeekStart, end: prevWeekEnd } = getWeekDates(previousWeekId);
                if (prevWeekStart && prevWeekEnd) {
                    const prevWeekTransactions = transactions.filter(t => {
                         if (!t.datetime) return false;
                        const transactionDate = t.datetime.split('T')[0];
                        return transactionDate >= prevWeekStart && transactionDate <= prevWeekEnd;
                    });
                    const prevWeekStats = calculateWeeklyStats(prevWeekTransactions, prevWeekStart);
                    previousWeekExpenses = prevWeekStats.expenses;
                    prevWeekDisplay = `${previousWeekId.split('-W')[1]} (${formatDisplayDateTime(prevWeekStart+"T00:00").split(' ')[0]})`;
                }
            }

            selectedWeekDisplayEl.textContent = `${selectedWeekId.split('-W')[1]} (${formatDisplayDateTime(currentWeekStart+"T00:00").split(' ')[0]})`;
            currentWeekStartBalanceEl.textContent = formatCurrency(currentWeekStats.startBalance);
            currentWeekIncomeEl.textContent = formatCurrency(currentWeekStats.income);
            currentWeekExpensesEl.textContent = formatCurrency(currentWeekStats.expenses);
            currentWeekNetChangeEl.textContent = formatCurrency(currentWeekStats.netChange);
            currentWeekNetChangeEl.className = currentWeekStats.netChange >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';

            previousWeekDisplayEl.textContent = prevWeekDisplay;
            previousWeekExpensesEl.textContent = formatCurrency(previousWeekExpenses);

            const spendingDiff = currentWeekStats.expenses - previousWeekExpenses;
            spendingDifferenceEl.textContent = formatCurrency(spendingDiff);
            spendingDifferenceEl.className = spendingDiff > 0 ? 'font-bold text-red-600' : (spendingDiff < 0 ? 'font-bold text-green-600' : 'font-bold');

            weeklyComparisonContentEl.style.display = 'grid';
            noComparisonDataEl.style.display = 'none';
        }

        // --- Event Listener for Currency Change (Form Only - No global effect) ---
        // No listener needed as it doesn't change global state

        // --- Initial Load ---
        function initializeApp() {
            formCurrencySelector.value = 'VND'; // Default form selector to VND
            setDefaultDateTime();
            setDefaultComparisonYear();
            document.getElementById('type-chi').checked = true;
            populateCategories();
            populateMonthFilter();
            applyMainFilter(); // Renders everything in VND
            populateComparisonWeekFilter();
            updateWeeklyComparisonDisplay(); // Displays weekly comparison in VND
        }

        // Event Listeners
        transactionForm.addEventListener('submit', handleTransactionSubmit);
        filterMonthSelect.addEventListener('change', filterTransactionsByMonth);
        typeRadioButtons.forEach(radio => {
            radio.addEventListener('change', populateCategories);
        });
        filterComparisonYearInput.addEventListener('change', () => {
            populateComparisonWeekFilter();
            updateWeeklyComparisonDisplay();
        });
        filterComparisonYearInput.addEventListener('input', () => {
             populateComparisonWeekFilter();
        });
        filterComparisonWeekSelect.addEventListener('change', updateWeeklyComparisonDisplay);

        initializeApp(); // Run initialization

    </script>
</body>
</html>
