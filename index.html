<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ Theo Dõi Tài Chính Cá Nhân</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }
        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .section-header .header-text-icon {
            display: flex;
            align-items: center;
        }
        .section-header svg:not(.toggle-icon) {
             width: 1.5rem;
             height: 1.5rem;
             margin-right: 0.5rem;
             color: #3b82f6;
        }
        .collapsible-content {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .collapsible-content.active {
            display: block;
        }
        .toggle-icon {
            transition: transform 0.3s ease;
            width: 1.25rem;
            height: 1.25rem;
            color: #374151;
        }
        .section-header.active .toggle-icon {
            transform: rotate(180deg);
        }
        label {
            font-weight: 500;
            color: #374151;
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="datetime-local"], input[type="date"], select, input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
         input#amount-input[type="text"] { }

        input[type="text"]:focus, input[type="datetime-local"]:focus, input[type="date"]:focus, select:focus, input[type="number"]:focus {
            border-color: #3b82f6;
            outline: none;
        }
        .radio-group {
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .radio-group label {
            margin-right: 15px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 0;
        }
        .radio-group input[type="radio"] {
            margin-right: 5px;
            accent-color: #3b82f6;
        }
        .amount-currency-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .amount-currency-group input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .amount-currency-group select {
            width: auto;
            margin-bottom: 0;
            padding: 10px 8px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
         button svg {
             width: 1.25rem;
             height: 1.25rem;
             margin-right: 0.375rem;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
             background-color: #6b7280;
             color: white;
        }
         .btn-secondary:hover {
             background-color: #4b5563;
        }
        .btn-edit {
            background-color: #f59e0b;
            color: white;
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-right: 4px;
        }
        .btn-edit svg {
             width: 0.9rem;
             height: 0.9rem;
             margin-right: 2px;
        }
        .btn-edit:hover {
            background-color: #d97706;
        }
        .btn-delete {
            background-color: #ef4444;
            color: white;
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        .btn-delete svg {
             width: 0.9rem;
             height: 0.9rem;
             margin-right: 2px;
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
            font-size: 0.9rem;
        }
        th:last-child, td:last-child {
            width: 130px; /* Increased width for two buttons */
            text-align: center;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #1f2937;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e5e7eb;
            font-size: 0.95rem;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item span:first-child {
            font-weight: 500;
            color: #374151;
        }
        .summary-item span:last-child {
            font-weight: 600;
        }
        .account-balance-list {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        .account-balance-list h3 {
             font-size: 1.1rem;
             font-weight: 600;
             color: #4b5563;
             margin-bottom: 10px;
        }
        .text-green-600 { color: #059669; }
        .text-red-600 { color: #dc2626; }
        .text-blue-600 { color: #2563eb; }
        .text-purple-600 { color: #7c3aed; }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        .filter-container label { margin-bottom: 0; margin-right: 5px;}
        .filter-container input[type="number"], .filter-container select {
            margin-bottom: 0;
            flex-grow: 1;
        }
        #message-box {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
        }
        .message-success { background-color: #d1fae5; color: #065f46; }
        .message-error { background-color: #fee2e2; color: #991b1b; }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        .expense-breakdown-section .chart-container {
            max-width: 350px;
            height: 350px;
        }
        .expense-category-list {
            margin-top: 20px;
        }
        .expense-category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .expense-category-item:last-child {
            border-bottom: none;
        }
        .category-color-swatch {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
            display: inline-block;
        }
        .category-name {
            flex-grow: 1;
        }
        .category-percentage {
            width: 50px;
            text-align: right;
            color: #6b7280;
            margin-left: 10px;
        }
        .category-amount {
            width: 100px;
            text-align: right;
            font-weight: 500;
            margin-left: 10px;
        }
        .comparison-section .grid > div {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }
         .comparison-section h3 {
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 5px;
            margin-top: 0;
        }
         .table-actions {
             display: flex;
             justify-content: flex-end;
             margin-bottom: 20px;
        }
        .data-io-section .button-group {
             display: flex;
             gap: 1rem;
             flex-wrap: wrap;
        }
         .form-field-transfer { display: none; }
         .form-field-normal { display: block; }
         form[data-transaction-mode="Transfer"] .form-field-transfer { display: block; }
         form[data-transaction-mode="Transfer"] .form-field-normal { display: none; }

         .category-customization-section .category-management {
             display: grid;
             grid-template-columns: 1fr;
             gap: 2rem;
         }
         @media (min-width: 768px) {
             .category-customization-section .category-management {
                 grid-template-columns: 1fr 1fr;
             }
         }
         .category-customization-section .category-list {
             list-style: none;
             padding: 0;
         }
         .category-customization-section .category-list li {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.5rem 0;
             border-bottom: 1px solid #eee;
         }
         .category-customization-section .category-list li:last-child {
             border-bottom: none;
         }
         .category-customization-section input[type="text"] {
             margin-bottom: 0.5rem;
         }
         .category-customization-section .btn-add-category {
             width: 100%;
             margin-top: 0.5rem;
         }
         .category-customization-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.75rem;
            padding-bottom: 0.375rem;
            border-bottom: 1px solid #e5e7eb;
         }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600">Sổ Theo Dõi Tài Chính Cá Nhân</h1>
            <p class="text-gray-600">Ghi chép, quản lý thu chi hàng ngày và so sánh theo tuần.</p>
        </header>

        <div id="message-box" style="display: none;"></div>

        <div class="section form-section">
             <h2 class="section-header collapsible-header active" data-collapsible-target="form-content"> <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                    </svg>
                    <span id="form-title">Thêm Giao Dịch Mới</span>
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
            <div class="collapsible-content active" id="form-content">
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6" data-transaction-mode="Chi">
                    <div><label for="datetime-input">Ngày & Giờ:</label><input type="datetime-local" id="datetime-input" required></div>

                    <div>
                        <label>Loại giao dịch:</label>
                        <div class="radio-group">
                            <label for="type-thu"><input type="radio" id="type-thu" name="type" value="Thu" required> Thu</label>
                            <label for="type-chi"><input type="radio" id="type-chi" name="type" value="Chi" checked required> Chi</label>
                            <label for="type-transfer"><input type="radio" id="type-transfer" name="type" value="Transfer" required> Chuyển tiền</label>
                        </div>
                    </div>

                    <div class="form-field-normal"><label for="category">Hạng mục:</label><select id="category" required></select></div>

                    <div><label for="account" id="account-label">Tài khoản:</label><select id="account" required></select></div>

                    <div class="form-field-transfer"><label for="to-account">Đến Tài khoản:</label><select id="to-account"></select></div>

                    <div><label for="amount-input">Số tiền:</label><div class="amount-currency-group"><input type="text" inputmode="decimal" id="amount-input" placeholder="Nhập số (VD: 22.5 cho 22.500)" required><select id="form-currency-selector"><option value="VND">VNĐ (x1000)</option><option value="USD">USD (quy đổi)</option></select></div></div>

                    <div><label for="description">Nội dung chi tiết:</label><input type="text" id="description" placeholder="VD: Chuyển tiền học, Ăn trưa"></div>

                    <div class="md:col-span-2 mt-4"><button type="submit" id="submit-transaction-button" class="btn-primary w-full"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Thêm Giao Dịch</button></div>
                </form>
            </div>
        </div>

        <div class="section table-section">
             <h2 class="section-header collapsible-header active" data-collapsible-target="table-content"> <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5M3.375 19.5l1.95-1.95M12.375 19.5h8.875M12.375 19.5l-1.95-1.95M20.625 19.5a1.125 1.125 0 001.125-1.125M20.625 19.5l-1.95-1.95M3.75 4.5h16.5M3.75 4.5a2.25 2.25 0 00-2.25 2.25v11.25c0 1.24 1.01 2.25 2.25 2.25h16.5c1.24 0 2.25-1.01 2.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25M3.75 4.5v.75m16.5-.75v.75m0 0a2.25 2.25 0 01-2.25 2.25h-5.25a2.25 2.25 0 01-2.25-2.25m-5.25 0h5.25m-5.25 0a2.25 2.25 0 01-2.25-2.25M3.75 7.5v.75m16.5-.75v.75" /></svg>
                    Danh Sách Giao Dịch
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
             <div class="collapsible-content active" id="table-content"> <div class="table-actions">
                     <div class="filter-container"><label for="filter-month">Lọc theo tháng:</label><select id="filter-month" class="p-2 border rounded-md"><option value="all">Tất cả</option></select></div>
                </div>
                <div class="overflow-x-auto"><table id="transaction-table"><thead><tr><th>Ngày & Giờ</th><th>Nội dung</th><th>Hạng mục</th><th>Số tiền (VNĐ)</th><th>Loại</th><th>Tài khoản</th><th>Thao tác</th></tr></thead><tbody id="transaction-list"></tbody></table></div>
                <p id="no-transactions" class="text-center text-gray-500 mt-4" style="display: none;">Chưa có giao dịch nào.</p>
            </div>
        </div>

        <div class="section summary-section">
            <h2 class="section-header collapsible-header active" data-collapsible-target="summary-content-wrapper"> <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M18 10.2F18 6.57 15.314 4 12 4s-6 2.57-6 6.2c0 1.707.673 3.293 1.758 4.45l.149.149A6.086 6.086 0 0012 20.25a6.086 6.086 0 004.093-1.45l.149-.149A5.99 5.99 0 0018 10.2z" /></svg>
                    Tóm Tắt Tài Chính (VNĐ)
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
            <div class="collapsible-content active" id="summary-content-wrapper"> <div id="summary-content">
					<div class="summary-item"><span>Tổng Thu <span id="summary-income-month-display">(Tháng Lọc)</span>:</span><span id="total-income" class="text-green-600 font-semibold">0</span></div>
					<div class="summary-item"><span>Tổng Chi <span id="summary-expense-month-display">(Tháng Lọc)</span>:</span><span id="total-expenses" class="text-red-600 font-semibold">0</span></div>
					<div class="summary-item"><span>Số Dư <span id="summary-balance-month-display">(Tháng Lọc)</span>:</span><span id="current-balance" class="text-blue-600 font-bold">0</span></div>
                </div>
                <div id="account-balance-list" class="account-balance-list"><h3>Số Dư Theo Tài Khoản (Tổng thể - VNĐ):</h3></div>
            </div>
        </div>

        <div class="section expense-breakdown-section">
            <h2 class="section-header collapsible-header" data-collapsible-target="expense-breakdown-content">
				<div class="header-text-icon">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v.01M15.088 11.129l.793-.793a.75.75 0 011.06 1.06l-.792.792a3.751 3.751 0 01-5.304 0L8.12 9.364a.75.75 0 011.06-1.06l.793.793" /> <path stroke-linecap="round" stroke-linejoin="round" d="M12 12a3.752 3.752 0 00-2.716 1.116l-.79.79a.75.75 0 001.06 1.06l.79-.79A2.252 2.252 0 0112 13.5a2.252 2.252 0 011.588.656l.79.79a.75.75 0 101.06-1.06l-.79-.79A3.752 3.752 0 0012 12z" /></svg>
					<span id="expense-breakdown-title-text">Phân Loại Chi Tiêu (Tháng Lọc - VNĐ)</span>
				</div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
            <div class="collapsible-content" id="expense-breakdown-content">
                <div class="md:flex md:gap-6">
                    <div class="chart-container md:w-1/2"><canvas id="expenseCategoryChart"></canvas></div>
                    <div id="expense-category-list-container" class="expense-category-list md:w-1/2"><p id="no-expense-data" class="text-center text-gray-500 mt-4">Không có dữ liệu chi tiêu để hiển thị.</p></div>
                </div>
            </div>
        </div>

        <div class="section chart-section">
            <h2 class="section-header collapsible-header" data-collapsible-target="charts-grid-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M7.5 14.25V18a2.25 2.25 0 002.25 2.25h3.5A2.25 2.25 0 0015 18v-3.75M3.375 4.5c-.621 0-1.125.504-1.125 1.125v14.25c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H3.375z" /></svg>
                    Biểu Đồ Tổng Quan
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
            <div class="collapsible-content" id="charts-grid-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div> <h3 class="text-lg font-semibold mb-2 text-center" id="income-expense-chart-title">Biểu Đồ Thu vs Chi (Tháng Lọc - VNĐ)</h3>
                        <div class="chart-container"><canvas id="incomeExpenseChart"></canvas></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-center">Chi Tiêu 7 Ngày Qua (Biểu đồ đường - VNĐ)</h3>
                        <div class="chart-container"><canvas id="last7DaysChart"></canvas></div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-lg font-semibold mb-2 text-center">So Sánh Tháng Này & Tháng Trước (VNĐ)</h3>
                        <div class="chart-container"><canvas id="monthComparisonChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section comparison-section">
            <h2 class="section-header collapsible-header" data-collapsible-target="comparison-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-3.75h.008v.008H12v-.008zM12 12.75h.008v.008H12v-.008z" /></svg>
                    Thống Kê & So Sánh Tuần (VNĐ)
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
            <div class="collapsible-content" id="comparison-content">
                <div class="filter-container">
                    <div class="flex items-center"><label for="filter-comparison-year">Năm:</label><input type="number" id="filter-comparison-year" class="p-2 border rounded-md w-24" min="2000" max="2100"></div>
                    <div class="flex items-center flex-grow"><label for="filter-comparison-week">Tuần:</label><select id="filter-comparison-week" class="p-2 border rounded-md w-full"><option value="none">-- Chọn tuần --</option></select></div>
                </div>
                <div id="weekly-comparison-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4" style="display: none;">
                    <div><h3 class="text-lg font-semibold mb-2 text-blue-700">Tuần Được Chọn (<span id="selected-week-display"></span>)</h3><div class="summary-item"><span>Số Dư Đầu Tuần:</span><span id="current-week-start-balance" class="text-blue-600">0</span></div><div class="summary-item"><span>Tổng Thu Tuần Này:</span><span id="current-week-income" class="text-green-600">0</span></div><div class="summary-item"><span>Tổng Chi Tuần Này:</span><span id="current-week-expenses" class="text-red-600">0</span></div><div class="summary-item"><span>Thay Đổi Ròng:</span><span id="current-week-net-change" class="font-bold">0</span></div></div>
                    <div><h3 class="text-lg font-semibold mb-2 text-gray-700">Tuần Trước Đó (<span id="previous-week-display"></span>)</h3><div class="summary-item"><span>Tổng Chi Tuần Trước:</span><span id="previous-week-expenses" class="text-red-600">0</span></div><hr class="my-3 border-gray-300"><h3 class="text-lg font-semibold mb-2 text-purple-700">So Sánh Chi Tiêu</h3><div class="summary-item"><span>Chênh Lệch (Này - Trước):</span><span id="spending-difference" class="font-bold">0</span></div></div>
                </div>
                <p id="no-comparison-data" class="text-center text-gray-500 mt-4">Chọn một năm và tuần để xem thống kê.</p>
            </div>
        </div>
        <div class="section category-customization-section">
            <h2 class="section-header collapsible-header" data-collapsible-target="category-customization-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 0015 0m-15 0a7.5 7.5 0 1115 0m-15 0H3m18 0h-1.5m-15.036-7.026A7.5 7.5 0 015.974 3.474m12.052 0A7.5 7.5 0 0118.026 4.974m0 14.052a7.5 7.5 0 01-1.526 1.526M5.974 19.026A7.5 7.5 0 014.5 18m0-12a7.5 7.5 0 00-1.526 1.526M18 4.5a7.5 7.5 0 00-1.526-1.526" /></svg>
                    Tùy Chỉnh Hạng Mục
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
            <div class="collapsible-content" id="category-customization-content">
                <div class="category-management">
                    <div><h3>Hạng Mục Thu</h3><div class="mb-4"><label for="new-income-category-name">Tên hạng mục thu mới:</label><input type="text" id="new-income-category-name" placeholder="VD: Tiền cho thuê nhà"><button id="add-income-category-button" class="btn-primary btn-add-category"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Thêm Hạng Mục Thu</button></div><h4>Danh sách hạng mục thu:</h4><ul id="income-category-list-admin" class="category-list"></ul></div>
                    <div><h3>Hạng Mục Chi</h3><div class="mb-4"><label for="new-expense-category-name">Tên hạng mục chi mới:</label><input type="text" id="new-expense-category-name" placeholder="VD: Du lịch"><button id="add-expense-category-button" class="btn-primary btn-add-category"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Thêm Hạng Mục Chi</button></div><h4>Danh sách hạng mục chi:</h4><ul id="expense-category-list-admin" class="category-list"></ul></div>
                </div>
            </div>
        </div>

        <div class="section data-io-section">
            <h2 class="section-header collapsible-header" data-collapsible-target="data-io-content">
                <div class="header-text-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Quản lý Dữ liệu
                </div>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
            </h2>
            <div class="collapsible-content" id="data-io-content">
                <div class="button-group">
                    <button id="export-button" class="btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>Xuất Dữ Liệu (JSON)</button>
                    <button id="export-csv-button" class="btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        Xuất Dữ Liệu (CSV)
                    </button>
                    <button id="import-button" class="btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>Nhập Dữ Liệu (JSON)</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
                <p class="text-sm text-gray-500 mt-3">Lưu ý: Nhập dữ liệu sẽ ghi đè toàn bộ dữ liệu hiện tại.</p>
            </div>
        </div>
    </div>

    <script>
        // Register the datalabels plugin globally
        Chart.register(ChartDataLabels);

        // Constants
        const USD_TO_VND_RATE = 25000; 
        const TRANSFER_CATEGORY_OUT = "Chuyển tiền đi";
        const TRANSFER_CATEGORY_IN = "Nhận tiền chuyển";

        // DOM Elements (Thêm exportCsvButton)
        const transactionForm = document.getElementById('transaction-form');
        const formTitleEl = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-transaction-button');
        const transactionList = document.getElementById('transaction-list');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const currentBalanceEl = document.getElementById('current-balance');
        const accountBalanceListEl = document.getElementById('account-balance-list');
        const datetimeInput = document.getElementById('datetime-input');
        const categoryInput = document.getElementById('category');
        const categoryContainer = categoryInput.parentElement;
        const amountTextInput = document.getElementById('amount-input');
        const formCurrencySelector = document.getElementById('form-currency-selector');
        const descriptionInput = document.getElementById('description');
        const accountInput = document.getElementById('account');
        const accountLabel = document.getElementById('account-label');
        const toAccountContainer = document.querySelector('.form-field-transfer');
        const toAccountInput = document.getElementById('to-account');
        const noTransactionsMessage = document.getElementById('no-transactions');
        const filterMonthSelect = document.getElementById('filter-month');
        const messageBox = document.getElementById('message-box');
        const incomeExpenseChartCanvas = document.getElementById('incomeExpenseChart').getContext('2d');
        const expenseCategoryChartCanvas = document.getElementById('expenseCategoryChart').getContext('2d');
        const expenseCategoryListContainerEl = document.getElementById('expense-category-list-container');
        const noExpenseDataEl = document.getElementById('no-expense-data');
        const last7DaysChartCanvas = document.getElementById('last7DaysChart').getContext('2d');
        const monthComparisonChartCanvas = document.getElementById('monthComparisonChart').getContext('2d');
        const filterComparisonYearInput = document.getElementById('filter-comparison-year');
        const filterComparisonWeekSelect = document.getElementById('filter-comparison-week');
        const weeklyComparisonContentEl = document.getElementById('weekly-comparison-content');
        const selectedWeekDisplayEl = document.getElementById('selected-week-display');
        const currentWeekStartBalanceEl = document.getElementById('current-week-start-balance');
        const currentWeekIncomeEl = document.getElementById('current-week-income');
        const currentWeekExpensesEl = document.getElementById('current-week-expenses');
        const currentWeekNetChangeEl = document.getElementById('current-week-net-change');
        const previousWeekDisplayEl = document.getElementById('previous-week-display');
        const previousWeekExpensesEl = document.getElementById('previous-week-expenses');
        const spendingDifferenceEl = document.getElementById('spending-difference');
        const noComparisonDataEl = document.getElementById('no-comparison-data');
        const typeRadioButtons = document.querySelectorAll('input[name="type"]');
        const exportButton = document.getElementById('export-button');
        const exportCsvButton = document.getElementById('export-csv-button'); // Khai báo nút mới
        const importButton = document.getElementById('import-button');
        const importFileInput = document.getElementById('import-file-input');
        const newIncomeCategoryNameInput = document.getElementById('new-income-category-name');
        const addIncomeCategoryButton = document.getElementById('add-income-category-button');
        const incomeCategoryListAdminEl = document.getElementById('income-category-list-admin');
        const newExpenseCategoryNameInput = document.getElementById('new-expense-category-name');
        const addExpenseCategoryButton = document.getElementById('add-expense-category-button');
        const expenseCategoryListAdminEl = document.getElementById('expense-category-list-admin');

        let transactions = [];
        let incomeExpenseChart;
        let expenseCategoryChart;
        let last7DaysChart;
        let monthComparisonChart;
        let editingTransactionId = null;

        let incomeCategories = [];
        let expenseCategories = [];
        let accounts = [];

        const defaultIncomeCategories = [
            { value: "Lương", text: "Lương" }, { value: "Thưởng", text: "Thưởng" },
            { value: "Tiền được trả nợ", text: "Tiền được trả nợ" },
            { value: TRANSFER_CATEGORY_IN, text: "Nhận tiền chuyển khoản" },
            { value: "Lãi tiết kiệm", text: "Lãi tiết kiệm" },
            { value: "Thu nhập từ đầu tư", text: "Thu nhập từ đầu tư" },
            { value: "Thu nhập phụ", text: "Thu nhập phụ" },
            { value: "Thu nhập khác", text: "Thu nhập khác (chung)" }
        ];
        const defaultExpenseCategories = [
            { value: "Ăn uống", text: "Ăn uống" }, { value: "Đi lại", text: "Đi lại" },
            { value: "Nhà ở", text: "Nhà ở" },
            { value: "Hóa đơn", text: "Hóa đơn (Điện, nước, internet)" },
            { value: "Mua sắm", text: "Mua sắm (Quần áo, đồ dùng)" },
            { value: "Giải trí", text: "Giải trí" }, { value: "Sức khỏe", text: "Sức khỏe" },
            { value: "Giáo dục", text: "Giáo dục" }, { value: "Chi cho đầu tư", text: "Chi cho đầu tư" },
            { value: "Trả nợ", text: "Trả nợ (cho người khác)" },
            { value: TRANSFER_CATEGORY_OUT, text: "Chuyển tiền đi" },
            { value: "Chi phí khác", text: "Chi phí khác (chung)" }
        ];
        const defaultAccounts = [
             { value: "Tiền mặt", text: "Tiền mặt" }, { value: "Momo", text: "Momo" },
             { value: "Thẻ tín dụng A", text: "Thẻ tín dụng A" }, { value: "Techcombank", text: "Techcombank" },
             { value: "BIDV", text: "BIDV" }, { value: "Khác", text: "Khác" }
        ];
        const categoryColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#C9CBCF', '#8366FF', '#289F40', '#D26384', '#3C64C8', '#C89632'
        ];

        // --- Utility Functions ---
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'message-success' : 'message-error'}`;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
        }

        function formatCurrency(amount, currencyCode = 'VND') {
            const options = { style: 'currency', currency: currencyCode };
            const locale = 'vi-VN';
            options.minimumFractionDigits = 0;
            options.maximumFractionDigits = (currencyCode === 'USD') ? 2 : 0; 
            if (isNaN(amount) || amount === null) amount = 0;
            return new Intl.NumberFormat(locale, options).format(amount);
        }
        
        function formatDateTimeLocalInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function formatIsoDateTime(date) {
            if (!date || isNaN(new Date(date).getTime())) date = new Date();
            else date = new Date(date);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }

        function formatDisplayDateTime(isoString) {
            if (!isoString) return '';
            try {
                let date = new Date(isoString);
                if (isNaN(date.getTime())) return isoString;
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                console.error("Error formatting display date/time:", e, "Input:", isoString);
                return isoString;
            }
        }
        function formatDateTimeForCSV(isoString) {
            if (!isoString) return '';
            try {
                const d = new Date(isoString);
                if (isNaN(d.getTime())) return isoString;
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
            } catch (e) {
                return isoString;
            }
        }


        function setDefaultDateTime() {
            if(datetimeInput) datetimeInput.value = formatDateTimeLocalInput(new Date());
        }
        function setDefaultComparisonYear() {
            if(filterComparisonYearInput) filterComparisonYearInput.value = new Date().getFullYear();
        }

        function loadUserPreferences() {
            const storedTransactions = localStorage.getItem('transactions_v2');
            transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
            const storedIncomeCategories = localStorage.getItem('customIncomeCategories_v2');
            incomeCategories = storedIncomeCategories ? JSON.parse(storedIncomeCategories) : [...defaultIncomeCategories];
            if (!Array.isArray(incomeCategories) || incomeCategories.length === 0 || !incomeCategories.find(c => c.value === TRANSFER_CATEGORY_IN)) {
                 incomeCategories = [...defaultIncomeCategories];
            }
            const storedExpenseCategories = localStorage.getItem('customExpenseCategories_v2');
            expenseCategories = storedExpenseCategories ? JSON.parse(storedExpenseCategories) : [...defaultExpenseCategories];
             if (!Array.isArray(expenseCategories) || expenseCategories.length === 0 || !expenseCategories.find(c => c.value === TRANSFER_CATEGORY_OUT)) {
                 expenseCategories = [...defaultExpenseCategories];
            }
            const storedAccounts = localStorage.getItem('customAccounts_v2');
            accounts = storedAccounts ? JSON.parse(storedAccounts) : [...defaultAccounts];
            if (!Array.isArray(accounts) || accounts.length === 0) accounts = [...defaultAccounts];
        }

        function saveUserPreferences() {
            localStorage.setItem('customIncomeCategories_v2', JSON.stringify(incomeCategories));
            localStorage.setItem('customExpenseCategories_v2', JSON.stringify(expenseCategories));
            localStorage.setItem('customAccounts_v2', JSON.stringify(accounts));
        }
        
        function saveTransactions() {
            localStorage.setItem('transactions_v2', JSON.stringify(transactions));
        }

        function renderCategoryList(listElement, categoriesArray, type) {
            if (!listElement) return;
            listElement.innerHTML = '';
            categoriesArray.forEach(cat => {
                const isSpecialTransferCategory = (cat.value === TRANSFER_CATEGORY_IN || cat.value === TRANSFER_CATEGORY_OUT);
                const li = document.createElement('li');
                li.textContent = cat.text;
                if (!isSpecialTransferCategory) {
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>Xóa`;
                    deleteButton.classList.add('btn-delete', 'text-xs', 'px-2', 'py-1', 'ml-2');
                    deleteButton.onclick = () => {
                        if (confirm(`Bạn có chắc muốn xóa hạng mục "${cat.text}" không?`)) {
                            if (type === 'income') incomeCategories = incomeCategories.filter(c => c.value !== cat.value);
                            else expenseCategories = expenseCategories.filter(c => c.value !== cat.value);
                            saveUserPreferences(); renderCustomCategoryLists(); populateCategories(); applyMainFilter();
                        }
                    };
                    li.appendChild(deleteButton);
                } else {
                    const lockIcon = document.createElement('span');
                    lockIcon.innerHTML = ` <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-lock-fill inline-block ml-2 text-gray-400" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>`;
                    li.appendChild(lockIcon);
                }
                listElement.appendChild(li);
            });
        }

        function renderCustomCategoryLists() {
            renderCategoryList(incomeCategoryListAdminEl, incomeCategories, 'income');
            renderCategoryList(expenseCategoryListAdminEl, expenseCategories, 'expense');
        }

        function addCategory(name, type) {
            if (!name || name.trim() === '') { showMessage('Tên hạng mục không được để trống.', 'error'); return false; }
            const newCategoryValue = name.trim();
            const newCategory = { value: newCategoryValue, text: newCategoryValue };
            if (type === 'income') {
                if (incomeCategories.some(cat => cat.value.toLowerCase() === newCategoryValue.toLowerCase())) { showMessage('Hạng mục thu này đã tồn tại.', 'error'); return false; }
                incomeCategories.push(newCategory);
            } else {
                if (expenseCategories.some(cat => cat.value.toLowerCase() === newCategoryValue.toLowerCase())) { showMessage('Hạng mục chi này đã tồn tại.', 'error'); return false; }
                expenseCategories.push(newCategory);
            }
            saveUserPreferences(); renderCustomCategoryLists(); populateCategories();
            showMessage(`Đã thêm hạng mục "${newCategory.text}"!`, 'success'); return true;
        }

        function populateAccountDropdowns() {
            if (!accountInput || !toAccountInput) return;
            const currentFromAccount = accountInput.value; const currentToAccount = toAccountInput.value;
            accountInput.innerHTML = ''; toAccountInput.innerHTML = '';
            if (!accounts || accounts.length === 0) accounts = [...defaultAccounts];
            accounts.forEach(acc => {
                accountInput.add(new Option(acc.text, acc.value));
                toAccountInput.add(new Option(acc.text, acc.value));
            });
            if (accounts.some(acc => acc.value === currentFromAccount)) accountInput.value = currentFromAccount;
            else if (accounts.length > 0) accountInput.value = accounts[0].value;
            if (accounts.some(acc => acc.value === currentToAccount)) toAccountInput.value = currentToAccount;
            else if (accounts.length > 1) toAccountInput.value = accounts[1].value;
            else if (accounts.length > 0) toAccountInput.value = accounts[0].value;
        }

        function populateCategories() {
            if (!categoryInput) return;
            const selectedTypeRadio = document.querySelector('input[name="type"]:checked');
            const selectedType = selectedTypeRadio ? selectedTypeRadio.value : 'Chi';
            const currentCategoryValue = categoryInput.value; categoryInput.innerHTML = '';
            let categoriesToPopulate = (selectedType === 'Thu') ? incomeCategories : expenseCategories;
            categoriesToPopulate = categoriesToPopulate.filter(cat => cat.value !== TRANSFER_CATEGORY_IN && cat.value !== TRANSFER_CATEGORY_OUT);
            if (!categoriesToPopulate || categoriesToPopulate.length === 0) {
                 const defaultCats = (selectedType === 'Thu') ? [...defaultIncomeCategories] : [...defaultExpenseCategories];
                 categoriesToPopulate = defaultCats.filter(cat => cat.value !== TRANSFER_CATEGORY_IN && cat.value !== TRANSFER_CATEGORY_OUT);
            }
            categoriesToPopulate.forEach(category => categoryInput.add(new Option(category.text, category.value)));
            if (categoriesToPopulate.some(cat => cat.value === currentCategoryValue)) categoryInput.value = currentCategoryValue;
            else if (categoriesToPopulate.length > 0) categoryInput.value = categoriesToPopulate[0].value;
        }

        function toggleFormFields() {
            const selectedTypeRadio = document.querySelector('input[name="type"]:checked');
            const selectedType = selectedTypeRadio ? selectedTypeRadio.value : 'Chi';
            transactionForm.dataset.transactionMode = selectedType;
            if (selectedType === 'Transfer') {
                accountLabel.textContent = 'Từ Tài khoản:'; categoryInput.removeAttribute('required'); toAccountInput.setAttribute('required', '');
            } else {
                accountLabel.textContent = 'Tài khoản:'; categoryInput.setAttribute('required', ''); toAccountInput.removeAttribute('required');
                populateCategories();
            }
        }

        function parseAmountInput(amountStr, currency) {
            if (!amountStr) return 0;
            let val = parseFloat(amountStr.replace(/,/g, ''));
            if (isNaN(val)) return 0;
            if (currency === 'USD') val = val * USD_TO_VND_RATE;
            else if (currency === 'VND') val = val * 1000;
            return Math.round(val);
        }

		function handleTransactionSubmit(e) {
			e.preventDefault();
			const datetimeValue = datetimeInput.value;
			const typeRadio = document.querySelector('input[name="type"]:checked');
			const type = typeRadio ? typeRadio.value : null;
			const amountRaw = amountTextInput.value;
			const currency = formCurrencySelector.value;
			let categoryValue = (type !== 'Transfer') ? categoryInput.value : null;
			const accountValue = accountInput.value;
			const toAccountValue = (type === 'Transfer') ? toAccountInput.value : null;
			const descriptionValue = descriptionInput.value.trim();

			// --- GIỮ NGUYÊN PHẦN VALIDATION DỮ LIỆU ---
			if (!datetimeValue || !type || !amountRaw || !accountValue) { showMessage('Vui lòng điền đầy đủ các trường bắt buộc.', 'error'); return; }
			if (type !== 'Transfer' && !categoryValue) { showMessage('Vui lòng chọn hạng mục.', 'error'); return; }
			if (type === 'Transfer' && !toAccountValue) { showMessage('Vui lòng chọn tài khoản nhận cho giao dịch chuyển tiền.', 'error'); return; }
			if (type === 'Transfer' && accountValue === toAccountValue) { showMessage('Tài khoản chuyển và tài khoản nhận không được trùng nhau.', 'error'); return; }
			let amount = parseAmountInput(amountRaw, currency);
			if (isNaN(amount) || amount <= 0) { showMessage('Số tiền không hợp lệ hoặc phải lớn hơn 0.', 'error'); return; }
			const transactionDateTime = formatIsoDateTime(new Date(datetimeValue));
			// --- KẾT THÚC PHẦN VALIDATION ---

			const persistedTransactionType = type; 

			if (editingTransactionId) {
				// --- GIỮ NGUYÊN LOGIC SỬA GIAO DỊCH ---
				// (Toàn bộ khối if (editingTransactionId) { ... } else { ... } giữ nguyên như trước)
				const existingTransactionIndex = transactions.findIndex(t => t.id === editingTransactionId || (t.isTransfer && (t.id.startsWith(editingTransactionId) || t.transferPairId.startsWith(editingTransactionId))));
				if (existingTransactionIndex === -1 && type !== 'Transfer') { showMessage('Lỗi: Giao dịch gốc để sửa không tìm thấy.', 'error'); editingTransactionId = null; return; }
				if (transactions.find(t => t.id.startsWith(editingTransactionId) && t.isTransfer) || type === 'Transfer') {
					transactions = transactions.filter(t => !t.id.startsWith(editingTransactionId) && !(t.transferPairId && t.transferPairId.startsWith(editingTransactionId)));
				} else if (existingTransactionIndex !== -1) { transactions.splice(existingTransactionIndex, 1); }
				const baseId = editingTransactionId;
				if (type === 'Transfer') {
					categoryValue = null;
					const transferOutId = baseId + "_out_edited_" + Date.now(); const transferInId = baseId + "_in_edited_" + Date.now();
					transactions.push({ id: transferOutId, datetime: transactionDateTime, description: descriptionValue || `Chuyển tiền từ ${accountValue} đến ${toAccountValue}`, category: TRANSFER_CATEGORY_OUT, amount, type: 'Chi', account: accountValue, currency: 'VND', isTransfer: true, transferPairId: transferInId, originalAmount: parseFloat(amountRaw), originalCurrency: currency });
					transactions.push({ id: transferInId, datetime: transactionDateTime, description: descriptionValue || `Nhận tiền từ ${accountValue} vào ${toAccountValue}`, category: TRANSFER_CATEGORY_IN, amount, type: 'Thu', account: toAccountValue, currency: 'VND', isTransfer: true, transferPairId: transferOutId, originalAmount: parseFloat(amountRaw), originalCurrency: currency });
					showMessage('Giao dịch chuyển tiền đã được cập nhật!', 'success');
				} else {
					transactions.push({ id: baseId, datetime: transactionDateTime, description: descriptionValue, category: categoryValue, amount, type, account: accountValue, currency: 'VND', isTransfer: false, transferPairId: null, originalAmount: parseFloat(amountRaw), originalCurrency: currency });
					showMessage(`Giao dịch ${type === 'Thu' ? 'thu' : 'chi'} đã được cập nhật!`, 'success');
				}
				editingTransactionId = null;
			} else {
				// --- GIỮ NGUYÊN LOGIC THÊM MỚI GIAO DỊCH ---
				const newIdBase = Date.now().toString();
				if (type === 'Transfer') {
					const transferOutId = newIdBase + "_out"; const transferInId = newIdBase + "_in";
					transactions.push({ id: transferOutId, datetime: transactionDateTime, description: descriptionValue || `Chuyển tiền từ ${accountValue} đến ${toAccountValue}`, category: TRANSFER_CATEGORY_OUT, amount, type: 'Chi', account: accountValue, currency: 'VND', isTransfer: true, transferPairId: transferInId, originalAmount: parseFloat(amountRaw), originalCurrency: currency });
					transactions.push({ id: transferInId, datetime: transactionDateTime, description: descriptionValue || `Nhận tiền từ ${accountValue} vào ${toAccountValue}`, category: TRANSFER_CATEGORY_IN, amount, type: 'Thu', account: toAccountValue, currency: 'VND', isTransfer: true, transferPairId: transferOutId, originalAmount: parseFloat(amountRaw), originalCurrency: currency });
					showMessage('Giao dịch chuyển tiền đã được thêm!', 'success');
				} else {
					transactions.push({ id: newIdBase, datetime: transactionDateTime, description: descriptionValue, category: categoryValue, amount, type, account: accountValue, currency: 'VND', isTransfer: false, transferPairId: null, originalAmount: parseFloat(amountRaw), originalCurrency: currency });
					showMessage(`Giao dịch ${type === 'Thu' ? 'thu' : 'chi'} đã được thêm!`, 'success');
				}
			}
			// --- KẾT THÚC LOGIC THÊM/SỬA ---

			saveTransactions();
			populateMonthFilter(); // <--- THÊM DÒNG NÀY ĐỂ CẬP NHẬT DROPDOWN THÁNG
			applyMainFilter();
			resetForm(persistedTransactionType);
		}

        function resetForm(persistedType = null) { // Thêm tham số persistedType, mặc định là null
            transactionForm.reset(); // Reset tất cả các trường về giá trị mặc định trong HTML (Loại "Chi" sẽ được chọn)
			setDefaultDateTime();
			formCurrencySelector.value = 'VND';

			// Nếu có persistedType được truyền vào (tức là sau khi submit một giao dịch)
			// thì khôi phục lại lựa chọn loại giao dịch đó.
			if (persistedType) {
				const radioToSelect = document.querySelector(`input[name="type"][value="${persistedType}"]`);
				if (radioToSelect) {
					radioToSelect.checked = true;
				}
			}
			// Nếu không có persistedType (ví dụ: reset từ một nguồn khác),
			// transactionForm.reset() đã tự động chọn "Chi" dựa trên HTML.

			editingTransactionId = null;
			formTitleEl.textContent = 'Thêm Giao Dịch Mới';
			// Đảm bảo nội dung SVG của nút submit được giữ nguyên hoặc cập nhật đúng
			submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Thêm Giao Dịch';
			
			// Quan trọng: Gọi toggleFormFields SAU KHI đã đặt lại radio button loại giao dịch
			// để các trường hiển thị đúng theo loại đã chọn.
			toggleFormFields(); 
			populateAccountDropdowns();
		}

		function getMonthDisplayText(selectedMonthValue, withParentheses = true) {
			let text;
			if (selectedMonthValue === 'all' || !selectedMonthValue) {
				text = "Tất cả";
			} else {
				const parts = selectedMonthValue.split('-'); // Ví dụ: "2025-05"
				if (parts.length === 2) {
					const [year, month] = parts;
					text = `Tháng ${month}/${year}`;
				} else {
					text = "Đã chọn"; // Trường hợp dự phòng nếu định dạng không như mong đợi
				}
			}
			return withParentheses ? `(${text})` : text;
		}

        window.loadTransactionForEdit = function(transactionId) {
            let transactionToEdit = transactions.find(t => t.id === transactionId);
            if (!transactionToEdit) {
                 transactionToEdit = transactions.find(t => t.isTransfer && (t.id.startsWith(transactionId) || t.transferPairId.startsWith(transactionId)));
                 if (transactionToEdit && transactionToEdit.isTransfer) {
                    const baseId = transactionToEdit.id.split('_')[0];
                    const outTransaction = transactions.find(t => t.id.startsWith(baseId) && t.type === 'Chi' && t.isTransfer);
                    const inTransaction = transactions.find(t => t.id.startsWith(baseId) && t.type === 'Thu' && t.isTransfer);
                    if (outTransaction && inTransaction) {
                        datetimeInput.value = formatDateTimeLocalInput(new Date(outTransaction.datetime));
                        document.getElementById('type-transfer').checked = true;
                        amountTextInput.value = outTransaction.originalCurrency === 'VND' ? outTransaction.originalAmount / 1000 : outTransaction.originalAmount;
                        formCurrencySelector.value = outTransaction.originalCurrency;
                        descriptionInput.value = outTransaction.description.startsWith("Chuyển tiền từ") ? outTransaction.description : (inTransaction.description.startsWith("Nhận tiền từ") ? inTransaction.description : outTransaction.description);
                        accountInput.value = outTransaction.account; toAccountInput.value = inTransaction.account;
                        editingTransactionId = baseId;
                    } else { showMessage('Lỗi: Không tìm thấy đủ thông tin giao dịch chuyển tiền.', 'error'); return; }
                 } else { showMessage('Lỗi: Không tìm thấy giao dịch.', 'error'); return; }
            } else {
                datetimeInput.value = formatDateTimeLocalInput(new Date(transactionToEdit.datetime));
                document.querySelector(`input[name="type"][value="${transactionToEdit.type}"]`).checked = true;
                amountTextInput.value = transactionToEdit.originalAmount;
                formCurrencySelector.value = transactionToEdit.originalCurrency;
                descriptionInput.value = transactionToEdit.description; accountInput.value = transactionToEdit.account;
                if (transactionToEdit.type !== 'Transfer') categoryInput.value = transactionToEdit.category;
                editingTransactionId = transactionId;
            }
            formTitleEl.textContent = 'Sửa Giao Dịch';
            submitButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>Lưu Thay Đổi`;
            toggleFormFields(); populateAccountDropdowns();
             if (document.querySelector('input[name="type"]:checked').value !== 'Transfer') {
                populateCategories();
                if(transactionToEdit && transactionToEdit.type !== 'Transfer') categoryInput.value = transactionToEdit.category;
            }
            const formSection = document.querySelector('.form-section .collapsible-header');
            if(formSection && !formSection.classList.contains('active')) formSection.click();
            formSection.scrollIntoView({ behavior: 'smooth' });
        }

        window.deleteTransaction = function(transactionId) {
            if (!confirm('Bạn có chắc muốn xóa giao dịch này?')) return;
            const transactionToDelete = transactions.find(t => t.id === transactionId);
            if (transactionToDelete && transactionToDelete.isTransfer) {
                transactions = transactions.filter(t => t.id !== transactionToDelete.id && t.transferPairId !== transactionToDelete.id);
            } else {
                const baseIdMatch = transactionId.match(/^(\d+)(_out|_in)?$/);
                if(baseIdMatch && baseIdMatch[1]){
                    const baseId = baseIdMatch[1];
                    transactions = transactions.filter(t => !t.id.startsWith(baseId) && !(t.transferPairId && t.transferPairId.startsWith(baseId)));
                } else { transactions = transactions.filter(t => t.id !== transactionId); }
            }
            saveTransactions(); applyMainFilter(); showMessage('Đã xóa giao dịch.', 'success');
        }

		function renderMainTransactions(txsToRender = transactions) {
			transactionList.innerHTML = ''; // Xóa các hàng cũ trong bảng
			if (txsToRender.length === 0) {
				noTransactionsMessage.style.display = 'block'; // Hiển thị thông báo nếu không có giao dịch
				return;
			}
			noTransactionsMessage.style.display = 'none'; // Ẩn thông báo nếu có giao dịch

			// Sắp xếp giao dịch theo ngày giờ mới nhất lên trước
			txsToRender.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));

			txsToRender.forEach(tx => {
				const row = transactionList.insertRow(); // Tạo một hàng mới trong bảng

				// Ô Ngày & Giờ
				row.insertCell().textContent = formatDisplayDateTime(tx.datetime);

				// Xử lý hiển thị Nội dung và Hạng mục (đặc biệt cho giao dịch chuyển tiền)
				let displayDescription = tx.description;
				let displayCategory = tx.category;
				let displayAccount = accounts.find(a => a.value === tx.account)?.text || tx.account;

				if (tx.isTransfer) {
					const pair = transactions.find(p => p.id === tx.transferPairId);
					const pairAccountName = pair ? (accounts.find(a => a.value === pair.account)?.text || pair.account) : 'N/A';
					if (tx.type === 'Chi') { // Chuyển tiền đi
						displayDescription = displayDescription || `Chuyển đến ${pairAccountName}`;
					} else { // Nhận tiền chuyển
						displayDescription = displayDescription || `Nhận từ ${pairAccountName}`;
					}
				}

				// Ô Nội dung
				row.insertCell().textContent = displayDescription;
				// Ô Hạng mục
				row.insertCell().textContent = displayCategory;

				// Ô Số tiền (VNĐ) - ĐÃ CHỈNH SỬA ĐỂ THÊM GHI CHÚ USD
				const amountCell = row.insertCell();
				const vndAmountFormatted = formatCurrency(tx.amount); // tx.amount luôn là giá trị VNĐ

				if (tx.originalCurrency === 'USD' && typeof tx.originalAmount === 'number') {
					const originalUsdFormatted = formatCurrency(tx.originalAmount, 'USD'); // Định dạng số tiền USD gốc
					// Hiển thị số tiền VNĐ, kèm theo ghi chú về số tiền USD gốc
					amountCell.innerHTML = `${vndAmountFormatted} <span class="text-xs text-gray-500 block sm:inline ml-1">(${originalUsdFormatted} gốc)</span>`;
				} else {
					amountCell.textContent = vndAmountFormatted;
				}
				// Thêm màu sắc cho số tiền dựa trên loại giao dịch (Thu/Chi)
				amountCell.classList.add(tx.type === 'Thu' ? 'text-green-600' : 'text-red-600');

				// Ô Loại giao dịch
				row.insertCell().textContent = tx.type === 'Thu' ? 'Thu Nhập' : (tx.type === 'Chi' ? 'Chi Tiêu' : 'Chuyển Tiền');
				
				// Ô Tài khoản
				row.insertCell().textContent = displayAccount;

				// Ô Thao tác (Sửa, Xóa)
				const actionsCell = row.insertCell();
				actionsCell.classList.add('text-center'); // Căn giữa nội dung ô

				// Nút Sửa
				const editBtn = document.createElement('button');
				editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square mr-1" viewBox="0 0 16 16"> <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/> <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/> </svg>Sửa`;
				editBtn.classList.add('btn-edit');
				const editId = tx.isTransfer ? tx.id.split('_')[0] : tx.id; // Lấy ID gốc nếu là giao dịch chuyển tiền
				editBtn.onclick = () => loadTransactionForEdit(editId);

				// Nút Xóa
				const deleteBtn = document.createElement('button');
				deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash mr-1" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>Xóa`;
				deleteBtn.classList.add('btn-delete');
				const deleteId = tx.isTransfer ? tx.id.split('_')[0] : tx.id; // Lấy ID gốc nếu là giao dịch chuyển tiền
				deleteBtn.onclick = () => deleteTransaction(deleteId);

				actionsCell.appendChild(editBtn);
				actionsCell.appendChild(deleteBtn);
			});
		}

        function updateAllSummariesAndCharts(transactionsToAnalyze = transactions) {
            updateMainSummaryAndChart(transactionsToAnalyze);
            renderExpenseCategoryChartAndList(transactionsToAnalyze);
            updateAccountBalances(); renderLast7DaysChart(); renderMonthComparisonChart();
        }

		function updateMainSummaryAndChart(summaryTransactions = transactions) {
			let totalIncome = 0;
			let totalExpenses = 0;
			summaryTransactions.forEach(tx => {
				if (tx.type === 'Thu') totalIncome += tx.amount;
				else if (tx.type === 'Chi') totalExpenses += tx.amount;
			});

			// Lấy giá trị tháng hiện tại từ bộ lọc filterMonthSelect
			const selectedMonthValue = filterMonthSelect.value;
			// Lấy văn bản hiển thị cho tháng, có dấu ngoặc đơn, dùng cho các nhãn tóm tắt
			const monthDisplayTextForLabels = getMonthDisplayText(selectedMonthValue, true); 

			// Cập nhật các nhãn trong phần tóm tắt (sử dụng ID đã thêm ở Bước 1)
			const summaryIncomeMonthDisplayEl = document.getElementById('summary-income-month-display');
			if (summaryIncomeMonthDisplayEl) summaryIncomeMonthDisplayEl.textContent = monthDisplayTextForLabels;

			const summaryExpenseMonthDisplayEl = document.getElementById('summary-expense-month-display');
			if (summaryExpenseMonthDisplayEl) summaryExpenseMonthDisplayEl.textContent = monthDisplayTextForLabels;

			const summaryBalanceMonthDisplayEl = document.getElementById('summary-balance-month-display');
			if (summaryBalanceMonthDisplayEl) summaryBalanceMonthDisplayEl.textContent = monthDisplayTextForLabels;

			// Các dòng cập nhật số tiền giữ nguyên
			totalIncomeEl.textContent = formatCurrency(totalIncome);
			totalExpensesEl.textContent = formatCurrency(totalExpenses);
			currentBalanceEl.textContent = formatCurrency(totalIncome - totalExpenses);
			currentBalanceEl.className = (totalIncome - totalExpenses >= 0) ? 'text-blue-600 font-bold' : 'text-red-600 font-bold';

			renderOrUpdateMainChart(totalIncome, totalExpenses);
		}

        function renderOrUpdateMainChart(income, expenses) {
            const data = { labels: ['Tổng Thu', 'Tổng Chi'], datasets: [{ label: 'Số tiền (VNĐ)', data: [income, expenses], backgroundColor: [categoryColors[1], categoryColors[0]], }] };
            if (incomeExpenseChart) { incomeExpenseChart.data = data; incomeExpenseChart.update(); }
            else { incomeExpenseChart = new Chart(incomeExpenseChartCanvas, { type: 'bar', data, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } } } }); }
        }

        function renderExpenseCategoryChartAndList(transactionsToAnalyze = transactions) {
            const expenseData = {}; let totalExpenses = 0;
            transactionsToAnalyze.filter(tx => tx.type === 'Chi').forEach(tx => { expenseData[tx.category] = (expenseData[tx.category] || 0) + tx.amount; totalExpenses += tx.amount; });
            if (totalExpenses === 0) {
                noExpenseDataEl.style.display = 'block'; expenseCategoryListContainerEl.innerHTML = '';
                if(expenseCategoryChart) expenseCategoryChart.destroy(); expenseCategoryChart = null;
                document.getElementById('expenseCategoryChart').style.display = 'none'; return;
            }
            noExpenseDataEl.style.display = 'none'; document.getElementById('expenseCategoryChart').style.display = 'block';
            const labels = Object.keys(expenseData); const dataValues = Object.values(expenseData);
            const backgroundColors = labels.map((_, i) => categoryColors[i % categoryColors.length]);
            const chartData = { labels, datasets: [{ data: dataValues, backgroundColor: backgroundColors }] };
            if (expenseCategoryChart) { expenseCategoryChart.data = chartData; expenseCategoryChart.update(); }
            else { expenseCategoryChart = new Chart(expenseCategoryChartCanvas, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${((ctx.raw / totalExpenses) * 100).toFixed(1)}%)` } }, datalabels: { formatter: (value, ctx) => { const percentage = (value / totalExpenses) * 100; return percentage > 5 ? percentage.toFixed(0) + '%' : ''; }, color: '#fff', font: { weight: 'bold' } } } } }); }
            expenseCategoryListContainerEl.innerHTML = '';
            labels.forEach((label, index) => {
                const amount = expenseData[label]; const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : "0.0";
                const itemEl = document.createElement('div'); itemEl.classList.add('expense-category-item');
                itemEl.innerHTML = `<div><span class="category-color-swatch" style="background-color: ${backgroundColors[index]}"></span><span class="category-name">${label}</span></div><div class="flex items-center"><span class="category-amount">${formatCurrency(amount)}</span><span class="category-percentage">${percentage}%</span></div>`;
                expenseCategoryListContainerEl.appendChild(itemEl);
            });
        }

        function updateAccountBalances() {
            accountBalanceListEl.innerHTML = '<h3>Số Dư Theo Tài Khoản (Tổng thể - VNĐ):</h3>';
            const balances = {}; accounts.forEach(acc => balances[acc.value] = 0);
            transactions.forEach(tx => {
                if (balances[tx.account] !== undefined) {
                    if (tx.type === 'Thu') balances[tx.account] += tx.amount;
                    else if (tx.type === 'Chi') balances[tx.account] -= tx.amount;
                }
            });
            Object.keys(balances).forEach(accValue => {
                const acc = accounts.find(a => a.value === accValue);
                if (acc) {
                    const balanceItem = document.createElement('div'); balanceItem.classList.add('summary-item');
                    balanceItem.innerHTML = `<span>${acc.text}:</span><span class="${balances[accValue] >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(balances[accValue])}</span>`;
                    accountBalanceListEl.appendChild(balanceItem);
                }
            });
        }
        
        function getPastDate(daysAgo) { const date = new Date(); date.setDate(date.getDate() - daysAgo); date.setHours(0, 0, 0, 0); return date; }

        function renderLast7DaysChart() {
            const today = new Date(); today.setHours(23,59,59,999); const sevenDaysAgo = getPastDate(6); 
            const dailyExpenses = {}; const labels = [];
            for (let i = 0; i < 7; i++) { const d = new Date(sevenDaysAgo); d.setDate(d.getDate() + i); const dateString = d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }); labels.push(dateString); dailyExpenses[dateString] = 0; }
            transactions.filter(tx => { const txDate = new Date(tx.datetime); return tx.type === 'Chi' && txDate >= sevenDaysAgo && txDate <= today; }).forEach(tx => { const dateString = new Date(tx.datetime).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }); if (dailyExpenses[dateString] !== undefined) dailyExpenses[dateString] += tx.amount; });
            const dataValues = labels.map(label => dailyExpenses[label]);
            const data = { labels: labels, datasets: [{ label: 'Chi tiêu hàng ngày (VNĐ)', data: dataValues, borderColor: categoryColors[3], backgroundColor: 'transparent', tension: 0.1, fill: false }] };
            if (last7DaysChart) { last7DaysChart.data = data; last7DaysChart.update(); }
            else { last7DaysChart = new Chart(last7DaysChartCanvas, { type: 'line', data, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } } } }); }
        }

        function renderMonthComparisonChart() {
            const currentMonthFilter = filterMonthSelect.value; if (!currentMonthFilter || currentMonthFilter === 'all') return;
            const [currentYear, currentMonthNum] = currentMonthFilter.split('-').map(Number);
            let prevYear = currentYear; let prevMonthNum = currentMonthNum - 1;
            if (prevMonthNum === 0) { prevMonthNum = 12; prevYear--; }
            const prevMonthFilter = `${prevYear}-${String(prevMonthNum).padStart(2, '0')}`;
            let currentMonthIncome = 0, currentMonthExpenses = 0, prevMonthIncome = 0, prevMonthExpenses = 0;
            transactions.forEach(tx => {
                const txMonth = tx.datetime.substring(0, 7);
                if (txMonth === currentMonthFilter) { if (tx.type === 'Thu') currentMonthIncome += tx.amount; else if (tx.type === 'Chi') currentMonthExpenses += tx.amount; }
                else if (txMonth === prevMonthFilter) { if (tx.type === 'Thu') prevMonthIncome += tx.amount; else if (tx.type === 'Chi') prevMonthExpenses += tx.amount; }
            });
            const data = { labels: ['Tháng Trước', 'Tháng Này'], datasets: [ { label: 'Tổng Thu', data: [prevMonthIncome, currentMonthIncome], backgroundColor: categoryColors[1] }, { label: 'Tổng Chi', data: [prevMonthExpenses, currentMonthExpenses], backgroundColor: categoryColors[0] } ] };
            if (monthComparisonChart) { monthComparisonChart.data = data; monthComparisonChart.update(); }
            else { monthComparisonChart = new Chart(monthComparisonChartCanvas, { type: 'bar', data, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', plugins: { datalabels: { display: false } } } }); }
        }
        
        function populateMonthFilter() {
            const months = new Set(); transactions.forEach(tx => months.add(tx.datetime.substring(0, 7)));
            const sortedMonths = Array.from(months).sort().reverse();
            filterMonthSelect.innerHTML = '<option value="all">Tất cả các tháng</option>';
            sortedMonths.forEach(monthStr => { const [year, month] = monthStr.split('-'); filterMonthSelect.add(new Option(`Tháng ${month}/${year}`, monthStr)); });
            const currentMonthFormatted = new Date().toISOString().substring(0, 7);
            if (sortedMonths.includes(currentMonthFormatted)) filterMonthSelect.value = currentMonthFormatted;
            else if (sortedMonths.length > 0) filterMonthSelect.value = sortedMonths[0];
            else filterMonthSelect.value = "all";
        }

        function filterTransactionsByMonth() { applyMainFilter(); }
        
		function applyMainFilter() {
			const selectedMonth = filterMonthSelect.value;
			let filteredTransactions = (selectedMonth === 'all') ? [...transactions] : transactions.filter(tx => tx.datetime.startsWith(selectedMonth));

			// Lấy văn bản hiển thị cho tháng, không có dấu ngoặc đơn, dùng cho tiêu đề
			const monthDisplayForTitles = getMonthDisplayText(selectedMonth, false); 

			// Cập nhật tiêu đề phần "Phân Loại Chi Tiêu"
			const expenseBreakdownTitleTextEl = document.getElementById('expense-breakdown-title-text');
			if (expenseBreakdownTitleTextEl) {
				expenseBreakdownTitleTextEl.textContent = `Phân Loại Chi Tiêu ${monthDisplayForTitles} - VNĐ`;
			}

			// Cập nhật tiêu đề biểu đồ "Thu vs Chi"
			const incomeExpenseChartTitleEl = document.getElementById('income-expense-chart-title');
			if (incomeExpenseChartTitleEl) {
				incomeExpenseChartTitleEl.textContent = `Biểu Đồ Thu vs Chi ${monthDisplayForTitles} - VNĐ`;
			}

			// Các dòng còn lại của hàm applyMainFilter giữ nguyên
			renderMainTransactions(filteredTransactions);
			updateAllSummariesAndCharts(filteredTransactions); // Hàm này sẽ gọi updateMainSummaryAndChart
			renderMonthComparisonChart(); // Gọi lại để cập nhật biểu đồ so sánh tháng nếu cần
		}

        function getISOWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }
        function getWeekIdFromDateTime(dateTimeStr) { if (!dateTimeStr) return null; const date = new Date(dateTimeStr); if (isNaN(date.getTime())) return null; const year = date.getFullYear(); const weekNumber = getISOWeekNumber(date); return `${year}-W${String(weekNumber).padStart(2, '0')}`; }
        function getStartDateOfISOWeek(year, week) { const simple = new Date(year, 0, 1 + (week - 1) * 7); const dow = simple.getDay(); const ISOweekStart = simple; if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1); else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay()); ISOweekStart.setHours(0,0,0,0); return ISOweekStart; }
        function getWeekDates(weekId) { if (!weekId || !weekId.includes('-W')) return { start: null, end: null }; const [yearStr, weekNumStr] = weekId.split('-W'); const year = parseInt(yearStr); const week = parseInt(weekNumStr, 10); if (isNaN(year) || isNaN(week)) return { start: null, end: null }; const startDate = getStartDateOfISOWeek(year, week); const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); return { start: startDate, end: endDate }; }
        function getNumberOfISOWeeks(year) { const date = new Date(year, 11, 28); return getISOWeekNumber(date); }
        function getAllWeekIdsInYear(year) { if (isNaN(year) || year < 1900 || year > 2200) return []; const numWeeks = getNumberOfISOWeeks(year); const weekIds = []; for (let i = 1; i <= numWeeks; i++) weekIds.push(`${year}-W${String(i).padStart(2, '0')}`); return weekIds; }
        function getPreviousWeekId(weekId) { if (!weekId || !weekId.includes('-W')) return null; let [yearStr, weekNumStr] = weekId.split('-W'); let year = parseInt(yearStr); let week = parseInt(weekNumStr); if (week > 1) return `${year}-W${String(week - 1).padStart(2, '0')}`; else { year--; const numWeeksInPrevYear = getNumberOfISOWeeks(year); return `${year}-W${String(numWeeksInPrevYear).padStart(2, '0')}`; } }
        
        function populateComparisonWeekFilter() {
            const year = parseInt(filterComparisonYearInput.value); if (isNaN(year)) { filterComparisonWeekSelect.innerHTML = '<option value="none">-- Chọn năm hợp lệ --</option>'; return; }
            const weekIds = getAllWeekIdsInYear(year).reverse(); filterComparisonWeekSelect.innerHTML = '<option value="none">-- Chọn tuần --</option>';
            weekIds.forEach(id => { const {start, end} = getWeekDates(id); const optionText = `${id.replace(year + "-W","Tuần ")} (${start.toLocaleDateString('vi-VN')} - ${end.toLocaleDateString('vi-VN')})`; filterComparisonWeekSelect.add(new Option(optionText, id)); });
        }

        function calculateWeeklyStats(transactionsInPeriod, weekStartDate) {
            let income = 0, expenses = 0, startBalance = 0;
            const allSortedTransactions = [...transactions].sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
            for (const tx of allSortedTransactions) { const txDate = new Date(tx.datetime); if (txDate < weekStartDate) { if (tx.type === 'Thu') startBalance += tx.amount; else if (tx.type === 'Chi') startBalance -= tx.amount; } else break; }
            transactionsInPeriod.forEach(tx => { if (tx.type === 'Thu') income += tx.amount; else if (tx.type === 'Chi') expenses += tx.amount; });
            return { startBalance, income, expenses, netChange: income - expenses };
        }

        function updateWeeklyComparisonDisplay() {
            const selectedWeekId = filterComparisonWeekSelect.value; if (selectedWeekId === 'none') { weeklyComparisonContentEl.style.display = 'none'; noComparisonDataEl.style.display = 'block'; return; }
            weeklyComparisonContentEl.style.display = 'grid'; noComparisonDataEl.style.display = 'none';
            const currentWeekDates = getWeekDates(selectedWeekId); if (!currentWeekDates.start) { weeklyComparisonContentEl.style.display = 'none'; noComparisonDataEl.style.display = 'block'; noComparisonDataEl.textContent = 'Tuần không hợp lệ.'; return; }
            const currentWeekTransactions = transactions.filter(tx => { const txDate = new Date(tx.datetime); return txDate >= currentWeekDates.start && txDate <= currentWeekDates.end; });
            const currentWeekStats = calculateWeeklyStats(currentWeekTransactions, currentWeekDates.start);
            selectedWeekDisplayEl.textContent = `${selectedWeekId.replace(filterComparisonYearInput.value + "-W","Tuần ")} (${currentWeekDates.start.toLocaleDateString('vi-VN')} - ${currentWeekDates.end.toLocaleDateString('vi-VN')})`;
            currentWeekStartBalanceEl.textContent = formatCurrency(currentWeekStats.startBalance); currentWeekIncomeEl.textContent = formatCurrency(currentWeekStats.income);
            currentWeekExpensesEl.textContent = formatCurrency(currentWeekStats.expenses); currentWeekNetChangeEl.textContent = formatCurrency(currentWeekStats.netChange);
            currentWeekNetChangeEl.className = currentWeekStats.netChange >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';
            const prevWeekId = getPreviousWeekId(selectedWeekId);
            if (prevWeekId) { const prevWeekDates = getWeekDates(prevWeekId); if(prevWeekDates.start) { const prevWeekTransactions = transactions.filter(tx => { const txDate = new Date(tx.datetime); return txDate >= prevWeekDates.start && txDate <= prevWeekDates.end; }); const prevWeekStats = calculateWeeklyStats(prevWeekTransactions, prevWeekDates.start); previousWeekDisplayEl.textContent = `${prevWeekId.replace(filterComparisonYearInput.value + "-W","Tuần ")} (${prevWeekDates.start.toLocaleDateString('vi-VN')} - ${prevWeekDates.end.toLocaleDateString('vi-VN')})`; previousWeekExpensesEl.textContent = formatCurrency(prevWeekStats.expenses); const difference = currentWeekStats.expenses - prevWeekStats.expenses; spendingDifferenceEl.textContent = formatCurrency(difference); spendingDifferenceEl.className = difference >= 0 ? 'font-bold text-red-600' : 'font-bold text-green-600'; } else { previousWeekDisplayEl.textContent = "N/A"; previousWeekExpensesEl.textContent = formatCurrency(0); spendingDifferenceEl.textContent = formatCurrency(0); } }
            else { previousWeekDisplayEl.textContent = "N/A"; previousWeekExpensesEl.textContent = formatCurrency(0); spendingDifferenceEl.textContent = formatCurrency(0); }
        }

        function escapeCSVValue(value) {
            if (value == null) return '';
            value = String(value);
            if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                value = value.replace(/"/g, '""');
                return `"${value}"`;
            }
            return value;
        }

        function exportToCSV() {
            if (transactions.length === 0) { showMessage('Không có dữ liệu giao dịch để xuất.', 'error'); return; }
            const headers = [ 'ID Giao Dịch', 'Ngày Giờ (YYYY-MM-DD HH:mm:ss)', 'Nội dung', 'Hạng mục', 'Loại (Thu/Chi)', 'Số Tiền (VNĐ)', 'Tài khoản', 'Là Chuyển Khoản?', 'ID Liên Kết CK', 'Số Tiền Gốc', 'Đơn Vị Gốc' ];
            const rows = transactions.map(tx => {
                const accountName = accounts.find(acc => acc.value === tx.account)?.text || tx.account;
                return [
                    tx.id, formatDateTimeForCSV(tx.datetime), tx.description, tx.category, tx.type, tx.amount,
                    accountName, tx.isTransfer ? 'Có' : 'Không', tx.isTransfer ? tx.transferPairId : '',
                    tx.originalAmount, tx.originalCurrency
                ].map(escapeCSVValue);
            });
            let csvContent = "\ufeff"; 
            csvContent += headers.join(',') + '\n';
            rows.forEach(rowArray => { csvContent += rowArray.join(',') + '\n'; });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `transactions_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden'; document.body.appendChild(link); link.click();
                document.body.removeChild(link); URL.revokeObjectURL(url);
                showMessage('Dữ liệu đã được xuất ra CSV!', 'success');
            } else { showMessage('Trình duyệt của bạn không hỗ trợ tải file trực tiếp.', 'error'); }
        }

        function exportData() {
            const dataToExport = { transactions, incomeCategories, expenseCategories, accounts };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = `financial_data_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showMessage('Dữ liệu đã được xuất!', 'success');
        }

        function handleImportFile(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.transactions && importedData.incomeCategories && importedData.expenseCategories && importedData.accounts) {
                        if (!confirm('Nhập dữ liệu sẽ ghi đè toàn bộ dữ liệu hiện tại. Bạn có chắc chắn muốn tiếp tục?')) { importFileInput.value = ''; return; }
                        transactions = importedData.transactions; incomeCategories = importedData.incomeCategories;
                        expenseCategories = importedData.expenseCategories; accounts = importedData.accounts;
                        saveTransactions(); saveUserPreferences(); initializeApp();
                        showMessage('Dữ liệu đã được nhập thành công!', 'success');
                    } else { showMessage('Lỗi: Định dạng file không hợp lệ.', 'error'); }
                } catch (error) { showMessage(`Lỗi khi nhập file: ${error.message}`, 'error'); console.error("Import error:", error); }
                finally { importFileInput.value = ''; }
            };
            reader.readAsText(file);
        }

		function initializeApp() {
			// ... (các mã khởi tạo khác) ...
			loadUserPreferences(); 
			formCurrencySelector.value = 'VND'; 
			setDefaultDateTime(); 
			setDefaultComparisonYear();
			document.getElementById('type-chi').checked = true;
			
			populateAccountDropdowns(); 
			toggleFormFields(); 
			renderCustomCategoryLists();
			
			populateMonthFilter(); // Quan trọng: gọi populateMonthFilter trước khi applyMainFilter
			applyMainFilter();     // Đảm bảo dòng này được gọi để cập nhật giao diện ban đầu

			populateComparisonWeekFilter(); 
			updateWeeklyComparisonDisplay();
			
			// ... (xử lý collapsible headers) ...
		}

        transactionForm.addEventListener('submit', handleTransactionSubmit);
        filterMonthSelect.addEventListener('change', filterTransactionsByMonth);
        typeRadioButtons.forEach(radio => radio.addEventListener('change', toggleFormFields));
        filterComparisonYearInput.addEventListener('change', () => { populateComparisonWeekFilter(); updateWeeklyComparisonDisplay(); });
        filterComparisonYearInput.addEventListener('input', populateComparisonWeekFilter);
        filterComparisonWeekSelect.addEventListener('change', updateWeeklyComparisonDisplay);
        exportButton.addEventListener('click', exportData);
        if (exportCsvButton) exportCsvButton.addEventListener('click', exportToCSV); // Gán sự kiện cho nút CSV
        importButton.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', handleImportFile);
        addIncomeCategoryButton.addEventListener('click', () => { if (addCategory(newIncomeCategoryNameInput.value, 'income')) newIncomeCategoryNameInput.value = ''; });
        addExpenseCategoryButton.addEventListener('click', () => { if (addCategory(newExpenseCategoryNameInput.value, 'expense')) newExpenseCategoryNameInput.value = ''; });

        initializeApp();
    </script>
</body>
</html>
