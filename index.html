<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω T√†i Ch√≠nh C√° Nh√¢n</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="T√†i Ch√≠nh">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    <meta name="msapplication-navbutton-color" content="#3b82f6">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-touch-fullscreen" content="yes">
    <link rel="apple-touch-icon" href="./LogoFinance.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./LogoFinance.png">
    <link rel="shortcut icon" href="./LogoFinance.png" type="image/png">
    <link rel="apple-touch-icon" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="57x57" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./LogoFinance.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./LogoFinance.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./LogoFinance.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./LogoFinance.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./LogoFinance.png">
    <link rel="shortcut icon" href="./LogoFinance.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">

    <style>
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-text-size-adjust: 100%;
                -webkit-touch-callout: none;
            }
            input, textarea, select {
                -webkit-user-select: text !important;
                user-select: text !important;
                -webkit-touch-callout: default !important;
            }
        }
    </style>
</head>
<body class="font-sans antialiased ...">

    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="darkModeToggleCheckbox">
            <input type="checkbox" id="darkModeToggleCheckbox">
            <div class="slider round">
                <span class="sun-icon">‚òÄÔ∏è</span>
                <span class="moon-icon">üåô</span>
            </div>
        </label>
    </div>

    <header class="app-header">
        <div class="header-content">
            <h1 class="header-title">
                <span class="header-icon">üí∞</span>
                Qu·∫£n L√Ω T√†i Ch√≠nh
            </h1>
            <div class="header-summary">
                <div class="summary-card income">
                    <span class="summary-label">Thu nh·∫≠p th√°ng</span>
                    <span class="summary-value" id="header-income">0 ‚Ç´</span>
                </div>
                <div class="summary-card expense">
                    <span class="summary-label">Chi ti√™u th√°ng</span>
                    <span class="summary-value" id="header-expense">0 ‚Ç´</span>
                </div>
                <div class="summary-card balance">
                    <span class="summary-label">S·ªë d∆∞</span>
                    <span class="summary-value" id="header-balance">0 ‚Ç´</span>
                </div>
            </div>
        </div>
    </header>
    <div id="message-box" class="message-box" style="display: none;"></div>

    <main class="main-container">
        <div class="tab-content-container">
            <section id="tab-transactions" class="tab-content active">
                <div class="quick-add-section">
                    <h2 class="section-title"><span class="section-icon">‚úèÔ∏è</span>Th√™m Giao D·ªãch Nhanh</h2>
                    <form id="transaction-form" class="transaction-form" novalidate>
                        <div class="form-row">
                            <label class="form-label">Lo·∫°i giao d·ªãch</label>
                            <div class="radio-group">
                                <label class="radio-option income-option">
                                    <input type="radio" name="type" value="Thu" required>
                                    <span class="radio-custom"></span>
                                    <span class="radio-text">Thu nh·∫≠p</span>
                                </label>
                                <label class="radio-option expense-option">
                                    <input type="radio" name="type" value="Chi" checked required>
                                    <span class="radio-custom"></span>
                                    <span class="radio-text">Chi ti√™u</span>
                                </label>
                                <label class="radio-option transfer-option">
                                    <input type="radio" name="type" value="Transfer" required>
                                    <span class="radio-custom"></span>
                                    <span class="radio-text">Chuy·ªÉn ti·ªÅn</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <label for="amount-input" class="form-label">S·ªë ti·ªÅn</label>
                            <div class="amount-input-group flex items-center bg-[var(--bg-tertiary)] rounded-2xl border border-[var(--border-color)] px-4 py-3 mt-1" style="min-height:58px;">
                                <input type="text"
                                    id="amount-input"
                                    class="amount-input flex-1 bg-transparent outline-none border-0 text-xl text-[var(--text-primary)] px-1"
                                    placeholder="Nh·∫≠p s·ªë ti·ªÅn"
                                    inputmode="decimal"
                                    autocomplete="off"
                                    autocorrect="off"
                                    autocapitalize="off"
                                    spellcheck="false"
                                    required
                                    data-virtual-keyboard="true"
                                    data-format-currency="true">
                                <select id="currency-selector" class="currency-selector bg-[var(--bg-secondary)] text-[var(--text-primary)] rounded-xl px-3 py-2 border border-[var(--border-color)]">
                                    <option value="VND">VNƒê</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" id="category-row">
                            <label for="category-select" class="form-label">H·∫°ng m·ª•c</label>
                            <select id="category-select" class="form-select" required>
                                <option value="">Ch·ªçn h·∫°ng m·ª•c...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="account-from" class="form-label" id="account-from-label">T√†i kho·∫£n</label>
                            <select id="account-from" class="form-select" required>
                                <option value="">Ch·ªçn t√†i kho·∫£n...</option>
                            </select>
                        </div>
                        <div class="form-row" id="to-account-row" style="display: none;">
                            <label for="account-to" class="form-label">ƒê·∫øn t√†i kho·∫£n</label>
                            <select id="account-to" class="form-select">
                                <option value="">Ch·ªçn t√†i kho·∫£n nh·∫≠n...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="description-input" class="form-label">M√¥ t·∫£</label>
                            <input type="text"
                                id="description-input"
                                class="form-input"
                                placeholder="M√¥ t·∫£ giao d·ªãch (t√πy ch·ªçn)"
                                autocomplete="off"
                                autocorrect="on"
                                autocapitalize="sentences"
                                list="description-suggestions">
                            <datalist id="description-suggestions"></datalist>
                        </div>
                        <div class="form-row">
                            <label for="datetime-input" class="form-label">Ng√†y & Gi·ªù</label>
                            <input type="datetime-local"
                                id="datetime-input"
                                class="form-input"
                                autocomplete="off"
                                required>
                        </div>
                        <div id="suggestion-area" class="suggestion-area" style="display: none;">
                            <div class="suggestion-content">
                                <span class="suggestion-text">
                                    G·ª£i √Ω: <strong id="suggestion-desc"></strong> - <strong id="suggestion-amount"></strong>
                                </span>
                                <div class="suggestion-actions">
                                    <button type="button" id="apply-suggestion" class="btn-suggestion apply">√Åp d·ª•ng</button>
                                    <button type="button" id="dismiss-suggestion" class="btn-suggestion dismiss">B·ªè qua</button>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn" id="submit-btn">
                            <span class="btn-icon">‚ûï</span>
                            <span class="btn-text">Th√™m Giao D·ªãch</span>
                        </button>
                        <div class="smart-reset-option" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.2s ease;">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="smart-reset-enabled" checked style="accent-color: var(--primary-color); width: 18px; height: 18px;">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm font-medium text-[var(--text-primary)]">üéØ Gi·ªØ h·∫°ng m·ª•c & t√†i kho·∫£n sau khi th√™m</span>
                                        <span class="text-xs text-[var(--text-muted)] cursor-help" title="Khi b·∫≠t, ch·ªâ reset s·ªë ti·ªÅn v√† m√¥ t·∫£ sau khi th√™m giao d·ªãch th√†nh c√¥ng">‚ÑπÔ∏è</span>
                                    </div>
                                    <p class="text-xs text-[var(--text-muted)] mt-1">
                                        Ti·ªán l·ª£i khi th√™m nhi·ªÅu giao d·ªãch c√πng lo·∫°i li√™n ti·∫øp
                                    </p>
                                </div>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="transaction-list-section">
                    <div class="section-header">
                        <h2 class="section-title"><span class="section-icon">üìã</span>Giao D·ªãch G·∫ßn ƒê√¢y</h2>
                        <div class="filter-controls">
                            <select id="filter-period" class="filter-select">
                                <option value="today">H√¥m nay</option>
                                <option value="week">Tu·∫ßn n√†y</option>
                                <option value="month" selected>Th√°ng n√†y</option>
                                <option value="all">T·∫•t c·∫£</option>
                            </select>
                            <input type="date" id="filter-date" class="filter-date">
                        </div>
                    </div>
                    <div class="transaction-list" id="transaction-list"></div>
                    <div id="no-transactions" class="no-data" style="display: none;">
                        <span class="no-data-icon">üìù</span>
                        <span class="no-data-text">Ch∆∞a c√≥ giao d·ªãch n√†o</span>
                    </div>
                </div>
            </section>

            <section id="tab-history" class="tab-content">
				<div class="transaction-calendar-section">
					<h3 class="subsection-title">üìÖ L·ªãch Giao D·ªãch</h3>
					
					<div class="calendar-container">
						<div class="calendar-header">
							<div class="month-navigation">
								<button class="nav-btn" id="prev-month-btn">‚Äπ</button>
								<div class="current-month" id="current-month-display">Th√°ng n√†y</div>
								<button class="nav-btn" id="next-month-btn">‚Ä∫</button>
							</div>
							
							<div class="month-summary-cards">
								<div class="summary-card income">
									<div class="summary-label">T·ªïng thu nh·∫≠p</div>
									<div class="summary-value" id="calendar-total-income">0 ‚Ç´</div>
								</div>
								<div class="summary-card expense">
									<div class="summary-label">T·ªïng ƒë√£ chi</div>
									<div class="summary-value" id="calendar-total-expense">0 ‚Ç´</div>
								</div>
							</div>
						</div>
						
						<div class="calendar-grid">
							<div class="calendar-weekdays">
								<div class="weekday">T2</div>
								<div class="weekday">T3</div>
								<div class="weekday">T4</div>
								<div class="weekday">T5</div>
								<div class="weekday">T6</div>
								<div class="weekday">T7</div>
								<div class="weekday">CN</div>
							</div>
							
							<div class="calendar-days-grid" id="calendar-days-grid">
								</div>
						</div>
					</div>
				</div>

				<div id="day-detail-modal" class="modal" style="display: none;">
					<div class="modal-content">
						<div class="modal-header">
							<h3 id="modal-day-title">Giao d·ªãch ng√†y</h3>
							<button class="modal-close" id="close-day-modal">&times;</button>
						</div>
						<div class="modal-body" id="modal-day-transactions">
							</div>
					</div>
				</div>
				<div class="tab-header">
                    <h2 class="tab-title">
                        <span class="tab-icon">üè¶</span>
                        L·ªãch S·ª≠ & ƒê·ªëi So√°t
                    </h2>
                </div>

                <div class="account-balances-section">
                    <h3 class="subsection-title">S·ªë D∆∞ T√†i Kho·∫£n</h3>
                    <div class="account-balance-grid" id="account-balance-grid">
                        </div>
                </div>

                <div class="reconciliation-section">
                    <h3 class="subsection-title">ƒê·ªëi So√°t T√†i Kho·∫£n</h3>
                    <div class="reconciliation-container">
                        <div class="reconciliation-scroll">
                            <table class="reconciliation-table" id="reconciliation-table">
                                <thead>
                                    <tr>
                                        <th class="sticky-col">M·ª•c / T√†i kho·∫£n</th>
                                        </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                        <div class="scroll-hint">‚Üê Vu·ªët ngang ƒë·ªÉ xem th√™m c·ªôt ‚Üí</div>
                    </div>
                </div>

                <div class="reconciliation-history-section">
                    <h3 class="subsection-title">L·ªãch S·ª≠ ƒê·ªëi So√°t</h3>
                    <div class="reconciliation-history" id="reconciliation-history">
                        </div>
                </div>
            </section>

            <section id="tab-statistics" class="tab-content">
				<div class="tab-header">
					<h2 class="tab-title">
						<span class="tab-icon">üìä</span>
						Th·ªëng K√™ & Bi·ªÉu ƒê·ªì
					</h2>
					<div class="filter-controls">
						<select id="stats-period" class="filter-select">
							<option value="week">Tu·∫ßn n√†y</option>
							<option value="month" selected>Th√°ng n√†y</option>
							<option value="quarter">Qu√Ω n√†y</option>
							<option value="year">NƒÉm n√†y</option>
							<option value="custom">T√πy ch·ªânh</option>
						</select>
					</div>
				</div>
                <div class="stats-summary">
                    </div>

                <div class="chart-section">
                    <div class="chart-header">
                        <h3 class="chart-title">Chi Ti√™u Theo Danh M·ª•c</h3>
                        <div class="chart-controls">
                            <select id="chart-type" class="chart-type-selector">
                                <option value="doughnut">Bi·ªÉu ƒë·ªì tr√≤n</option>
                                <option value="bar">Bi·ªÉu ƒë·ªì c·ªôt</option>
                            </select>
                            <button id="export-expense-chart" class="action-btn-small export-btn" title="Xu·∫•t bi·ªÉu ƒë·ªì">üñºÔ∏è</button>
                        </div>
                    </div>
                    <div class="chart-container-wrapper">
                        <div class="chart-container" id="expense-chart-container" style="min-height: 300px;"> <canvas id="expense-chart"></canvas>
                        </div>
                        <div class="chart-legend" id="expense-legend">
                            </div>
                    </div>
                </div>

                <div class="chart-section">
                    <div class="chart-header">
                        <h3 class="chart-title">Lu·ªìng Ti·ªÅn (Thu Nh·∫≠p vs Chi Ti√™u H√†ng Th√°ng)</h3>
                        </div>
                    <div id="monthly-cashflow-container" class="chart-container" style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                        </div>
                </div>
                <div class="trend-section chart-section"> <div class="chart-header"> <h3 class="subsection-title chart-title">Xu H∆∞·ªõng 7 Ng√†y Qua</h3>
                         <button id="export-trend-chart" class="action-btn-small export-btn" title="Xu·∫•t bi·ªÉu ƒë·ªì">üñºÔ∏è</button>
                    </div>
                    <div class="trend-chart-container chart-container" id="trend-chart-container" style="min-height: 250px;"> <canvas id="trend-chart"></canvas>
                    </div>
                </div>

                <div class="comparison-section chart-section"> <div class="chart-header"> <h3 class="subsection-title chart-title">So S√°nh Th√°ng (Thu Nh·∫≠p & Chi Ti√™u)</h3>
                        <button id="export-comparison-chart" class="action-btn-small export-btn" title="Xu·∫•t bi·ªÉu ƒë·ªì">üñºÔ∏è</button>
                    </div>
                    <div class="comparison-chart-container chart-container" id="comparison-chart-container" style="min-height: 250px;"> <canvas id="comparison-chart"></canvas>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title subsection-title">
                        <span class="settings-icon">üéØ</span>
                        Theo D√µi Ng√¢n S√°ch
                    </h3>
                    <div id="budget-tracking-container" class="budget-progress-grid" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                        </div>
                </div>
                <div class="detailed-stats-section">
                    </div>
            </section>

            <section id="tab-categories" class="tab-content">
                <div class="tab-header">
                    <h2 class="tab-title">
                        <span class="tab-icon">üè∑Ô∏è</span>
                        Qu·∫£n L√Ω Danh M·ª•c
                    </h2>
                </div>

                <div class="category-section">
                    <h3 class="category-section-title">
                        <span class="category-icon income">üí∞</span>
                        Danh M·ª•c Thu Nh·∫≠p
                    </h3>

                    <div class="add-category-form">
                        <div class="form-group">
                            <input type="text"
                                   id="new-income-category"
                                   class="category-input"
                                   placeholder="T√™n danh m·ª•c thu nh·∫≠p m·ªõi"
                                   autocomplete="off"
                                   autocorrect="on"
                                   autocapitalize="words">
                            <button id="add-income-category" class="add-category-btn">
                                <span class="btn-icon">‚ûï</span>
                                Th√™m
                            </button>
                        </div>
                        <div id="new-income-category-error" class="input-error-message" style="display: none;"></div>
                    </div>

                    <div class="category-list">
                        <ul id="income-category-list" class="category-items">
                            </ul>
                    </div>
                </div>

                <div class="category-section">
                    <h3 class="category-section-title">
                        <span class="category-icon expense">üí∏</span>
                        Danh M·ª•c Chi Ti√™u
                    </h3>

                    <div class="add-category-form">
                        <div class="form-group">
                            <input type="text"
                                   id="new-expense-category"
                                   class="category-input"
                                   placeholder="T√™n danh m·ª•c chi ti√™u m·ªõi"
                                   autocomplete="off"
                                   autocorrect="on"
                                   autocapitalize="words">
                            <button id="add-expense-category" class="add-category-btn">
                                <span class="btn-icon">‚ûï</span>
                                Th√™m
                            </button>
                        </div>
                        <div id="new-expense-category-error" class="input-error-message" style="display: none;"></div>
                    </div>

                    <div class="category-list">
                        <ul id="expense-category-list" class="category-items">
                            </ul>
                    </div>
                </div>

                <div class="category-section">
                    <h3 class="category-section-title">
                        <span class="category-icon account">üè¶</span>
                        T√†i Kho·∫£n
                    </h3>

                    <div class="add-category-form">
                        <div class="form-group">
                            <input type="text"
                                   id="new-account"
                                   class="category-input"
                                   placeholder="T√™n t√†i kho·∫£n m·ªõi"
                                   autocomplete="off"
                                   autocorrect="on"
                                   autocapitalize="words">
                            <button id="add-account" class="add-category-btn">
                                <span class="btn-icon">‚ûï</span>
                                Th√™m
                            </button>
                        </div>
                        <div id="new-account-error" class="input-error-message" style="display: none;"></div>
                    </div>

                    <div class="category-list">
                        <ul id="account-list" class="category-items">
                            </ul>
                    </div>
                </div>
            </section>

            <section id="tab-settings" class="tab-content">
                <div class="tab-header">
                    <h2 class="tab-title">
                        <span class="tab-icon">‚öôÔ∏è</span>
                        C√†i ƒê·∫∑t & Backup
                    </h2>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">
                        <span class="settings-icon">üé®</span>
                        Giao Di·ªán
                    </h3>

					<div class="update-controls">
						<div class="info-item">
							<span class="info-label">Phi√™n b·∫£n hi·ªán t·∫°i</span>
							<span class="info-value" id="current-app-version">1.0.3</span>
						</div>

						<div class="info-item">
							<span class="info-label">Tr·∫°ng th√°i c·∫≠p nh·∫≠t</span>
							<span class="info-value" id="update-status">ƒêang ki·ªÉm tra...</span>
						</div>

						<div class="info-item">
							<span class="info-label">L·∫ßn ki·ªÉm tra cu·ªëi</span>
							<span class="info-value" id="last-update-check">Ch∆∞a ki·ªÉm tra</span>
						</div>

						<div class="update-actions">
							<button id="check-updates" class="action-btn import">
								<span class="btn-icon">üîç</span>
								<div class="btn-content">
									<span class="btn-title">Ki·ªÉm Tra C·∫≠p Nh·∫≠t</span>
									<span class="btn-subtitle">T√¨m phi√™n b·∫£n m·ªõi</span>
								</div>
							</button>

							<button id="force-refresh-app" class="action-btn export">
								<span class="btn-icon">üîÑ</span>
								<div class="btn-content">
									<span class="btn-title">L√†m M·ªõi ·ª®ng D·ª•ng</span>
									<span class="btn-subtitle">T·∫£i l·∫°i ho√†n to√†n t·ª´ server</span>
								</div>
							</button>

							<button id="clear-app-cache" class="action-btn danger" style="display: none;">
								<span class="btn-icon">üóëÔ∏è</span>
								<div class="btn-content">
									<span class="btn-title">X√≥a Cache ·ª®ng D·ª•ng</span>
									<span class="btn-subtitle">Ch·ªâ d√πng khi c√≥ l·ªói</span>
								</div>
							</button>
						</div>

						<div class="update-help" style="
							background: var(--bg-tertiary);
							border-radius: 8px;
							padding: 1rem;
							margin-top: 1rem;
							border-left: 4px solid var(--primary-color);
						">
							<div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5;">
								<strong>üí° H∆∞·ªõng d·∫´n c·∫≠p nh·∫≠t:</strong><br>
								‚Ä¢ <strong>Ki·ªÉm tra c·∫≠p nh·∫≠t:</strong> T√¨m phi√™n b·∫£n m·ªõi t·ª´ server<br>
								‚Ä¢ <strong>L√†m m·ªõi ·ª©ng d·ª•ng:</strong> T·∫£i l·∫°i to√†n b·ªô t·ª´ server (khuy·∫øn ngh·ªã)<br>
								‚Ä¢ <strong>Tr√™n iOS:</strong> N·∫øu ·ª©ng d·ª•ng kh√¥ng c·∫≠p nh·∫≠t, h√£y ƒë√≥ng ho√†n to√†n app v√† m·ªü l·∫°i
							</div>
						</div>
					</div>
				</div>
				<div class="theme-options">
				  <label class="theme-option">
					<input type="radio" name="theme" value="light" checked>
					<span class="theme-preview">üåû</span>
					<span class="theme-label">S√°ng</span>
				  </label>
				  <label class="theme-option">
					<input type="radio" name="theme" value="dark">
					<span class="theme-preview">üåô</span>
					<span class="theme-label">T·ªëi</span>
				  </label>
				  <label class="theme-option">
					<input type="radio" name="theme" value="auto">
					<span class="theme-preview">üîÑ</span>
					<span class="theme-label">T·ª± ƒë·ªông</span>
				  </label>
				</div>
                <div class="settings-section">
                    <h3 class="settings-section-title">
                        <span class="settings-icon">üíæ</span>
                        Qu·∫£n L√Ω D·ªØ Li·ªáu
                    </h3>

                    <div class="data-actions">
                        <button id="export-json" class="action-btn export">
                            <span class="btn-icon">üì•</span>
                            <div class="btn-content">
                                <span class="btn-title">Xu·∫•t JSON</span>
                                <span class="btn-subtitle">Backup to√†n b·ªô d·ªØ li·ªáu</span>
                            </div>
                        </button>

                        <button id="export-csv" class="action-btn export">
                            <span class="btn-icon">üìä</span>
                            <div class="btn-content">
                                <span class="btn-title">Xu·∫•t CSV</span>
                                <span class="btn-subtitle">D·ªØ li·ªáu giao d·ªãch</span>
                            </div>
                        </button>

                        <button id="import-data" class="action-btn import">
                            <span class="btn-icon">üì§</span>
                            <div class="btn-content">
                                <span class="btn-title">Nh·∫≠p D·ªØ Li·ªáu</span>
                                <span class="btn-subtitle">Kh√¥i ph·ª•c t·ª´ file JSON</span>
                            </div>
                        </button>

                        <input type="file" id="import-file" accept=".json" style="display: none;">
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">
                        <span class="settings-icon">üí±</span>
                        Ti·ªÅn T·ªá
                    </h3>

                    <div class="currency-settings">
                        <div class="setting-item">
                            <label class="setting-label">T·ª∑ gi√° USD/VNƒê</label>
                            <input type="tel"
                                   id="usd-rate"
                                   class="setting-input"
                                   value="25000"
                                   min="1000"
                                   max="50000"
                                   inputmode="numeric"
                                   pattern="[0-9]*"
                                   autocomplete="off">
                            <div id="usd-rate-error" class="input-error-message" style="display: none;"></div>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh</label>
                            <select id="default-currency" class="setting-select">
                                <option value="VND">Vi·ªát Nam ƒê·ªìng (‚Ç´)</option>
                                <option value="USD">US Dollar ($)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">
                        <span class="settings-icon">‚ÑπÔ∏è</span>
                        Th√¥ng Tin ·ª®ng D·ª•ng
                    </h3>

                    <div class="app-info">
                        <div class="info-item">
							<span class="info-label">Phi√™n b·∫£n</span>
							<span class="info-value" id="app-info-version">N/A</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">T·ªïng giao d·ªãch</span>
                            <span class="info-value" id="total-transactions">0</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">Dung l∆∞·ª£ng d·ªØ li·ªáu</span>
                            <span class="info-value" id="data-size">0 KB</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">L·∫ßn backup cu·ªëi</span>
                            <span class="info-value" id="last-backup">Ch∆∞a backup</span>
                        </div>
                    </div>
                </div>

                <div class="settings-section danger-section">
                    <h3 class="settings-section-title">
                        <span class="settings-icon">‚ö†Ô∏è</span>
                        V√πng Nguy Hi·ªÉm
                    </h3>

                    <div class="danger-actions">
                        <button id="clear-data" class="action-btn danger">
                            <span class="btn-icon">üóëÔ∏è</span>
                            <div class="btn-content">
                                <span class="btn-title">X√≥a To√†n B·ªô D·ªØ Li·ªáu</span>
                                <span class="btn-subtitle">Kh√¥ng th·ªÉ kh√¥i ph·ª•c</span>
                            </div>
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-item active" data-tab="transactions">
            <span class="nav-icon">üí≥</span>
            <span class="nav-label">Giao D·ªãch</span>
        </button>

        <button class="nav-item" data-tab="history">
            <span class="nav-icon">üè¶</span>
            <span class="nav-label">L·ªãch S·ª≠</span>
        </button>

        <button class="nav-item" data-tab="statistics">
            <span class="nav-icon">üìä</span>
            <span class="nav-label">Th·ªëng K√™</span>
        </button>

        <button class="nav-item" data-tab="categories">
            <span class="nav-icon">üè∑Ô∏è</span>
            <span class="nav-label">Danh M·ª•c</span>
        </button>

        <button class="nav-item" data-tab="settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">C√†i ƒê·∫∑t</span>
        </button>
    </nav>

    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <span class="loading-text">ƒêang t·∫£i...</span>
        </div>
    </div>
	<div id="virtualNumericKeyboard" class="virtual-keyboard">
	  <div class="virtual-keyboard-row">
		<button data-key="1">1</button>
		<button data-key="2">2</button>
		<button data-key="3">3</button>
	  </div>
	  <div class="virtual-keyboard-row">
		<button data-key="4">4</button>
		<button data-key="5">5</button>
		<button data-key="6">6</button>
	  </div>
	  <div class="virtual-keyboard-row">
		<button data-key="7">7</button>
		<button data-key="8">8</button>
		<button data-key="9">9</button>
	  </div>
	  <div class="virtual-keyboard-row">
		<button data-key="000">000</button>
		<button data-key="0">0</button>
		<button data-key="backspace">‚Üê</button>
	  </div>
	  <div class="virtual-keyboard-row">
		<button data-key="done">Done</button>
	  </div>
	</div>
    <script src="./js/version.js"></script>
    <script src="./js/utils.js"></script>
	<script src="./js/categories.js"></script>
	<script src="./js/settings.js"></script>
	<script src="./js/transactions.js"></script>
	<script src="./js/history.js"></script>
	<script src="./js/statistics.js"></script>
	<script src="./js/app.js"></script>
	<script src="js/virtual-keyboard.js"></script>

	<script>
	if (typeof Utils !== 'undefined' && Utils.UIUtils) {
		// Mapping icons cho c√°c danh m·ª•c ph·ªï bi·∫øn
		Utils.UIUtils.categoryIcons = {
			// ... (b·∫°n gi·ªØ nguy√™n ph·∫ßn icon c·ªßa b·∫°n ·ªü tr√™n ƒë√¢y) ...
			// Copy t·∫•t c·∫£ mapping icon nh∆∞ b·∫°n ƒë√£ khai b√°o
		};

		// H√†m l·∫•y icon cho danh m·ª•c
		Utils.UIUtils.getCategoryIcon = function(categoryName) {
			// ‚úÖ B·ªî SUNG: Ki·ªÉm tra v√† l·ªçc b·ªè undefined/null/empty values
			if (!categoryName || 
				typeof categoryName !== 'string' || 
				categoryName === 'undefined' || 
				categoryName === 'null' ||
				categoryName.toString().trim() === '') {
				return 'üì¶'; // Icon m·∫∑c ƒë·ªãnh cho c√°c gi√° tr·ªã kh√¥ng h·ª£p l·ªá
			}
			
			// L√†m s·∫°ch categoryName
			categoryName = String(categoryName).trim();
			
			// T√¨m ki·∫øm ch√≠nh x√°c tr∆∞·ªõc
			if (this.categoryIcons[categoryName]) {
				return this.categoryIcons[categoryName];
			}
			
			// T√¨m ki·∫øm kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
			const lowerCaseName = categoryName.toLowerCase();
			for (const [key, icon] of Object.entries(this.categoryIcons)) {
				if (key.toLowerCase() === lowerCaseName) {
					return icon;
				}
			}
			
			// T√¨m ki·∫øm t·ª´ kh√≥a ch·ª©a trong t√™n danh m·ª•c
			for (const [key, icon] of Object.entries(this.categoryIcons)) {
				if (lowerCaseName.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerCaseName)) {
					return icon;
				}
			}
			
			// Icon m·∫∑c ƒë·ªãnh d·ª±a tr√™n t·ª´ kh√≥a
			if (lowerCaseName.includes('ƒÉn') || lowerCaseName.includes('an') || lowerCaseName.includes('food')) {
				return 'üç¥';
			} else if (lowerCaseName.includes('xe') || lowerCaseName.includes('di') || lowerCaseName.includes('transport')) {
				return 'üöó';
			} else if (lowerCaseName.includes('mua') || lowerCaseName.includes('shop')) {
				return 'üõí';
			} else if (lowerCaseName.includes('nh√†') || lowerCaseName.includes('nha') || lowerCaseName.includes('house')) {
				return 'üè†';
			} else if (lowerCaseName.includes('y t·∫ø') || lowerCaseName.includes('y te') || lowerCaseName.includes('health')) {
				return 'üè•';
			} else if (lowerCaseName.includes('h·ªçc') || lowerCaseName.includes('hoc') || lowerCaseName.includes('education')) {
				return 'üìö';
			} else if (lowerCaseName.includes('l∆∞∆°ng') || lowerCaseName.includes('luong') || lowerCaseName.includes('salary')) {
				return 'üí∞';
			} else if (lowerCaseName.includes('ng√¢n h√†ng') || lowerCaseName.includes('ngan hang') || lowerCaseName.includes('bank')) {
				return 'üè¶';
			}
			
			return 'üì¶'; // Icon m·∫∑c ƒë·ªãnh cu·ªëi c√πng
		};
		Utils.UIUtils.normalizeCategoryName = function(categoryName) {
			if (!categoryName || 
				typeof categoryName !== 'string' || 
				categoryName === 'undefined' || 
				categoryName === 'null' ||
				categoryName.toString().trim() === '') {
				return 'Kh√¥ng ph√¢n lo·∫°i';
			}
			
			return String(categoryName).trim();
		};

		// ‚úÖ THAY TH·∫æ ƒëo·∫°n Utils.UIUtils.getCategoryColor ƒë·ªÉ x·ª≠ l√Ω undefined
		Utils.UIUtils.getCategoryColor = function(categoryName, index = 0) {
			// ‚úÖ B·ªî SUNG: Normalize categoryName tr∆∞·ªõc
			categoryName = this.normalizeCategoryName(categoryName);
			
			// Hash function ƒë·ªÉ t·∫°o m√†u consistent cho m·ªói t√™n danh m·ª•c
			let hash = 0;
			if (categoryName && typeof categoryName === 'string') {
				for (let i = 0; i < categoryName.length; i++) {
					const char = categoryName.charCodeAt(i);
					hash = ((hash << 5) - hash) + char;
					hash = hash & hash; // Convert to 32bit integer
				}
			}
			const colorIndex = Math.abs(hash + index) % this.categoryColors.length;
			return this.categoryColors[colorIndex];
		};

		// ‚úÖ B·ªî SUNG: Th√™m h√†m ƒë·ªÉ clean transaction data globally
		if (!Utils.DataUtils) {
			Utils.DataUtils = {};
		}

		Utils.DataUtils.cleanTransactionData = function(transactions) {
			if (!Array.isArray(transactions)) return [];
			
			return transactions.map(tx => {
				if (!tx) return tx;
				
				// L√†m s·∫°ch category
				if (tx.category !== undefined) {
					tx.category = Utils.UIUtils.normalizeCategoryName(tx.category);
				}
				
				return tx;
			}).filter(tx => tx); // L·ªçc b·ªè c√°c transaction null/undefined
		};
		// H√†m l·∫•y m√†u cho danh m·ª•c (n·∫øu ch∆∞a c√≥)
		if (!Utils.UIUtils.getCategoryColor) {
			// ‚úÖ IMPROVED: B·ªô m√†u ƒëa d·∫°ng v√† d·ªÖ ph√¢n bi·ªát h∆°n
			Utils.UIUtils.categoryColors = [
				'#FF6B6B', // ƒê·ªè coral
				'#4ECDC4', // Xanh mint  
				'#45B7D1', // Xanh d∆∞∆°ng
				'#96CEB4', // Xanh l√° nh·∫°t
				'#FFEAA7', // V√†ng nh·∫°t
				'#DDA0DD', // T√≠m nh·∫°t
				'#98D8C8', // Xanh ng·ªçc
				'#F7DC6F', // V√†ng gold
				'#BB8FCE', // T√≠m lavender
				'#85C1E9', // Xanh sky
				'#F8C471', // Cam nh·∫°t
				'#82E0AA', // Xanh l√° mint
				'#F1948A', // H·ªìng salmon
				'#85C1E9', // Xanh aqua
				'#D7BDE2', // T√≠m orchid
				'#A3E4D7', // Xanh seafoam
				'#F9E79F', // V√†ng banana
				'#AED6F1', // Xanh baby blue
				'#FADBD8', // H·ªìng misty
				'#D5F4E6'  // Xanh honeydew
			];

			Utils.UIUtils.getCategoryColor = function(categoryName, index = 0) {
				// ‚úÖ FIX: ƒê·∫£m b·∫£o m·ªói category c√≥ m√†u ri√™ng bi·ªát
				if (!categoryName || typeof categoryName !== 'string') {
					return this.categoryColors[index % this.categoryColors.length];
				}

				// ‚úÖ IMPROVED: T·∫°o hash t·ª´ t√™n category ƒë·ªÉ ƒë·∫£m b·∫£o consistent color
				let hash = 0;
				const cleanName = categoryName.toString().trim();
				
				for (let i = 0; i < cleanName.length; i++) {
					const char = cleanName.charCodeAt(i);
					hash = ((hash << 5) - hash) + char;
					hash = hash & hash; // Convert to 32bit integer
				}
				
				// ‚úÖ FIX: K·∫øt h·ª£p hash v√† index ƒë·ªÉ tr√°nh tr√πng m√†u
				const colorIndex = Math.abs(hash + index * 7) % this.categoryColors.length;
				return this.categoryColors[colorIndex];
			};
		}

		// H√†m hex to rgba n·∫øu ch∆∞a c√≥
		if (!Utils.UIUtils.hexToRgba) {
			Utils.UIUtils.hexToRgba = function(hex, alpha = 1) {
				const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				if (result) {
					const r = parseInt(result[1], 16);
					const g = parseInt(result[2], 16);
					const b = parseInt(result[3], 16);
					return `rgba(${r}, ${g}, ${b}, ${alpha})`;
				}
				return hex; // Tr·∫£ v·ªÅ hex g·ªëc n·∫øu kh√¥ng parse ƒë∆∞·ª£c
			};
		}
	}

	// ‚úÖ ENHANCED: iOS Keyboard Fixes
	document.addEventListener('DOMContentLoaded', function() {
		// Get all input elements
		const inputs = document.querySelectorAll('input[type="text"], input[type="tel"], input[type="number"], input[inputmode="numeric"], input[inputmode="decimal"], textarea');
		
		inputs.forEach(input => {
			// Add touchstart event to ensure keyboard shows
			input.addEventListener('touchstart', function(e) {
				e.stopPropagation();
			});
			
			// Focus event enhancement
			input.addEventListener('focus', function(e) {
				// Ensure the input is actually focused
				setTimeout(() => {
					if (document.activeElement !== this) {
						this.focus();
					}
				}, 100);
			});
		});
		
		// Special handling for amount input
		const amountInput = document.getElementById('amount-input');
		if (amountInput) {
			amountInput.addEventListener('click', function() {
				this.focus();
				// Only select all if not using virtual keyboard
				const virtualKeyboard = window.getVirtualKeyboard && window.getVirtualKeyboard();
				const isMobileDevice = virtualKeyboard && virtualKeyboard.isMobile && virtualKeyboard.isMobile();
				
				if (!isMobileDevice) {
					this.select(); // Select all text for easy replacement on desktop
				}
			});
		}
});

	// ƒêƒÉng k√Ω Service Worker cho PWA (Offline & Cache)
	if ('serviceWorker' in navigator) {
		window.addEventListener('load', function() {
			navigator.serviceWorker.register('/sw.js')
				.then(function(registration) {
					console.log('Service Worker registered with scope:', registration.scope);
				})
				.catch(function(error) {
					console.log('Service Worker registration failed:', error);
				});
		});
	}
	</script>
	
	<style>
	/* iOS specific fixes */
	.ios-keyboard-open {
	    padding-bottom: 0 !important;
	}
	
	@media screen and (max-device-width: 896px) and (-webkit-min-device-pixel-ratio: 2) {
	    /* iPhone specific styles */
	    input[type="text"],
	    input[type="tel"],
	    input[type="number"],
	    input[type="email"],
	    input[type="datetime-local"],
	    textarea,
	    select {
	        font-size: 16px !important;
	        -webkit-appearance: none !important;
	        border-radius: 8px !important;
	    }
	    
	    /* Fix for amount input */
	    .amount-input {
	        font-size: 18px !important;
	        -webkit-user-select: text !important;
	        user-select: text !important;
	    }
	}
	</style>
</body>
</html>